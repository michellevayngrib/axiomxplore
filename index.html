<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Axiom Xplore</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Work+Sans:wght@600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/@phosphor-icons/web@2.0.3/src/regular/style.css"></script>
  <link rel="stylesheet" type="text/css" href="https://unpkg.com/@phosphor-icons/web@2.0.3/src/regular/style.css">
  <link rel="stylesheet" type="text/css" href="https://unpkg.com/@phosphor-icons/web@2.0.3/src/fill/style.css">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --secondary: #8b5cf6;
      --accent-teal: #06b6d4;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #dbeafe 0%, #e0e7ff 25%, #ede9fe 50%, #fce7f3 75%, #fef3c7 100%);
      background-size: 200% 200%;
      animation: gradientShift 20s ease infinite;
      min-height: 100vh;
    }
    
    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    
    h1, h2, h3, h4, h5, h6 {
      font-family: 'Work Sans', 'Inter', sans-serif;
    }
    
    /*  Enhanced glassmorphism for all cards and UI elements */
    /* Top Navigation */
    .top-nav {
      background: transparent;
      border-bottom: 1px solid rgba(255, 255, 255, 0.3);
      padding: 0;
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      position: relative;
    }
    
    .nav-container {
      max-width: 1600px; /*  Expanded to fit all tabs on one line */
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px 40px;
    }
    
    .nav-logo {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 20px 0;
      cursor: pointer;
      text-decoration: none;
      color: inherit;
      position: absolute;
      left: 20px;
      top: 50%;
      transform: translateY(-50%);
      z-index: 101;
    }
    
    .nav-logo-text {
      font-size: 1.1em;
      font-weight: 700;
      color: rgba(55, 65, 81, 0.85); /*  Lighter text color */
    }
    
    .nav-tabs {
      display: flex;
      gap: 6px;
      flex-wrap: nowrap;
      align-items: center;
      flex-shrink: 0;
      justify-content: center;
    }
    
    .nav-tab {
      padding: 10px 18px;
      background: transparent;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.95em;
      color: rgba(107, 114, 128, 0.8); /*  Lighter text color */
      transition: all 0.2s ease;
      font-weight: 500;
      font-family: 'Inter', sans-serif;
    }
    
    .nav-tab:hover {
      background: rgba(255, 255, 255, 0.5);
      color: rgba(55, 65, 81, 0.9);
    }
    
    .nav-tab.active {
      background: rgba(255, 255, 255, 0.7);
      color: rgba(31, 41, 55, 0.9);
      font-weight: 600;
    }
    
    .nav-tab-submit-lead {
      padding: 10px 18px;
      background: rgba(99, 102, 241, 0.15);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.95em;
      color: rgba(99, 102, 241, 0.95);
      transition: all 0.2s ease;
      font-weight: 600;
      font-family: 'Inter', sans-serif;
      white-space: nowrap;
    }
    
    .nav-tab-submit-lead:hover {
      background: rgba(255, 255, 255, 0.5);
      color: rgba(55, 65, 81, 0.9);
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(88, 80, 196, 0.2);
    }
    
    /*  Transparent outline icons */
    .ph, .ph-fill {
      color: transparent;
      -webkit-text-stroke: 2px currentColor;
      -webkit-text-fill-color: transparent;
    }
    
    /* Main Content */
    .main-content {
      max-width: 1200px; /*  Reduced from 1400px */
      margin: 0 auto;
      padding: 40px 20px; 
    }
    
    /* Page Sections */
    .page-section {
      display: none;
      animation: fadeIn 0.4s ease;
    }
    
    .page-section.active {
      display: block;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Home Page */
    .home-page {
      text-align: center;
      min-height: auto;
      display: flex;
      flex-direction: column;
      padding: 60px 0;
    }
    
    .home-title {
      font-size: 3em;
      font-weight: 700;
      color: rgba(31, 41, 55, 0.85); /*  Lighter text */
      margin-bottom: 16px;
      letter-spacing: -0.5px;
    }
    
    .home-subtitle {
      font-size: 1.25em;
      color: rgba(107, 114, 128, 0.8); /*  Lighter text */
      margin-bottom: 60px;
    }
    
    .journey-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 45px;
      max-width: 1300px; /*  Reduced from 1200px for smaller cards */
      margin: 0 auto;
    }
    
    .journey-card {
      background: rgba(255, 255, 255, 0.35); /*  More translucent */
      backdrop-filter: blur(25px); /*  Stronger blur */
      -webkit-backdrop-filter: blur(25px);
      padding: 35px 25px; /*  Adjusted padding for smaller cards */
      border-radius: 24px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 1px solid rgba(255, 255, 255, 0.5);
      text-align: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05), inset 0 1px 0 rgba(255, 255, 255, 0.6); /*  Added inset shadow for depth */
      min-height: 260px; /*  Slightly reduced */
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
    }
    
    .journey-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 12px 28px rgba(0, 0, 0, 0.12), inset 0 1px 0 rgba(255, 255, 255, 0.8);
      background: rgba(255, 255, 255, 0.5);
    }
    
    .journey-icon {
      font-size: 4em;
      margin-bottom: 24px;
      height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .journey-icon i {
      font-size: 1em;
    }
    
    .journey-card:nth-child(1) .journey-icon i {
      color: #fbbf24;
      -webkit-text-stroke: 2px #fbbf24;
    }
    
    .journey-card:nth-child(2) .journey-icon i {
      color: #3b82f6;
      -webkit-text-stroke: 2px #3b82f6;
    }
    
    .journey-card:nth-child(3) .journey-icon i {
      color: #6366f1;
      -webkit-text-stroke: 2px #6366f1;
    }
    
    .journey-card:nth-child(4) .journey-icon i {
      color: #06b6d4;
      -webkit-text-stroke: 2px #06b6d4;
    }
    
    .journey-title {
      font-size: 1.35em;
      font-weight: 700;
      color: rgba(31, 41, 55, 0.85); /*  Lighter text */
      margin-bottom: 12px;
      line-height: 1.3;
    }
    
    .journey-description {
      color: rgba(107, 114, 128, 0.8); /*  Lighter text */
      line-height: 1.5;
      font-size: 1em;
    }
    
    /*  About Page - Complete redesign with sidebar navigation */
    .about-page-header {
      display: grid;
      grid-template-rows: auto 40px;
      margin-bottom: 5px;
    }

    .about-page-header .about-export-link {
      align-self: center;
    }

    .about-page-container {
      display: grid;
      grid-template-columns: 250px 1fr;
      gap: 20px;
      min-height: calc(100vh - 200px);
      position: relative;
    }
    
    .about-sidebar {
      position: sticky;
      top: 100px;
      min-height: calc(100vh - 200px);
      background: rgba(255, 255, 255, 0.35);
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      border-radius: 20px;
      padding: 30px 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05), inset 0 1px 0 rgba(255, 255, 255, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.5);
      display: flex;
      flex-direction: column;
    }
    
    .about-sidebar h3 {
      font-size: 1.1em;
      font-weight: 700;
      color: rgba(31, 41, 55, 0.85);
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid rgba(99, 102, 241, 0.2);
    }
    
    .brand-nav-item {
      padding: 12px 16px;
      margin-bottom: 8px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.9em;
      font-weight: 500;
      color: rgba(107, 114, 128, 0.8);
      background: transparent;
      border: none;
      width: 100%;
      text-align: left;
      font-family: 'Inter', sans-serif;
    }
    
    .brand-nav-item:hover {
      background: rgba(255, 255, 255, 0.5);
      color: rgba(55, 65, 81, 0.9);
    }
    
    .brand-nav-item.active {
      background: rgba(99, 102, 241, 0.15);
      color: rgba(99, 102, 241, 0.95);
      font-weight: 600;
    }
    
    .about-content-area {
      overflow-y: auto;
      max-height: calc(100vh - 200px);
      min-height: calc(100vh - 200px); /* Add this - ensures minimum height */
      padding-right: 10px;
      scroll-behavior: smooth;
      transition: opacity 0.2s ease, transform 0.2s ease;
      border-radius: 20px;
      display: flex; /* Add this */
      flex-direction: column; /* Add this */
    }
    
    .about-content-area::-webkit-scrollbar {
      width: 8px;
    }
    
    .about-content-area::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 10px;
    }
    
    .about-content-area::-webkit-scrollbar-thumb {
      background: rgba(99, 102, 241, 0.3);
      border-radius: 10px;
    }
    
    .about-content-area::-webkit-scrollbar-thumb:hover {
      background: rgba(99, 102, 241, 0.5);
    }
    
    .brand-section {
      background: rgba(255, 255, 255, 0.35);
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      padding: 40px;
      border-radius: 24px;
      margin-bottom: 30px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05), inset 0 1px 0 rgba(255, 255, 255, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.5);
      scroll-margin-top: 20px;
      transition: all 0.3s ease;
      position: relative;
      z-index: 1;
      flex: 1; /* Add this - allows it to expand */
      display: flex; /* Add this */
      flex-direction: column; /* Add this */
    }

    .brand-section:last-child {
      margin-bottom: 0;
    }
    
    .brand-section:hover {
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08), inset 0 1px 0 rgba(255, 255, 255, 0.7);
      background: rgba(255, 255, 255, 0.45);
    }
    
    .brand-section h2 {
      font-size: 2em;
      font-weight: 700;
      color: rgba(31, 41, 55, 0.85);
      margin-bottom: 20px;
      white-space: nowrap; /*  Keep brand names on one line */
    }
    
    .brand-section p {
      color: rgba(55, 65, 81, 0.8);
      line-height: 1.8;
      font-size: 1.05em;
      margin-bottom: 20px;
    }
    
    .brand-content-grid {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 30px;
      align-items: start;
    }
    
    /* Company page view styles */
    .company-page-view {
      animation: fadeIn 0.3s ease-in;
      flex: 1; /* Makes it expand to fill available space */
      display: flex; /* Add this */
      flex-direction: column; /* Add this */
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateX(20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    /* Team carousel styles */
    .team-carousel-container {
      position: relative;
      margin-top: 20px;
      overflow: visible;
      padding: 0 40px;
    }
    
    .team-carousel-wrapper {
      overflow: hidden;
      position: relative;
      width: 100%;
    }
    
    .team-carousel {
      display: flex;
      gap: 12px;
      transition: transform 0.4s ease;
      cursor: grab;
      user-select: none;
    }
    
    .team-carousel.dragging {
      cursor: grabbing;
      transition: none;
    }
    
    .team-member-card {
      background: rgba(255, 255, 255, 0.4);
      backdrop-filter: blur(10px);
      border-radius: 10px;
      padding: 14px 4px;
      text-align: center;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      border: 1px solid rgba(255, 255, 255, 0.3);
      flex: 0 0 calc(33.333% - 8px);
      min-width: 0;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      height: 100px;
      gap: 0px;
      padding-top: 20px;
    }
    
    .team-member-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
    }
    
    .team-member-name {
      font-size: 0.8em;
      font-weight: 600;
      color: rgba(31, 41, 55, 0.9);
      margin: 0;
      margin-bottom: 0px;
      line-height: 1.4;
    }
    
    .team-member-title {
      font-size: 0.8em !important;  /* ← ADD !important */
      color: rgba(107, 114, 128, 0.8);
      margin: 0;
      line-height: 1.4;
    }
    
    .team-member-email-btn {
      font-size: 0.75em;
      color: rgba(107, 114, 128, 0.8);
      background: transparent;
      border: none;
      padding: 4px 8px;
      margin-top: -2px;
      margin-left: auto;
      margin-right: auto;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
      transition: color 0.2s ease;
      font-family: inherit;
    }
    
    .team-member-email-btn svg {
      width: 12px;
      height: 12px;
      fill: currentColor;
      flex-shrink: 0;
    }
    
    .team-member-email-btn:hover {
      color: rgba(99, 102, 241, 0.8);
    }
    
    .team-member-email-btn.copied {
      color: rgba(34, 197, 94, 0.8);
      cursor: default;
    }
    
    /* Carousel navigation arrows */
    .carousel-nav-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255, 255, 255, 0.9);
      border: 2px solid rgba(229, 231, 235, 0.6);
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      z-index: 10;
      font-size: 1.2em;
      color: rgba(55, 65, 81, 0.8);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .carousel-nav-btn:hover {
      background: rgba(255, 255, 255, 1);
      border-color: rgba(99, 102, 241, 0.9);
      color: rgba(99, 102, 241, 0.9);
      transform: translateY(-50%) scale(1.1);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .carousel-nav-btn.prev {
      left: 0;
    }
    
    .carousel-nav-btn.next {
      right: 0;
    }
    
    .carousel-nav-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
      pointer-events: none;
      transform: translateY(-50%);
    }
    
    /* Pagination dots */
    .carousel-pagination {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 14px;
    }
    
    .carousel-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: rgba(229, 231, 235, 0.6);
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
      padding: 0;
    }
    
    .carousel-dot.active {
      background: rgba(99, 102, 241, 0.9);
      width: 24px;
      border-radius: 4px;
    }
    
    .carousel-dot:hover {
      background: rgba(99, 102, 241, 0.5);
    }
    
    /* Solutions carousel styles */
    .solutions-carousel-container {
      position: relative;
      margin-top: 20px;
      overflow: visible;
      padding: 0 40px;
    }
    
    .solutions-carousel-wrapper {
      overflow: hidden;
      position: relative;
      width: 100%;
    }
    
    .solutions-carousel {
      display: flex;
      gap: 12px;
      transition: transform 0.4s ease;
      cursor: grab;
      user-select: none;
    }
    
    .solutions-carousel.dragging {
      cursor: grabbing;
      transition: none;
    }
    
    .solution-item {
      background: rgba(255, 255, 255, 0.4);
      backdrop-filter: blur(10px);
      border-radius: 10px;
      padding: 14px 10px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      border: 1px solid rgba(255, 255, 255, 0.3);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      flex: 0 0 calc(33.333% - 8px);
      min-width: 0;
      gap: 8px;
      min-height: 100px;
    }
    
    .solution-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
    }
    
    .solution-info {
      flex: 1;
      margin-bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .solution-name {
      font-size: 0.9em;  /* ← CHANGE from 1em to 0.9em */
      font-weight: 600;
      color: rgba(31, 41, 55, 0.9);
      margin: 0;
      line-height: 1.3;
      text-align: center;
    }
    
    .solution-description {
      display: none;
    }
    
    .solution-link-btn {
      background: rgba(99, 102, 241, 0.1);
      color: rgba(99, 102, 241, 0.9);
      border: 1px solid rgba(99, 102, 241, 0.3);
      padding: 6px 12px;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
      font-family: 'Inter', sans-serif;
      font-size: 0.8em;
      width: 100%;
      text-align: center;
      margin-top: auto;
    }
    
    .solution-link-btn:hover {
      background: rgba(99, 102, 241, 0.2);
      border-color: rgba(99, 102, 241, 0.5);
    }
    
    /* Section spacing within single card */
    .company-section-divider {
      margin-top: 5px;
      padding-top: 5px;
      border-top: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .brand-text {
      flex: 1;
    }
    
    .brand-video {
      flex-shrink: 0;
      align-self: center;
      width: 100%;
    }
    
    .brand-video iframe {
      display: block;
      width: 100%;
      height: 225px;
      border: none;
      border-radius: 12px;
    }
    
    .video-embed {
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
      width: 100%;
    }
    
    .video-embed iframe {
      width: 100%;
      height: 225px;
      border: none;
    }
    
    .video-placeholder {
      background: linear-gradient(135deg, rgba(243, 232, 255, 0.4) 0%, rgba(233, 213, 255, 0.4) 100%);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border-radius: 16px;
      padding: 50px 30px;
      text-align: center;
      color: rgba(107, 114, 128, 0.8);
      border: 2px dashed rgba(139, 92, 246, 0.3);
      width: 100%;
      height: 225px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    
    .video-placeholder-icon {
      font-size: 3em;
      margin-bottom: 10px;
      color: #a78bfa;
      -webkit-text-stroke: 2px #a78bfa;
    }
    
    .video-placeholder p {
      font-size: 0.9em;
      font-weight: 600;
      color: rgba(107, 114, 128, 0.8);
      margin: 0;
    }

    /* Mobile navigation dropdown - hidden on desktop */
    .mobile-nav-dropdown {
      display: none;
    }

    /* Knowledge Base */
    .kb-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }
    
    .kb-title {
      font-size: 2.2em;
      font-weight: 700;
      color: rgba(31, 41, 55, 0.85); /*  Lighter text */
    }
    
    .view-toggle {
      display: flex;
      gap: 8px;
      background: rgba(255, 255, 255, 0.35); /*  More translucent */
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      padding: 6px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05), inset 0 1px 0 rgba(255, 255, 255, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.5);
    }
    
    .view-btn {
      padding: 10px 24px;
      border: none;
      background: transparent;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      color: rgba(107, 114, 128, 0.8); /*  Lighter text */
      transition: all 0.2s ease;
      font-family: 'Inter', sans-serif;
      font-size: 0.9em;
      white-space: nowrap;
    }
    
    .view-btn.active {
      background: rgba(255, 255, 255, 0.7);
      color: rgba(31, 41, 55, 0.9);
    }
    
    .kb-filters {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr 1fr;
      gap: 15px;
      margin-bottom: 20px;
      padding: 25px;
      background: rgba(255, 255, 255, 0.35); /*  More translucent */
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      border-radius: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05), inset 0 1px 0 rgba(255, 255, 255, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.5);
    }
    
    .filter-item label {
      display: block;
      font-weight: 600;
      color: rgba(55, 65, 81, 0.85); /*  Lighter text */
      font-size: 0.85em;
      margin-bottom: 8px;
    }
    
    .filter-item input,
    .filter-item select {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid rgba(229, 231, 235, 0.6);
      background: rgba(255, 255, 255, 0.6);
      border-radius: 10px;
      font-size: 0.9em;
      font-family: 'Inter', sans-serif;
      transition: all 0.2s ease;
      color: rgba(31, 41, 55, 0.85);
    }
    
    .filter-item input:focus,
    .filter-item select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
      background: rgba(255, 255, 255, 0.8);
    }
    
    .size-buttons {
      display: flex;
      gap: 8px;
    }
    
    .size-btn {
      flex: 1;
      padding: 12px;
      border: 2px solid rgba(229, 231, 235, 0.6);
      background: rgba(255, 255, 255, 0.6);
      border-radius: 10px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s ease;
      font-family: 'Inter', sans-serif;
      font-size: 0.9em;
      color: rgba(55, 65, 81, 0.8);
    }
    
    .size-btn:hover {
      border-color: var(--primary);
      background: rgba(255, 255, 255, 0.8);
    }
    
    .size-btn.active {
      background: rgba(255, 255, 255, 0.8);
      color: rgba(31, 41, 55, 0.9);
      border-color: var(--primary);
      font-weight: 600;
    }
    
    /*  Knowledge Base grid - 3 cards per row */
    .kb-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
    }
    
    /* Resources two-column layout - matching About Us style */
    .resources-container {
      display: grid;
      grid-template-columns: 250px 1fr;
      gap: 20px;
      min-height: calc(100vh - 200px);
      position: relative;
    }
    
    .resources-company-nav {
      position: sticky;
      top: 100px;
      min-height: calc(100vh - 200px);
      background: rgba(255, 255, 255, 0.35);
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      border-radius: 20px;
      padding: 30px 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05), inset 0 1px 0 rgba(255, 255, 255, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.5);
      display: flex;
      flex-direction: column;
    }
    
    .resources-company-nav h3 {
      font-size: 1.1em;
      font-weight: 700;
      color: rgba(31, 41, 55, 0.85);
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid rgba(99, 102, 241, 0.2);
    }
    
    .resources-company-nav-item {
      padding: 12px 16px;
      margin-bottom: 8px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.9em;
      font-weight: 500;
      color: rgba(107, 114, 128, 0.8);
      background: transparent;
      border: none;
      width: 100%;
      text-align: left;
      font-family: 'Inter', sans-serif;
    }
    
    .resources-company-nav-item:hover {
      background: rgba(255, 255, 255, 0.5);
      color: rgba(55, 65, 81, 0.9);
    }
    
    .resources-company-nav-item.active {
      background: rgba(99, 102, 241, 0.15);
      color: rgba(99, 102, 241, 0.95);
      font-weight: 600;
    }
    
    .resources-company-nav-item.no-resources {
      color: rgba(107, 114, 128, 0.5);
      font-weight: 400;
      opacity: 0.6;
    }
    
    .resources-company-nav-item.no-resources:hover {
      background: rgba(255, 255, 255, 0.3);
      color: rgba(107, 114, 128, 0.7);
      opacity: 0.8;
    }
    
    .resources-nav-divider {
      height: 1px;
      background: rgba(229, 231, 235, 0.4);
      margin: 12px 0;
      border: none;
    }
    
    .resources-content-panel {
      background: rgba(255, 255, 255, 0.35);
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.5);
      padding: 30px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05), inset 0 1px 0 rgba(255, 255, 255, 0.6);
      overflow-y: auto;
      max-height: calc(100vh - 200px);
      padding-right: 10px;
      scroll-behavior: smooth;
    }
    
    .resources-content-panel::-webkit-scrollbar {
      width: 8px;
    }
    
    .resources-content-panel::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 10px;
    }
    
    .resources-content-panel::-webkit-scrollbar-thumb {
      background: rgba(99, 102, 241, 0.3);
      border-radius: 10px;
    }
    
    .resources-content-panel::-webkit-scrollbar-thumb:hover {
      background: rgba(99, 102, 241, 0.5);
    }
    
    .resources-company-section {
      margin-bottom: 40px;
      scroll-margin-top: 120px;
    }
    
    .resources-company-section:last-child {
      margin-bottom: 0;
    }
    
    .resources-company-header {
      font-size: 1.3em;
      font-weight: 700;
      color: rgba(31, 41, 55, 0.85);
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid rgba(99, 102, 241, 0.2);
    }
    
    .resources-empty-message {
      padding: 40px 20px;
      text-align: center;
      color: rgba(107, 114, 128, 0.7);
      font-size: 0.95em;
      line-height: 1.6;
    }
    
    .resources-empty-message a {
      color: rgba(99, 102, 241, 0.8);
      text-decoration: none;
      font-weight: 500;
      border-bottom: 1px solid rgba(99, 102, 241, 0.3);
      transition: color 0.2s ease;
    }
    
    .resources-empty-message a:hover {
      color: rgba(99, 102, 241, 1);
      border-bottom-color: rgba(99, 102, 241, 0.6);
    }
    
    .resources-list {
      display: flex;
      flex-direction: column;
      gap: 0;
    }
    
    .resource-row {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 12px 0;
      border-bottom: 1px solid rgba(229, 231, 235, 0.3);
      transition: background 0.15s ease;
      text-decoration: none;
      color: inherit;
    }
    
    .resource-row:last-child {
      border-bottom: none;
    }
    
    .resource-row:hover {
      background: rgba(255, 255, 255, 0.3);
      padding-left: 8px;
      padding-right: 8px;
      margin-left: -8px;
      margin-right: -8px;
      border-radius: 8px;
    }
    
    .resource-icon {
      width: 32px;
      height: 32px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1em;
      color: rgba(99, 102, 241, 0.7);
      background: rgba(99, 102, 241, 0.08);
      border-radius: 6px;
    }
    
    .resource-title {
      flex: 1;
      font-size: 0.95em;
      font-weight: 500;
      color: rgba(31, 41, 55, 0.85);
      line-height: 1.4;
    }
    
    .resource-action {
      font-size: 0.85em;
      color: rgba(107, 114, 128, 0.7);
      font-weight: 500;
      flex-shrink: 0;
      transition: color 0.15s ease;
    }
    
    .resource-row:hover .resource-action {
      color: rgba(99, 102, 241, 0.8);
    }
    
    .resources-empty {
      text-align: center;
      padding: 60px 40px;
      color: rgba(107, 114, 128, 0.7);
      font-size: 0.95em;
    }
    
    /* Glossary styles - simple list */
    .glossary-search {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid rgba(229, 231, 235, 0.6);
      background: rgba(255, 255, 255, 0.6);
      border-radius: 10px;
      font-size: 0.9em;
      font-family: 'Inter', sans-serif;
      transition: all 0.2s ease;
      color: rgba(31, 41, 55, 0.85);
    }
    
    .glossary-search:focus {
      outline: none;
      border-color: var(--primary);
      background-color: rgba(255, 255, 255, 0.7);
    }
    
    .glossary-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .glossary-item {
      padding: 6px 0;
      border-bottom: 1px solid rgba(229, 231, 235, 0.4);
    }
    
    .glossary-item:last-child {
      border-bottom: none;
    }
    
    .glossary-line {
      font-size: 0.95em;
      color: rgba(31, 41, 55, 0.9);
    }
    
    .glossary-abbreviation {
      font-weight: 600;
      color: rgba(31, 41, 55, 0.9);
    }
    
    .glossary-separator {
      color: rgba(107, 114, 128, 0.7);
    }
    
    .glossary-full-name {
      font-weight: 500;
      color: rgba(31, 41, 55, 0.85);
    }
    
    .glossary-notes {
      margin-top: 4px;
      font-size: 0.9em;
      color: rgba(107, 114, 128, 0.8);
    }
    
    .glossary-empty {
      text-align: center;
      padding: 60px 40px;
      color: rgba(107, 114, 128, 0.7);
      font-size: 0.95em;
    }
    
    .glossary-no-results {
      text-align: center;
      padding: 40px 20px;
      color: rgba(107, 114, 128, 0.7);
      font-size: 1em;
    }
    
    /* Abbreviation Tooltip Styles - Subtle inline styling */
    .abbreviation-tooltip {
      text-decoration: underline dotted;
      text-underline-offset: 2px;
      cursor: pointer;
      color: inherit;
    }
    
    /* Portal-based tooltip container - rendered to document.body */
    .abbreviation-tooltip-portal {
      position: fixed;
      z-index: 999999;
      pointer-events: auto;
    }
    
    .abbreviation-tooltip-content {
      position: fixed;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(8px);
      color: rgba(31, 41, 55, 0.9);
      padding: 6px 8px;
      border-radius: 6px;
      font-size: 12px;
      line-height: 1.4;
      max-width: 280px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      border: 1px solid rgba(229, 231, 235, 0.3);
      word-wrap: break-word;
      pointer-events: auto;
    }
    
    .abbreviation-tooltip-full-name {
      font-weight: 600;
      margin-bottom: 2px;
      display: block;
      font-size: 12px;
    }
    
    .abbreviation-tooltip-notes {
      font-size: 11px;
      color: rgba(107, 114, 128, 0.7);
      margin-top: 4px;
      display: block;
    }
    
    /* Back to Brands button - small, transparent, left-aligned */
    .back-to-brands-btn {
      grid-column: 1/-1;
      margin-bottom: 0.5px;
      background: transparent !important;
      color: rgba(107, 114, 128, 0.8) !important;
      border: 1px solid rgba(229, 231, 235, 0.4) !important;
      padding: 8px 16px !important;
      font-size: 0.85em !important;
      width: auto !important;
      justify-self: start;
    }
    
    .back-to-brands-btn:hover {
      background: rgba(255, 255, 255, 0.3) !important;
      border-color: rgba(229, 231, 235, 0.6) !important;
    }
    
    /* Export to Slides link - plain text, no button styling */
    .export-to-slides-link {
      display: inline-block;
      background: transparent;
      color: rgba(107, 114, 128, 0.8);
      border: none;
      padding: 0;
      border-radius: 0;
      font-size: 0.85em;
      font-weight: 600;
      text-decoration: none;
      font-family: 'Inter', sans-serif;
      cursor: pointer;
      margin-left: 0;
    }
    
    .export-to-slides-link:hover {
      background: transparent;
      border: none;
      color: rgba(107, 114, 128, 0.8);
    }
    
    .brand-card,
    .product-card {
      background: rgba(255, 255, 255, 0.35); /*  More translucent */
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      border-radius: 20px;
      padding: 28px 24px;
      border: 1px solid rgba(255, 255, 255, 0.5);
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05), inset 0 1px 0 rgba(255, 255, 255, 0.6);
      min-height: 240px;
      display: flex;
      flex-direction: column;
      perspective: 1000px;
    }
    
    .product-card {
      position: relative;
      overflow: visible;
      height: auto;
    }
    
    .product-card-inner {
      position: relative;
      width: 100%;
      height: 100%;
      min-height: 240px;
      text-align: left;
      transition: transform 0.6s;
      transform-style: preserve-3d;
    }
    
    .product-card.flipped .product-card-inner {
      transform: rotateY(180deg);
    }
    
    .product-card-front,
    .product-card-back {
      position: absolute;
      width: 100%;
      height: 100%;
      min-height: 240px;
      backface-visibility: hidden;
      display: flex;
      flex-direction: column;
    }
    
    .product-card-back {
      transform: rotateY(180deg);
      overflow-y: auto;
    }
    
    .brand-card:hover,
    .product-card:hover {
      box-shadow: 0 12px 28px rgba(0, 0, 0, 0.12), inset 0 1px 0 rgba(255, 255, 255, 0.7);
      transform: translateY(-4px);
      background: rgba(255, 255, 255, 0.5);
    }
    
    .brand-header {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 18px;
    }
    
    .brand-icon {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.4em;
      flex-shrink: 0;
      font-weight: 700;
      color: white;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
      overflow: hidden;
    }
    
    .brand-icon img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }
    
    .brand-info h3 {
      font-size: 1.2em;
      font-weight: 700;
      color: rgba(31, 41, 55, 0.85); /*  Lighter text */
      margin-bottom: 4px;
    }
    
    .brand-location {
      font-size: 0.8em;
      color: rgba(107, 114, 128, 0.7); /*  Lighter text */
    }
    
    .brand-stats {
      display: flex;
      gap: 15px;
      margin-bottom: 14px;
      font-size: 0.85em;
    }
    
    .brand-stat strong {
      color: var(--primary);
      font-weight: 600;
    }
    
    .brand-highlight {
      color: rgba(107, 114, 128, 0.8); /*  Lighter text */
      font-size: 0.9em;
      margin-bottom: 18px;
      flex: 1;
      line-height: 1.5;
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }
    
    .brand-action {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.7);
      color: rgba(55, 65, 81, 0.85);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: 'Inter', sans-serif;
      font-size: 0.9em;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      margin-top: auto;
      border: 2px solid rgba(229, 231, 235, 0.6);
    }
    
    .brand-action:hover {
      background: rgba(255, 255, 255, 0.9);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .product-company {
      font-size: 0.7em;
      color: rgba(107, 114, 128, 0.7); /*  Lighter text */
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .product-name {
      font-size: 0.95em;
      font-weight: 700;
      color: rgba(31, 41, 55, 0.85); /*  Lighter text */
      margin-bottom: 6px;
      line-height: 1.1;
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }
    
    .product-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
      margin-bottom: 8px;
    }
    
    .product-badge {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.7em;
      font-weight: 600;
    }
    
    .badge-sme {
      background: rgba(219, 234, 254, 0.7);
      color: #1e40af;
    }
    
    .badge-enterprise {
      background: rgba(237, 233, 254, 0.7);
      color: #6d28d9;
    }
    
    .badge-both {
      background: rgba(209, 250, 229, 0.7);
      color: #065f46;
    }
    
    .badge-topic {
      background: rgba(243, 244, 246, 0.7);
      color: rgba(55, 65, 81, 0.85);
    }
    
    .detail-section {
      margin-bottom: 8px;
      font-size: 0.8em;
    }
    
    .detail-section h4 {
      font-size: 1em;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 6px;
    }
    
    .detail-section p,
    .detail-section ul {
      color: rgba(55, 65, 81, 0.8); /*  Lighter text */
      line-height: 1.3;
      font-size: 1em;
    }
    
    .detail-section ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .detail-section ul li {
      padding: 4px 0;
      padding-left: 18px;
      position: relative;
    }
    
    .detail-section ul li::before {
      content: "✓";
      position: absolute;
      left: 0;
      color: var(--success);
      font-weight: bold;
    }
    
    .industry-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    
    .industry-chip {
      padding: 4px 10px;
      background: rgba(243, 244, 246, 0.7);
      border-radius: 12px;
      font-size: 0.85em;
      color: rgba(55, 65, 81, 0.85);
    }
    
    .product-actions {
      display: flex;
      gap: 10px;
      margin-top: auto;
    }
    
    .product-btn {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 10px;
      font-size: 0.8em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: 'Inter', sans-serif;
    }
    
    .btn-primary {
      background: rgba(255, 255, 255, 0.7);
      color: rgba(55, 65, 81, 0.85);
      border: 2px solid rgba(229, 231, 235, 0.6);
    }
    
    .btn-secondary {
      background: rgba(243, 244, 246, 0.6);
      color: rgba(55, 65, 81, 0.85);
      border: 2px solid rgba(229, 231, 235, 0.4);
    }
    
    .btn-primary:hover,
    .btn-secondary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      background: rgba(255, 255, 255, 0.9);
    }
    
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
      animation: fadeIn 0.2s ease;
    }
    
    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal-content {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(30px);
      -webkit-backdrop-filter: blur(30px);
      border-radius: 24px;
      max-width: 800px;
      max-height: 90vh;
      width: 90%;
      overflow: hidden;
      box-shadow: 0 24px 48px rgba(0, 0, 0, 0.2);
      animation: slideUp 0.3s ease;
      border: 1px solid rgba(255, 255, 255, 0.6);
    }
    
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(50px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .modal-header {
      background: rgba(255, 255, 255, 0.35);
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      color: rgba(31, 41, 55, 0.85);
      padding: 30px;
      display: flex;
      align-items: start;
      gap: 15px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.5);
      border-radius: 20px 20px 0 0;
    }
    
    .modal-icon {
      width: 50px;
      height: 50px;
      background: rgba(255, 255, 255, 0.5);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5em;
      flex-shrink: 0;
      font-weight: 700;
    }
    
    .modal-title-section {
      flex: 1;
    }
    
    .modal-company {
      font-size: 0.9em;
      opacity: 0.9;
      margin-bottom: 5px;
    }
    
    .modal-title {
      font-size: 1.7em;
      font-weight: 700;
      margin-bottom: 5px;
    }
    
    .modal-subtitle {
      font-size: 1em;
      opacity: 0.9;
    }
    
    .modal-close {
      background: rgba(255, 255, 255, 0.5);
      border: none;
      color: rgba(31, 41, 55, 0.85);
      font-size: 1.5em;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }
    
    .modal-close:hover {
      background: rgba(255, 255, 255, 0.7);
    }
    
    .modal-body {
      padding: 30px;
      max-height: calc(90vh - 220px);
      overflow-y: auto;
    }
    
    .modal-badges {
      display: flex;
      gap: 10px;
      margin-bottom: 6px;
    }

    /* Jump to dropdown styling */
    .modal-jump-to {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23374151' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 14px center;
      background-size: 16px;
      padding-right: 40px;
      transition: all 0.2s ease;
    }

    .modal-jump-to:hover {
      border-color: var(--primary);
      background-color: rgba(255, 255, 255, 0.8);
    }

    .modal-jump-to:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
      background-color: rgba(255, 255, 255, 0.8);
    }

    .modal-jump-container {
      position: relative;
      display: flex;
      justify-content: flex-end;
      margin: 0 0 6px;
    }

    .modal-jump-btn {
      background: transparent;
      border: 1px solid rgba(229, 231, 235, 0.7);
      color: rgba(55, 65, 81, 0.75);
      font-size: 0.9em;
      font-family: 'Inter', sans-serif;
      padding: 6px 10px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .modal-jump-btn:hover {
      border-color: var(--primary);
      color: rgba(55, 65, 81, 0.9);
      background: rgba(255, 255, 255, 0.6);
    }

    .modal-jump-menu {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      min-width: 220px;
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid rgba(229, 231, 235, 0.8);
      border-radius: 12px;
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.12);
      padding: 8px;
      display: none;
      z-index: 5;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }

    .modal-jump-menu.show {
      display: block;
    }

    .modal-jump-item {
      width: 100%;
      text-align: left;
      background: transparent;
      border: none;
      color: rgba(55, 65, 81, 0.85);
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 0.9em;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .modal-jump-item:hover {
      background: rgba(99, 102, 241, 0.08);
      color: rgba(55, 65, 81, 0.95);
    }
    
    .modal-badge {
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.85em;
      font-weight: 600;
    }
    
    .modal-section {
      margin-bottom: 25px;
      padding: 24px;
      background: rgba(249, 250, 251, 0.5);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border-radius: 16px;
      position: relative;
      z-index: 1;
    }
    
    .modal-section h3 {
      color: var(--primary);
      margin-bottom: 12px;
      font-size: 1.15em;
      font-weight: 600;
    }
    
    .modal-section p {
      color: rgba(55, 65, 81, 0.85);
      line-height: 1.7;
      font-size: 0.95em;
    }
    
    .modal-section ul {
      list-style: disc;
      padding-left: 20px;
      margin: 0;
    }
    
    .modal-section ul li {
      padding: 4px 0;
      padding-left: 0;
      position: relative;
      color: rgba(55, 65, 81, 0.85);
      line-height: 1.6;
    }
    
    .modal-section ul li::before {
      content: none !important;
    }
    
    .cross-sell-company-link {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 12px;
      border: none;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.7);
      color: rgba(55, 65, 81, 0.85);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: 'Inter', sans-serif;
      font-size: 0.9em;
      text-decoration: none;
      border: 2px solid rgba(229, 231, 235, 0.6);
    }

    .cross-sell-company-link:hover {
      background: rgba(255, 255, 255, 0.9);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .cross-sell-company-link .company-name {
      font-size: 0.9em;
      font-weight: 600;
      color: rgba(55, 65, 81, 0.85);
    }
    
    /* Sub Tabs */
    .sub-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 35px;
      background: rgba(255, 255, 255, 0.35); /*  More translucent */
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      padding: 6px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05), inset 0 1px 0 rgba(255, 255, 255, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.5);
      justify-content: center;
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
    }
    
    .sub-tab {
      padding: 10px 24px;
      border: none;
      background: transparent;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      color: rgba(107, 114, 128, 0.8); /*  Lighter text */
      transition: all 0.2s ease;
      font-family: 'Inter', sans-serif;
      font-size: 0.9em;
    }
    
    .sub-tab.active {
      background: rgba(255, 255, 255, 0.7);
      color: rgba(31, 41, 55, 0.9);
    }
    
    .sub-content {
      display: none;
    }
    
    .sub-content.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }
    
    /* Wizard */
    .wizard-container {
      max-width: 900px;
      margin: 0 auto;
    }
    
    .wizard-progress {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      margin-bottom: 40px;
    }
    
    .progress-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }
    
    .progress-dot {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1.2em;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.5);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border: 3px solid rgba(229, 231, 235, 0.6);
      color: rgba(156, 163, 175, 0.8);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    
    .progress-dot.active {
      background: rgba(255, 255, 255, 0.8);
      color: rgba(31, 41, 55, 0.9);
      border-color: var(--primary);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
    }
    
    .progress-dot.inactive {
      background: rgba(255, 255, 255, 0.3);
      color: rgba(156, 163, 175, 0.6);
      border-color: rgba(229, 231, 235, 0.4);
    }
    
    .progress-dot.completed {
      background: var(--success);
      color: white;
      border-color: var(--success);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    
    .progress-line {
      width: 80px;
      height: 3px;
      background: rgba(229, 231, 235, 0.5);
      border-radius: 2px;
    }
    
    .progress-line.completed {
      background: var(--success);
    }
    
    .progress-label {
      font-size: 0.9em;
      color: rgba(107, 114, 128, 0.8); /*  Lighter text */
      text-align: center;
      font-weight: 500;
    }
    
    .wizard-page {
      display: none;
    }
    
    .wizard-page.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }
    
    .wizard-section {
      background: rgba(255, 255, 255, 0.35); /*  More translucent */
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      padding: 35px;
      border-radius: 24px;
      margin-bottom: 25px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05), inset 0 1px 0 rgba(255, 255, 255, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.5);
    }
    
    .wizard-section h3 {
      font-size: 1.6em;
      font-weight: 700;
      color: rgba(31, 41, 55, 0.85); /*  Lighter text */
      margin-bottom: 24px;
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 18px;
    }
    
    .form-group {
      margin-bottom: 18px;
    }
    
    .form-group.full-width {
      grid-column: 1 / -1;
    }
    
    .form-group label {
      display: block;
      font-weight: 600;
      color: rgba(55, 65, 81, 0.85); /*  Lighter text */
      margin-bottom: 8px;
      font-size: 0.95em;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid rgba(229, 231, 235, 0.6);
      background: rgba(255, 255, 255, 0.6);
      border-radius: 10px;
      font-size: 0.95em;
      font-family: 'Inter', sans-serif;
      transition: all 0.2s ease;
      color: rgba(31, 41, 55, 0.85);
    }
    
    .form-group textarea {
      resize: vertical;
      min-height: 90px;
    }
    
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
      background: rgba(255, 255, 255, 0.8);
    }
    
    .select-button {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid rgba(229, 231, 235, 0.6);
      background: rgba(255, 255, 255, 0.6);
      border-radius: 10px;
      text-align: left;
      cursor: pointer;
      font-size: 0.95em;
      color: rgba(107, 114, 128, 0.8);
      transition: all 0.2s ease;
      font-family: 'Inter', sans-serif;
    }
    
    .select-button:hover {
      border-color: var(--primary);
      background: rgba(255, 255, 255, 0.8);
    }
    
    .select-button.has-selection {
      color: rgba(31, 41, 55, 0.85);
      border-color: var(--primary);
      background: rgba(255, 255, 255, 0.8);
    }
    
    .selection-count {
      background: rgba(255, 255, 255, 0.8);
      color: rgba(55, 65, 81, 0.85);
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 0.85em;
      margin-left: 8px;
      font-weight: 600;
      border: 2px solid rgba(229, 231, 235, 0.6);
    }
    
    .situation-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 14px;
    }
    
    .situation-btn {
      padding: 16px 20px;
      border: 2px solid rgba(229, 231, 235, 0.6);
      background: rgba(255, 255, 255, 0.6);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 500;
      text-align: center;
      font-family: 'Inter', sans-serif;
      font-size: 0.9em;
      color: rgba(55, 65, 81, 0.85);
    }
    
    .situation-btn:hover {
      border-color: var(--primary);
      background: rgba(255, 255, 255, 0.8);
    }
    
    .situation-btn.active {
      background: rgba(255, 255, 255, 0.8);
      color: rgba(31, 41, 55, 0.9);
      border-color: var(--primary);
      font-weight: 600;
    }
    
    .wizard-actions {
      display: flex;
      justify-content: space-between;
      gap: 15px;
      margin-top: 25px;
    }
    
    .btn {
      padding: 14px 32px;
      border: none;
      border-radius: 12px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: 'Inter', sans-serif;
    }
    
    .btn-primary-action {
      background: rgba(255, 255, 255, 0.7);
      color: rgba(55, 65, 81, 0.85);
      flex: 1;
      border: 2px solid rgba(229, 231, 235, 0.6);
    }
    
    .btn-secondary-action {
      background: rgba(255, 255, 255, 0.5);
      color: rgba(55, 65, 81, 0.85);
      border: 2px solid rgba(229, 231, 235, 0.4);
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
      background: rgba(255, 255, 255, 0.9);
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    /* Selection Modals */
    .modal-search {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid rgba(229, 231, 235, 0.6);
      background: rgba(255, 255, 255, 0.6);
      border-radius: 10px;
      font-size: 0.95em;
      margin-bottom: 12px;
      font-family: 'Inter', sans-serif;
      transition: all 0.2s ease;
      color: rgba(31, 41, 55, 0.85);
    }
    
    .modal-search:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }
    
    .chip-group {
      margin-bottom: 28px;
    }
    
    .chip-group-title {
      font-weight: 600;
      color: rgba(55, 65, 81, 0.85);
      margin-bottom: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .chip-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .chip {
      padding: 10px 18px;
      border: 2px solid rgba(229, 231, 235, 0.6);
      background: rgba(255, 255, 255, 0.7);
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.9em;
      font-family: 'Inter', sans-serif;
      color: rgba(55, 65, 81, 0.85);
    }
    
    .chip:hover {
      border-color: var(--primary);
      background: rgba(255, 255, 255, 0.9);
    }
    
    .chip.selected {
      background: rgba(255, 255, 255, 0.9);
      color: rgba(31, 41, 55, 0.9);
      border-color: var(--primary);
      font-weight: 600;
    }
    
    .modal-actions {
      display: flex;
      gap: 12px;
      padding: 24px 30px;
      border-top: 1px solid rgba(229, 231, 235, 0.5);
      background: rgba(249, 250, 251, 0.4);
    }
    
    /*  Cross-Sell History - Toolbar and filters */
    .history-filters {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
      gap: 15px;
      margin-bottom: 30px;
      padding: 25px;
      background: rgba(255, 255, 255, 0.35);
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      border-radius: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05), inset 0 1px 0 rgba(255, 255, 255, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.5);
      max-width: 100%;
      box-sizing: border-box;
    }
    
    .history-filters .filter-item {
      min-width: 0;
    }
    
    .history-filters .filter-item input,
    .history-filters .filter-item select {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid rgba(229, 231, 235, 0.6);
      background: rgba(255, 255, 255, 0.6);
      border-radius: 10px;
      font-size: 0.9em;
      font-family: 'Inter', sans-serif;
      transition: all 0.2s ease;
      color: rgba(31, 41, 55, 0.85);
      box-sizing: border-box;
    }
    
    .history-filters .filter-item select {
      padding-right: 36px;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23374151' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 14px center;
      background-size: 16px;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      cursor: pointer;
    }
    
    .history-filters .filter-item input:focus,
    .history-filters .filter-item select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
      background-color: rgba(255, 255, 255, 0.8);
    }
    
    .history-filters .filter-item select:hover {
      border-color: rgba(229, 231, 235, 0.8);
      background-color: rgba(255, 255, 255, 0.7);
    }
    
    .history-filters .filter-item input::placeholder {
      color: rgba(107, 114, 128, 0.6);
    }
    
    .history-toolbar-divider {
      width: 100%;
      height: 1px;
      background: linear-gradient(to right, transparent, rgba(107, 114, 128, 0.15), transparent);
      margin-bottom: 35px;
    }
    
    .history-list {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }
    
    .history-row {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 24px;
    }
    
    .history-card {
      flex: 1;
      padding: 35px;
      background: rgba(255, 255, 255, 0.35);
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      border-radius: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05), inset 0 1px 0 rgba(255, 255, 255, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.5);
      transition: all 0.3s ease;
      position: relative;
    }
    
    .history-card:hover {
      box-shadow: 0 12px 28px rgba(0, 0, 0, 0.12), inset 0 1px 0 rgba(255, 255, 255, 0.7);
      transform: translateY(-4px);
      background: rgba(255, 255, 255, 0.5);
    }
    
    .history-product-content {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .history-arrow-between {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: auto;
      flex-shrink: 0;
      padding: 0 10px;
    }
    
    .history-arrow-icons {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .history-arrow-icon {
      font-size: 20px;
      color: rgba(107, 114, 128, 0.4);
    }
    
    .history-client-count {
      color: rgba(107, 114, 128, 0.6);
      font-style: italic;
      font-size: 1em;
      line-height: 1.7;
      white-space: nowrap;
    }
    
    .history-product-name {
      font-weight: 600;
      color: rgba(31, 41, 55, 0.85);
      font-size: 1.1em;
    }
    
    .history-company {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.85em;
      color: rgba(107, 114, 128, 0.7);
    }
    
    .history-company-logo {
      max-width: 20px;
      max-height: 20px;
      object-fit: contain;
      flex-shrink: 0;
    }
    
    .history-product-actions {
      margin-top: 8px;
    }
    
    .history-detail-btn {
      padding: 6px 14px;
      background: transparent;
      border: 1px solid rgba(229, 231, 235, 0.6);
      border-radius: 8px;
      font-size: 0.8em;
      font-weight: 600;
      color: rgba(55, 65, 81, 0.85);
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: 'Inter', sans-serif;
    }
    
    .history-detail-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      border-color: var(--primary);
      color: var(--primary);
    }
    
    
    /* Results */
    .results-container {
      margin-top: 35px;
    }
    
    .results-header {
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      color: white;
      padding: 45px;
      border-radius: 24px;
      margin-bottom: 35px;
      text-align: center;
      box-shadow: 0 8px 24px rgba(99, 102, 241, 0.2);
    }
    
    .results-header h3 {
      font-size: 2.4em;
      margin-bottom: 12px;
      font-weight: 700;
    }
    
    .opportunity-card {
      background: rgba(255, 255, 255, 0.35);
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      padding: 40px;
      border-radius: 24px;
      margin-bottom: 30px;
      border: 1px solid rgba(255, 255, 255, 0.5);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05), inset 0 1px 0 rgba(255, 255, 255, 0.6);
      transition: all 0.3s ease;
    }
    
    .opportunity-card:hover {
      box-shadow: 0 12px 28px rgba(0, 0, 0, 0.12), inset 0 1px 0 rgba(255, 255, 255, 0.7);
      transform: translateY(-4px);
      background: rgba(255, 255, 255, 0.5);
    }
    
    /* Loading */
    .loading {
      text-align: center;
      padding: 60px 20px;
    }
    
    .spinner {
      border: 4px solid rgba(229, 231, 235, 0.5);
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Opportunity Action Buttons */
    .opportunity-actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    
    .opportunity-btn {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-size: 0.9em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: 'Inter', sans-serif;
      background: rgba(255, 255, 255, 0.7);
      color: rgba(55, 65, 81, 0.85);
      border: 2px solid rgba(229, 231, 235, 0.6);
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .opportunity-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      background: rgba(255, 255, 255, 0.9);
    }
    
    /* Demo select dropdown styling */
    .demo-select {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      padding-right: 12px;
    }
    
    .demo-select:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      background: rgba(255, 255, 255, 0.9);
    }
    
    /* Demo Dropdown - FIXED Z-INDEX */
    .demo-dropdown {
      position: relative;
      display: inline-block;
      z-index: 10;
    }
    
    .demo-dropdown-btn {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-size: 0.9em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: 'Inter', sans-serif;
      background: rgba(255, 255, 255, 0.7);
      color: rgba(55, 65, 81, 0.85);
      border: 2px solid rgba(229, 231, 235, 0.6);
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .demo-dropdown-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      background: rgba(255, 255, 255, 0.9);
    }
    
    .demo-dropdown-content {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      margin-top: 8px;
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      min-width: 200px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
      border-radius: 12px;
      padding: 8px;
      z-index: 100000; /* INCREASED FROM 10000 */
      border: 2px solid rgba(229, 231, 235, 0.8);
    }
    
    .demo-dropdown.active .demo-dropdown-content {
      display: block;
    }
    
    .demo-dropdown-content a {
      display: block;
      padding: 12px 16px;
      color: rgba(55, 65, 81, 0.85);
      text-decoration: none;
      border-radius: 8px;
      transition: all 0.2s ease;
      font-weight: 600;
      font-size: 0.9em;
    }
    
    .demo-dropdown-content a:hover {
      background: rgba(99, 102, 241, 0.1);
      color: var(--primary);
    }
    
    /* Utilities */
    .hidden {
      display: none !important;
    }
    
    /* Responsive */
    @media (max-width: 1200px) {
      .journey-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .kb-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .resources-container {
        grid-template-columns: 200px 1fr;
        gap: 20px;
      }
      
      .resources-company-nav {
        top: 80px;
      }
      
      .about-page-container {
        grid-template-columns: 200px 1fr;
      }
    }
    
    @media (max-width: 768px) {
      /* Prevent horizontal scrolling on mobile */
      html, body {
        overflow-x: hidden;
        max-width: 100vw;
      }

      /* ========================================
         MOBILE NAVIGATION - Complete restructure
         ======================================== */
      .top-nav {
        padding: 5px 0;
      }

      .nav-logo {
        position: relative;
        left: 0;
        top: 0;
        transform: none;
        justify-content: center;
        width: 100%;
        padding: 5px 15px;
        gap: 8px;
      }

      .nav-logo img {
        height: 28px !important;
      }

      .nav-logo-text {
        font-size: 1em;
      }

      .nav-container {
        padding: 5px 15px;
        width: 100%;
      }

      .nav-tabs {
        flex-wrap: wrap;
        gap: 6px;
        padding: 5px 0;
        width: 100%;
        justify-content: center;
      }

      .nav-tab {
        padding: 8px 12px;
        font-size: 0.8em;
        white-space: nowrap;
        flex-shrink: 0;
      }

      .nav-tab-submit-lead {
        padding: 8px 12px;
        font-size: 0.8em;
        flex-shrink: 0;
      }
      
      .brand-content-grid {
        grid-template-columns: 1fr;
      }
      
      .carousel-nav-btn.prev {
        left: -10px;
      }
      
      .carousel-nav-btn.next {
        right: -10px;
      }
      
      .carousel-nav-btn {
        width: 32px;
        height: 32px;
        font-size: 1em;
      }
      
      .team-member-card,
      .solution-item {
        flex: 0 0 calc((100% - 40px) / 3);
      }
      
      .journey-grid,
      .kb-grid {
        grid-template-columns: 1fr;
      }
      
      .resources-container {
        grid-template-columns: 1fr;
        gap: 20px;
      }
      
      .resources-company-nav {
        position: relative;
        top: 0;
        min-height: auto;
      }
      
      .resources-content-panel {
        max-height: none;
      }
      
      .kb-filters {
        grid-template-columns: 1fr;
        padding: 20px;
      }

      /* ========================================
         MOBILE KNOWLEDGE BASE HEADER
         ======================================== */
      .kb-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
      }

      .kb-header > div:first-child {
        width: 100%;
      }

      .kb-title {
        font-size: 1.6em;
        margin-bottom: 5px;
      }

      .view-toggle {
        width: 100%;
        justify-content: center;
      }

      .view-btn {
        padding: 10px 16px;
        font-size: 0.85em;
        flex: 1;
        text-align: center;
      }

      .export-to-slides-link {
        font-size: 0.85em;
      }

      .history-filters {
        grid-template-columns: 1fr;
      }

      .form-grid,
      .situation-grid {
        grid-template-columns: 1fr;
      }
      
      .history-row {
        flex-direction: column;
        gap: 15px;
      }
      
      .history-arrow-between {
        flex-direction: column;
        gap: 6px;
        width: 100%;
        padding: 10px 0;
      }
      
      .history-arrow-icons {
        flex-direction: row;
        gap: 6px;
      }
      
      .history-arrow-icon {
        font-size: 18px;
      }
      
      /* ========================================
         MOBILE ABOUT US PAGE - Complete fix
         ======================================== */
      .about-page-header {
        grid-template-rows: auto auto;
        gap: 10px;
        margin-bottom: 20px;
      }

      .about-page-header h2 {
        font-size: 1.6em !important;
      }

      .about-page-container {
        display: block;
        min-height: auto;
        max-width: 100%;
        overflow-x: hidden;
      }

      /* Hide sidebar on mobile - replaced by dropdown */
      .about-sidebar {
        display: none;
      }

      /* Mobile dropdown navigation for About Us */
      .mobile-nav-dropdown {
        display: block;
        margin-bottom: 20px;
      }

      .mobile-nav-dropdown-btn {
        width: 100%;
        padding: 14px 16px;
        background: rgba(255, 255, 255, 0.5);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        border: 1px solid rgba(229, 231, 235, 0.6);
        border-radius: 12px;
        font-size: 0.95em;
        font-weight: 500;
        color: rgba(55, 65, 81, 0.85);
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-family: 'Inter', sans-serif;
        transition: all 0.2s ease;
      }

      .mobile-nav-dropdown-btn:hover {
        background: rgba(255, 255, 255, 0.7);
        border-color: var(--primary);
      }

      .mobile-nav-dropdown-btn .dropdown-arrow {
        transition: transform 0.2s ease;
      }

      .mobile-nav-dropdown-btn.open .dropdown-arrow {
        transform: rotate(180deg);
      }

      .mobile-nav-dropdown-menu {
        display: none;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        border: 1px solid rgba(229, 231, 235, 0.6);
        border-radius: 12px;
        margin-top: 8px;
        padding: 8px;
        max-height: 300px;
        overflow-y: auto;
        box-shadow: 0 10px 24px rgba(0, 0, 0, 0.12);
      }

      .mobile-nav-dropdown-menu.show {
        display: block;
      }

      .mobile-nav-dropdown-item {
        width: 100%;
        text-align: left;
        background: transparent;
        border: none;
        padding: 12px 14px;
        border-radius: 8px;
        font-size: 0.9em;
        font-weight: 500;
        color: rgba(55, 65, 81, 0.85);
        cursor: pointer;
        transition: all 0.15s ease;
        font-family: 'Inter', sans-serif;
      }

      .mobile-nav-dropdown-item:hover {
        background: rgba(99, 102, 241, 0.08);
      }

      .mobile-nav-dropdown-item.active {
        background: rgba(99, 102, 241, 0.15);
        color: rgba(99, 102, 241, 0.95);
        font-weight: 600;
      }

      .about-content-area {
        max-height: none;
        min-height: auto;
        overflow-y: visible;
        padding-right: 0;
        max-width: 100%;
      }

      .brand-section {
        padding: 25px 20px;
        margin-bottom: 20px;
        max-width: 100%;
        overflow-x: hidden;
      }

      .brand-section h2 {
        font-size: 1.4em;
        white-space: normal;
        word-wrap: break-word;
      }

      .brand-section h3 {
        font-size: 1.3em;
      }

      .brand-info-card {
        padding: 20px 15px;
      }

      .brand-content-grid {
        grid-template-columns: 1fr;
      }

      /* ========================================
         MOBILE RESOURCES PAGE
         ======================================== */
      .resources-container {
        display: block;
        max-width: 100%;
        overflow-x: hidden;
      }

      /* Hide sidebar on mobile - replaced by dropdown */
      .resources-company-nav {
        display: none;
      }

      .resources-content-panel {
        padding: 20px 15px;
        max-height: none;
        max-width: 100%;
      }

      /* ========================================
         MOBILE HOME PAGE - reduced spacing
         ======================================== */
      .home-page {
        padding: 15px 0;
      }

      .home-title {
        font-size: 1.8em;
        margin-bottom: 8px;
      }

      .home-subtitle {
        font-size: 1em;
        margin-bottom: 30px;
      }

      .journey-grid {
        gap: 15px;
      }

      .journey-card {
        padding: 25px 20px;
      }

      /* ========================================
         MOBILE GENERAL IMPROVEMENTS
         ======================================== */
      .main-content {
        padding: 20px 15px;
        max-width: 100%;
        overflow-x: hidden;
      }

      /* Standardize ALL section titles to 1.6em */
      .page-section h2,
      .wizard-container h2,
      .about-page-header h2,
      #navigatorSubTab h2,
      #historySubTab h2 {
        font-size: 1.6em !important;
      }

      /* Better touch targets */
      button, .nav-tab, .brand-nav-item, .view-btn, .size-btn {
        min-height: 44px;
      }

      /* Card improvements - smaller on mobile */
      .brand-card,
      .product-card {
        padding: 18px 14px;
        min-height: 200px;
        border-radius: 16px;
      }

      .product-card-inner {
        min-height: 200px;
      }

      .product-card-front,
      .product-card-back {
        min-height: 200px;
        padding: 18px 14px;
      }

      .brand-header {
        gap: 10px;
        margin-bottom: 12px;
      }

      .brand-icon {
        width: 40px;
        height: 40px;
        font-size: 1.1em;
        border-radius: 10px;
      }

      .brand-info h3 {
        font-size: 1em;
        margin-bottom: 2px;
      }

      .brand-location {
        font-size: 0.75em;
      }

      .brand-stats {
        font-size: 0.8em;
        gap: 10px;
        margin-bottom: 10px;
      }

      .brand-highlight {
        font-size: 0.85em;
        margin-bottom: 12px;
        -webkit-line-clamp: 2;
      }

      .brand-action {
        padding: 10px;
        font-size: 0.85em;
      }

      /* Cross-sell page improvements */
      .crosssell-header h2 {
        font-size: 1.6em;
      }

      /* Submit page improvements */
      .submit-header h2 {
        font-size: 1.6em;
      }

      .form-card {
        padding: 25px 20px;
      }

      /* Team member carousel on About page - show 2 items on mobile */
      .team-member-card,
      .solution-item {
        flex: 0 0 calc(50% - 10px);
        min-width: 140px;
      }

      /* Touch-responsive carousels */
      .team-carousel,
      .solutions-carousel {
        -webkit-overflow-scrolling: touch;
        scroll-snap-type: x mandatory;
        overflow-x: auto;
        scrollbar-width: none;
        -ms-overflow-style: none;
      }

      .team-carousel::-webkit-scrollbar,
      .solutions-carousel::-webkit-scrollbar {
        display: none;
      }

      .team-member-card,
      .solution-item {
        scroll-snap-align: start;
      }

      /* Hide carousel nav buttons on mobile - use touch scroll */
      .carousel-nav-btn {
        display: none;
      }

      /* About Us page - show all companies stacked on mobile */
      .about-mobile-all-companies {
        display: flex;
        flex-direction: column;
        gap: 30px;
      }

      .about-mobile-company-section {
        scroll-margin-top: 80px;
      }

      /* Cross-sell Finder - 2 column button layout */
      .opportunity-actions {
        display: grid !important;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }

      .opportunity-btn {
        padding: 10px 12px !important;
        font-size: 0.8em !important;
        justify-content: center;
        text-align: center;
      }

      .nav-tab-submit-lead {
        font-size: 0.8em !important;
        padding: 10px 12px !important;
      }

      /* Cross-sell History - keep products on one row */
      .history-row {
        flex-direction: row !important;
        align-items: stretch;
        gap: 10px;
      }

      .history-card {
        padding: 15px !important;
      }

      .history-product-name {
        font-size: 0.85em !important;
        word-wrap: break-word;
        overflow-wrap: break-word;
      }

      .history-arrow-between {
        flex-direction: column !important;
        width: auto !important;
        min-width: 40px;
        padding: 0 5px !important;
      }

      .history-arrow-icons {
        flex-direction: column !important;
      }

      .history-client-count {
        font-size: 0.75em !important;
        writing-mode: vertical-rl;
        text-orientation: mixed;
        white-space: nowrap;
      }

      .history-company {
        font-size: 0.75em !important;
      }

      .history-detail-btn {
        font-size: 0.75em !important;
        padding: 6px 10px !important;
      }

      /* Contacts - improved mobile layout */
      .contact-row-mobile {
        display: grid !important;
        grid-template-columns: 1fr auto;
        grid-template-rows: auto auto;
        gap: 4px 12px;
        padding: 16px !important;
      }

      .contact-name-mobile {
        font-size: 0.95em !important;
        grid-column: 1;
        grid-row: 1;
      }

      .contact-role-mobile {
        font-size: 0.85em !important;
        grid-column: 2;
        grid-row: 1;
        text-align: right;
      }

      .contact-email-mobile {
        grid-column: 1;
        grid-row: 2;
      }

      .contact-company-mobile {
        font-size: 0.85em !important;
        grid-column: 2;
        grid-row: 2;
        text-align: right;
      }

      /* Knowledge Base modal - centered buttons layout */
      .modal-badges {
        justify-content: center !important;
        gap: 8px !important;
      }

      .modal-badges .opportunity-btn,
      .modal-badges a.opportunity-btn {
        padding: 8px 14px !important;
        font-size: 0.8em !important;
      }

      .modal-jump-container {
        justify-content: center !important;
        margin-top: 8px;
      }

      .modal-jump-btn {
        font-size: 0.85em !important;
        padding: 8px 14px !important;
      }

      /* Modal improvements - reduced margins for more content space */
      .modal-content {
        width: 98%;
        max-width: 98%;
        margin: 5px;
        padding: 0;
        border-radius: 16px;
      }

      .modal-header {
        padding: 20px 15px;
        border-radius: 16px 16px 0 0;
      }

      .modal-body {
        padding: 15px;
        max-height: calc(90vh - 150px);
      }

      .modal-section {
        padding: 16px;
        margin-bottom: 15px;
        border-radius: 12px;
      }

      .modal-section h3 {
        font-size: 1em;
        margin-bottom: 8px;
      }

      .modal-section p,
      .modal-section ul li {
        font-size: 0.9em;
        line-height: 1.5;
      }

      .modal-title {
        font-size: 1.3em;
      }

      .modal-icon {
        width: 40px;
        height: 40px;
        font-size: 1.2em;
      }

      .modal-badges {
        gap: 6px;
        flex-wrap: wrap;
      }

      .modal-badge {
        padding: 6px 12px;
        font-size: 0.8em;
      }
    }

    /* ========================================
       EXTRA SMALL SCREENS (< 480px)
       ======================================== */
    @media (max-width: 480px) {
      .nav-logo-text {
        font-size: 0.9em;
      }

      .nav-tab {
        padding: 6px 8px;
        font-size: 0.75em;
      }

      .nav-tab-submit-lead {
        padding: 6px 8px;
        font-size: 0.75em;
      }

      /* Standardize ALL section titles on extra small screens */
      .page-section h2,
      .wizard-container h2,
      .about-page-header h2,
      #navigatorSubTab h2,
      #historySubTab h2,
      .kb-title {
        font-size: 1.4em !important;
      }

      .view-btn {
        padding: 8px 12px;
        font-size: 0.8em;
      }

      .home-title {
        font-size: 1.5em;
      }

      .brand-section {
        padding: 16px 12px;
      }

      .brand-section h2 {
        font-size: 1.2em !important;
      }

      .brand-section h3 {
        font-size: 1.1em;
      }

      .filter-item input,
      .filter-item select {
        padding: 10px 12px;
        font-size: 0.85em;
      }

      .size-btn {
        padding: 10px 8px;
        font-size: 0.85em;
      }

      .team-member-card,
      .solution-item {
        flex: 0 0 100%;
      }

      /* Mobile dropdown adjustments for extra small screens */
      .mobile-nav-dropdown-btn {
        padding: 12px 14px;
        font-size: 0.9em;
      }

      .mobile-nav-dropdown-item {
        padding: 10px 12px;
        font-size: 0.85em;
      }

      /* Product cards even smaller */
      .brand-card,
      .product-card {
        padding: 14px 12px;
        min-height: 180px;
      }

      .product-card-inner {
        min-height: 180px;
      }

      .product-card-front,
      .product-card-back {
        min-height: 180px;
        padding: 14px 12px;
      }

      .brand-icon {
        width: 35px;
        height: 35px;
        font-size: 1em;
      }

      .brand-info h3 {
        font-size: 0.95em;
      }

      /* Modal even tighter */
      .modal-body {
        padding: 12px;
      }

      .modal-section {
        padding: 14px;
        margin-bottom: 12px;
      }

      .modal-section h3 {
        font-size: 0.95em;
      }

      .modal-section p,
      .modal-section ul li {
        font-size: 0.85em;
      }
    }
  </style>
</head>
<body>
  <!-- Top Navigation -->
  <nav class="top-nav">
    <div class="nav-logo" onclick="showPage('home')">
      <img src="https://drive.google.com/thumbnail?id=1BUlur2VwNyG4OqeidcTbqvWryhnBx_q-&sz=w400" alt="Axiom" style="height: 35px; object-fit: contain;" onerror="this.style.display='none'">
      <div class="nav-logo-text">Axiom Xplore</div>
    </div>
    
    <div class="nav-container">
      <div class="nav-tabs">
        <button class="nav-tab active" data-page="home" onclick="showPage('home')">Home</button>
        <button class="nav-tab" data-page="knowledge" onclick="showPage('knowledge')">Knowledge Base</button>
        <button class="nav-tab" data-page="crosssell" onclick="showPage('crosssell')">Cross-Sell</button>
        <button class="nav-tab" data-page="resources" onclick="showPage('resources')">Resources</button>
        <button class="nav-tab" data-page="submit" onclick="showPage('submit')">Submit Update</button>
        <button class="nav-tab" data-page="about" onclick="showPage('about')">About us</button>
        <button class="nav-tab-submit-lead" onclick="openCrossSellLeadForm()">Submit a Cross-Sell Referral</button>
      </div>
    </div>
  </nav>
  
  <!-- Main Content -->
  <div class="main-content">
    
    <!-- HOME PAGE -->
    <div id="homePage" class="page-section active">
      <div class="home-page">
        <h1 class="home-title">What are you looking for?</h1>
        <p class="home-subtitle">Find what you need in the Axiom ecosystem.</p>
        
        <div class="journey-grid">
          <div class="journey-card" onclick="showPage('about')">
            <div class="journey-icon"><i class="ph-fill ph-lightbulb"></i></div>
            <h3 class="journey-title">I'm a new starter</h3>
            <p class="journey-description">Get to know us</p>
          </div>
          
          <div class="journey-card" onclick="showPage('knowledge')">
            <div class="journey-icon"><i class="ph-fill ph-book-open"></i></div>
            <h3 class="journey-title">I'm looking to learn more</h3>
            <p class="journey-description">Explore our product catalogue</p>
          </div>
          
          <div class="journey-card" onclick="showPage('crosssell')">
            <div class="journey-icon"><i class="ph-fill ph-handshake"></i></div>
            <h3 class="journey-title">Help me cross-sell</h3>
            <p class="journey-description">Discover opportunities for clients</p>
          </div>
          
          <div class="journey-card" onclick="showPage('resources')">
            <div class="journey-icon"><i class="ph-fill ph-book"></i></div>
            <h3 class="journey-title">Give me resources!</h3>
            <p class="journey-description">Access guides and documents</p>
          </div>
        </div>
      </div>
    </div>

    <!-- ABOUT PAGE -->
    <div id="aboutPage" class="page-section">
      <div class="about-page-header">
        <h2 style="font-size: 2.5em; font-weight: 700; color: rgba(31, 41, 55, 0.85); margin: 0;">Meet the Group!</h2>
        <a href="#" class="export-to-slides-link about-export-link" onclick="event.preventDefault(); openExportModal('about');">Export to Slides</a>
      </div>
      
      <!-- Mobile dropdown navigation - only visible on mobile -->
      <div class="mobile-nav-dropdown" id="aboutMobileDropdown">
        <button class="mobile-nav-dropdown-btn" onclick="toggleMobileDropdown('about')">
          <span id="aboutMobileDropdownLabel">Jump to company...</span>
          <span class="dropdown-arrow">▼</span>
        </button>
        <div class="mobile-nav-dropdown-menu" id="aboutMobileDropdownMenu">
          <!-- Will be populated dynamically -->
        </div>
      </div>

      <div class="about-page-container">
        <!-- Fixed Sidebar - Will be populated from database -->
        <div class="about-sidebar" id="aboutSidebar">
          <div style="padding: 20px; text-align: center; color: rgba(107, 114, 128, 0.7);">
            <div class="spinner" style="width: 30px; height: 30px; margin: 0 auto 10px;"></div>
            <p style="font-size: 0.9em;">Loading companies...</p>
          </div>
        </div>
        
        <!-- Scrolling Content Area - Will be populated from database -->
        <div class="about-content-area" id="aboutContentArea">
          <div style="padding: 60px 20px; text-align: center;">
            <div class="spinner" style="width: 50px; height: 50px; margin: 0 auto 20px;"></div>
            <p style="font-size: 1.1em; color: rgba(107, 114, 128, 0.7);">Loading company information from database...</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- KNOWLEDGE BASE PAGE -->
    <div id="knowledgePage" class="page-section">
      <div class="kb-header">
        <div style="width: 100%;">
          <h2 class="kb-title" style="margin-bottom: 12px;">Knowledge Base</h2>
          <a href="#" class="export-to-slides-link" onclick="event.preventDefault(); openExportModal('knowledge');">Export to Slides</a>
        </div>
        <div class="view-toggle">
          <button class="view-btn active" data-view="brand" onclick="switchView('brand')">By Company</button>
          <button class="view-btn" data-view="product" onclick="switchView('product')">By Product</button>
        </div>
      </div>
      
      <div class="kb-filters">
        <div class="filter-item">
          <label>Search Products</label>
          <input type="text" id="searchProducts" placeholder="Search by name or keyword..." oninput="applyFilters()">
        </div>
        
        <div class="filter-item">
          <label>Company</label>
          <select id="filterBrand" onchange="applyFilters()">
            <option value="">All Companies</option>
          </select>
        </div>
        
        <div class="filter-item">
          <label>Industry</label>
          <select id="filterIndustry" onchange="applyFilters()">
            <option value="">All Industries</option>
          </select>
        </div>
        
        <div class="filter-item">
          <label>Client Size</label>
          <div class="size-buttons">
            <button class="size-btn" data-size="SME" onclick="toggleSizeFilter('SME')">SME</button>
            <button class="size-btn" data-size="Enterprise" onclick="toggleSizeFilter('Enterprise')">Enterprise</button>
          </div>
        </div>
      </div>
      
      <div id="knowledgeContent">
        <!-- Remove the loading spinner - it will be shown only when tab is clicked and data isn't ready -->
      </div>
    </div>
    
    <!-- CROSS-SELL PAGE -->
    <div id="crosssellPage" class="page-section">
      <div class="sub-tabs">
        <button class="sub-tab active" onclick="showSubTab('navigator')">Cross-Sell Finder</button>
        <button class="sub-tab" onclick="showSubTab('history')">Cross-Sell History</button>
      </div>
      
      <!-- SMART NAVIGATOR SUB-TAB -->
      <div id="navigatorSubTab" class="sub-content active">
        <div class="wizard-container" style="margin-bottom: 24px;">
          <h2 style="font-size: 2em; font-weight: 700; color: rgba(31, 41, 55, 0.85); margin: 0 0 12px 0;">Cross-Sell Finder</h2>
          <a href="#" class="export-to-slides-link" onclick="event.preventDefault(); openExportModal('navigator');" style="display: inline-block;">Export to Slides</a>
        </div>
        <div class="wizard-container">
          <!-- Single Page Form -->
          <div id="wizardPage1" class="wizard-page active">
            <div class="wizard-section">
            
              
              <div class="form-group">
                <label>Company Size</label>
                <div class="size-buttons">
                  <button class="size-btn" data-size="SME" onclick="selectCompanySize('SME')">SME</button>
                  <button class="size-btn" data-size="Enterprise" onclick="selectCompanySize('Enterprise')">Enterprise</button>
                </div>
              </div>
              
              <div class="form-group">
                <label>Primary Industries</label>
                <button class="select-button" onclick="openIndustryModal()">
                  <span id="industryDisplay">Select industries...</span>
                </button>
              </div>
              
              <div class="form-group">
                <label>Current Products *</label>
                <button class="select-button" onclick="openProductModal()">
                  <span id="productDisplay">Select products...</span>
                </button>
              </div>
              
              <div class="form-group">
                <label>Current Situation</label>
                <div class="situation-grid">
                  <button class="situation-btn" data-situation="Renewal" onclick="selectSituation('Renewal')">Contract Renewal</button>
                  <button class="situation-btn" data-situation="Expansion" onclick="selectSituation('Expansion')">Business Expansion</button>
                  <button class="situation-btn" data-situation="Incident" onclick="selectSituation('Incident')">Recent Incident</button>
                  <button class="situation-btn" data-situation="Regular Check-in" onclick="selectSituation('Regular Check-in')">Regular Check-in</button>
                  <button class="situation-btn" data-situation="Audit" onclick="selectSituation('Audit')">Upcoming Audit</button>
                  <button class="situation-btn" data-situation="Regulation" onclick="selectSituation('Regulation')">New Regulation</button>
                </div>
              </div>
              
              <div style="background: rgba(219, 234, 254, 0.5); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); padding: 18px; border-radius: 14px; margin-top: 24px; border: 1px solid rgba(59, 130, 246, 0.2);">
                <strong style="color: #1e40af;">Current Products:</strong>
                <p id="currentProductsSummary" style="color: #1e3a8a; margin-top: 10px; font-size: 0.95em;">None selected</p>
              </div>
            </div>
            
            <div class="wizard-actions">
              <div></div>
              <button class="btn btn-primary-action" onclick="findOpportunities()">Find Opportunities</button>
            </div>
          </div>
          
          <!-- Results Section (shown below form) -->
          <div id="navigatorResults" style="margin-top: 40px;"></div>
        </div>
      </div>
      
      <!-- CROSS-SELL HISTORY SUB-TAB -->
      <div id="historySubTab" class="sub-content">
        <div class="history-filters">
          <div class="filter-item">
            <label>Search Products</label>
            <input type="text" id="historySearch" placeholder="Search by name or keyword..." oninput="filterHistoryList()">
          </div>
          
          <div class="filter-item">
            <label>Company</label>
            <select id="historyFilterBrand" onchange="filterHistoryList()">
              <option value="">All Companies</option>
            </select>
          </div>
          
          <div class="filter-item">
            <label>Industry</label>
            <select id="historyFilterIndustry" onchange="filterHistoryList()">
              <option value="">All Industries</option>
            </select>
          </div>
          
          <div class="filter-item">
            <label>Client Size</label>
            <select id="historyClientSize" onchange="filterHistoryList()">
              <option value="">All Sizes</option>
              <option value="SME">SME</option>
              <option value="Enterprise">Enterprise</option>
            </select>
          </div>
          
          <div class="filter-item">
            <label>Sort By</label>
            <select id="historySortBy" onchange="filterHistoryList()">
              <option value="clientcount-desc" selected data-display="Clients">Clients (high → low)</option>
              <option value="clientcount-asc">Clients (low → high)</option>
              <option value="productname-asc">Product Name: A-Z</option>
              <option value="productname-desc">Product Name: Z-A</option>
              <option value="companyname-asc">Company Name: A-Z</option>
              <option value="companyname-desc">Company Name: Z-A</option>
            </select>
          </div>
        </div>
        
        <div class="history-toolbar-divider"></div>
        
        <div class="history-list" id="historyList">
          <!-- Loading spinner will be shown when tab is clicked if data isn't ready -->
        </div>
      </div>
    </div>
    
    <!-- RESOURCES PAGE -->
    <div id="resourcesPage" class="page-section">
      <div class="sub-tabs">
        <button class="sub-tab active" onclick="showResourceTab('library')">Resources</button>
        <button class="sub-tab" onclick="showResourceTab('contacts')">Contacts</button>
        <button class="sub-tab" onclick="showResourceTab('glossary')">Axiom Glossary</button>
      </div>
      
      <!-- Resource Library -->
      <div id="libraryTab" class="sub-content active">
        <h2 class="kb-title" style="margin-bottom: 20px;">Resources</h2>

        <!-- Mobile dropdown navigation - only visible on mobile -->
        <div class="mobile-nav-dropdown" id="resourcesMobileDropdown">
          <button class="mobile-nav-dropdown-btn" onclick="toggleMobileDropdown('resources')">
            <span id="resourcesMobileDropdownLabel">Jump to company...</span>
            <span class="dropdown-arrow">▼</span>
          </button>
          <div class="mobile-nav-dropdown-menu" id="resourcesMobileDropdownMenu">
            <!-- Will be populated dynamically -->
          </div>
        </div>

        <div id="resourcesContent" class="resources-container">
          <!-- Loading spinner will be shown when tab is clicked if data isn't ready -->
        </div>
      </div>
      
      <!-- Contacts Tab -->
      <div id="contactsTab" class="sub-content">
        <h2 class="kb-title" style="margin-bottom: 35px;">Contacts</h2>
        <div id="contactsContent">
          <!-- Loading spinner will be shown when tab is clicked if data isn't ready -->
        </div>
      </div>
      
      <!-- Glossary Tab -->
      <div id="glossaryTab" class="sub-content">
        <h2 class="kb-title" style="margin-bottom: 35px;">Axiom Glossary</h2>
        <div id="glossaryContent">
          <!-- Search bar -->
          <div style="margin-bottom: 25px;">
            <input type="text" id="glossarySearch" class="glossary-search" placeholder="Search glossary terms..." 
                   oninput="filterGlossary()"
                   onkeyup="filterGlossary()">
          </div>
          <!-- Glossary content will be rendered here -->
          <div id="glossaryList"></div>
        </div>
      </div>
    </div>
    
    <!-- SUBMIT UPDATE PAGE -->
    <div id="submitPage" class="page-section">
      <div class="wizard-container">
        <h2 style="font-size: 2.2em; font-weight: 700; color: rgba(31, 41, 55, 0.85); margin-bottom: 35px;">Submit Update Request</h2>
        
        <div class="wizard-section">
          <div class="form-group">
            <label>Your Name *</label>
            <input type="text" id="submitterName" placeholder="Your name">
          </div>
          
          <div class="form-group">
            <label>Your Email *</label>
            <input type="email" id="submitterEmail" placeholder="your.email@company.com">
          </div>
          
          <div class="form-grid">
            <div class="form-group">
              <label>What would you like to update? *</label>
              <select id="updateType" onchange="updateFormFields()">
                <option value="">Select...</option>
                <option value="Product">Product Information</option>
                <option value="Contact">Team Contact</option>
                <option value="Resource">Resource/Document</option>
                <option value="CaseStudy">Cross-sell Recommendation</option>
                <option value="Other">Other</option>
              </select>
            </div>
            
            <div class="form-group">
              <label>Action *</label>
              <select id="updateAction" onchange="updateFormFields()">
                <option value="">Select...</option>
                <option value="Add">Add New</option>
                <option value="Update">Update Existing</option>
                <option value="Delete">Delete/Remove</option>
              </select>
            </div>
          </div>
          
          <div id="dynamicFields"></div>
          
          <div class="form-group">
            <label>Description of Changes *</label>
            <textarea id="updateDescription" placeholder="Describe what you'd like to add, update, or remove..."></textarea>
          </div>
          
          <div class="form-group">
            <label>Justification/Reason</label>
            <textarea id="updateJustification" placeholder="Why is this change needed? (optional)"></textarea>
          </div>
          
          <button class="btn btn-primary-action" style="width: 100%;" onclick="submitUpdateRequest()">
            Submit Request
          </button>
        </div>
        
        <div id="submitSuccess" class="hidden"></div>
      </div>
    </div>
    
  </div>
  
  <!-- Product Detail Modal -->
  <div id="productDetailModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-icon">P</div>
        <div class="modal-title-section">
          <div class="modal-company" id="modalCompany"></div>
          <div class="modal-title" id="modalTitle"></div>
          <div class="modal-subtitle" id="modalSubtitle"></div>
        </div>
        <button class="modal-close" onclick="closeProductModal()">×</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>
  
  <!-- Cross-Sell Lead Submission Modal -->
  <div id="crossSellLeadModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <div class="modal-title-section">
          <div class="modal-title">Submit a Cross-Sell Referral</div>
          <div class="modal-subtitle">Choose a company to submit your referral</div>
        </div>
        <button class="modal-close" onclick="closeCrossSellLeadModal()">×</button>
      </div>
      <div class="modal-body">
        <div id="crossSellLeadCompanies" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
          <!-- Companies will be dynamically loaded here -->
        </div>
      </div>
    </div>
  </div>
  
  <!-- Selection Modals -->
  <div id="productSelectionModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title-section">
          <div class="modal-title">Which products does your client use?</div>
        </div>
        <button class="modal-close" onclick="closeModal('productSelectionModal')">×</button>
      </div>
      <div class="modal-body">
        <input type="text" class="modal-search" id="productSearch" placeholder="Search products..." oninput="filterModalProducts()">
        <div id="productChipContainer"></div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary-action" onclick="closeModal('productSelectionModal')">Cancel</button>
        <button class="btn btn-primary-action" onclick="confirmProductSelection()">Confirm Selection</button>
      </div>
    </div>
  </div>
  
  <div id="industryModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title-section">
          <div class="modal-title">What are the relevant industries for your client?</div>
        </div>
        <button class="modal-close" onclick="closeModal('industryModal')">×</button>
      </div>
      <div class="modal-body">
        <input type="text" class="modal-search" id="industrySearch" placeholder="Search industries..." oninput="filterModalIndustries()">
        <div class="chip-container" id="industryChipContainer"></div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary-action" onclick="closeModal('industryModal')">Cancel</button>
        <button class="btn btn-primary-action" onclick="confirmIndustrySelection()">Confirm Selection</button>
      </div>
    </div>
  </div>
  
  <script>
    // Global State
    let allProducts = [];
    let allProductDetails = [];
    let allIndustries = [];
    let allCompanies = [];
    let selectedProducts = [];
    let selectedIndustries = [];
    let currentCompanyIndex = 0;
    let allCompaniesData = [];
    let allTeamsData = {};
    let allProductsData = [];
    let selectedSize = '';
    let selectedSituation = '';
    let currentWizardPage = 1;
    let currentSizeFilter = '';
    let currentView = 'brand';
    let selectedBrand = '';
    let aboutPageLoaded = false;
    let allHistoryRules = [];
    let crossSellLeadUrl = ''; // Store cross-sell lead URL for instant access
    let allContacts = [];
    let allResources = [];
    let allGlossary = [];
    let currentOpportunities = []; // Store opportunities for export
    let suppressFilterTracking = false;
    
    // ============================================
    // USAGE TRACKING - Session and User Identification
    // ============================================
    
    // Track current page
    let currentPage = 'home';
    
    /**
     * Get or create a persistent user ID and session ID
     * User ID persists across sessions, Session ID is per browser session
     */
    function getOrCreateSessionId() {
      let sessionId = sessionStorage.getItem('axiom_session_id');
      let userId = localStorage.getItem('axiom_user_id');
      
      // Create session ID if not exists (new every time browser reopens)
      if (!sessionId) {
        sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        sessionStorage.setItem('axiom_session_id', sessionId);
      }
      
      // Create user ID if not exists (persists across sessions)
      if (!userId) {
        userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('axiom_user_id', userId);
      }
      
      return { sessionId, userId };
    }
    
    /**
     * Create a simple browser fingerprint for analytics
     */
    function getBrowserFingerprint() {
      return {
        screenResolution: `${screen.width}x${screen.height}`,
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
        language: navigator.language,
        platform: navigator.platform,
        userAgent: navigator.userAgent.substring(0, 100) // Truncated
      };
    }
    
    /**
     * Set developer mode (call once in browser console: setDeveloperMode(true))
     */
    function setDeveloperMode(isDev) {
      localStorage.setItem('axiom_is_developer', isDev ? 'true' : 'false');
      console.log('Developer mode ' + (isDev ? 'enabled' : 'disabled'));
      console.log('Your tracking will be ' + (isDev ? 'flagged as developer' : 'counted as regular user'));
    }
    
    /**
     * Main tracking function - sends events to Google Sheets
     */
    function trackEvent(action, details) {
      try {
        const { sessionId, userId } = getOrCreateSessionId();
        const isDeveloper = localStorage.getItem('axiom_is_developer') === 'true';
        const fingerprint = getBrowserFingerprint();
        
        const trackingData = {
          ...details,
          sessionId: sessionId,
          userId: userId,
          isDeveloper: isDeveloper,
          fingerprint: fingerprint,
          timestamp: new Date().toISOString()
        };
        
        // Send to server (non-blocking)
        google.script.run
          .withFailureHandler(err => {
            // Silently fail - don't disrupt user experience
            console.error('Tracking failed:', err);
          })
          .logUsage(action, currentPage || 'unknown', trackingData);
        
      } catch(e) {
        console.error('Tracking error:', e);
      }
    }
    
    // Auto-tracking on page load
    window.addEventListener('load', function() {
      trackEvent('app_loaded', { 
        url: window.location.href,
        referrer: document.referrer
      });
    });
    
    // Track when user leaves (optional - can be noisy)
    window.addEventListener('beforeunload', function() {
      trackEvent('app_unload', { 
        page: currentPage 
      });
    });
    
    // Helper function to sanitize industry names for use in HTML attributes
    function sanitizeAttributeName(industryName) {
      if (!industryName) return '';
      return industryName
        .toLowerCase()
        .replace(/\s+/g, '-')           // Replace spaces with hyphens
        .replace(/\//g, '-')            // Replace slashes with hyphens
        .replace(/[^a-z0-9-]/g, '-')   // Replace any other invalid chars with hyphens
        .replace(/-+/g, '-')            // Replace multiple hyphens with single hyphen
        .replace(/^-|-$/g, '');         // Remove leading/trailing hyphens
    }
    
    // Data readiness tracking for optimized loading
    let dataReady = {
      products: false,
      companies: false,
      productDetails: false,
      industries: false,
      about: false,
      history: false,
      contacts: false,
      resources: false,
      glossary: false
    };
    
    // Cache configuration - 10 minutes
    const CACHE_VERSION = '1.0';
    const CACHE_EXPIRY_MS = 10 * 60 * 1000; // 10 minutes cache
    const CACHE_KEYS = {
      products: 'axiom_products',
      companies: 'axiom_companies',
      companyInfo: 'axiom_companyInfo',
      productDetails: 'axiom_productDetails',
      industries: 'axiom_industries',
      history: 'axiom_history',
      teams: 'axiom_teams',
      contacts: 'axiom_contacts',
      resources: 'axiom_resources',
      glossary: 'axiom_glossary',
      cacheTimestamp: 'axiom_cacheTimestamp'
    };
    
    // Performance tracking
    const perfLog = {
      start: performance.now(),
      events: []
    };
    
    function logPerf(event, data) {
      const now = performance.now();
      const elapsed = now - perfLog.start;
      perfLog.events.push({ event, elapsed, data });
      console.log(`[Perf ${elapsed.toFixed(0)}ms] ${event}`, data || '');
    }
    
    // Cache utility functions
    function getCachedData(key) {
      try {
        const cached = localStorage.getItem(key);
        if (!cached) return null;
        
        const data = JSON.parse(cached);
        const now = Date.now();
        
        // Check if cache is expired
        if (data.timestamp && (now - data.timestamp) > CACHE_EXPIRY_MS) {
          localStorage.removeItem(key);
          logPerf('Cache expired', key);
          return null;
        }
        
        logPerf('Cache hit', key);
        return data.value;
      } catch (e) {
        console.error('Error reading cache:', e);
        return null;
      }
    }
    
    function setCachedData(key, value) {
      try {
        const data = {
          value: value,
          timestamp: Date.now()
        };
        localStorage.setItem(key, JSON.stringify(data));
        logPerf('Cache saved', key);
      } catch (e) {
        console.error('Error writing cache:', e);
        if (e.name === 'QuotaExceededError') {
          clearOldCache();
        }
      }
    }
    
    function clearOldCache() {
      const oneDayAgo = Date.now() - (24 * 60 * 60 * 1000);
      Object.values(CACHE_KEYS).forEach(key => {
        try {
          const cached = localStorage.getItem(key);
          if (cached) {
            const data = JSON.parse(cached);
            if (data.timestamp && data.timestamp < oneDayAgo) {
              localStorage.removeItem(key);
            }
          }
        } catch (e) {
          // Ignore errors
        }
      });
    }
    
    function loadFromCache() {
      logPerf('Loading from cache', 'start');
      const startTime = performance.now();
      
      // Load all cached data in parallel
      const cachedProducts = getCachedData(CACHE_KEYS.products);
      const cachedCompanyInfo = getCachedData(CACHE_KEYS.companyInfo);
      const cachedProductDetails = getCachedData(CACHE_KEYS.productDetails);
      const cachedIndustries = getCachedData(CACHE_KEYS.industries);
      const cachedHistory = getCachedData(CACHE_KEYS.history);
      const cachedTeams = getCachedData(CACHE_KEYS.teams);
      const cachedContacts = getCachedData(CACHE_KEYS.contacts);
      const cachedResources = getCachedData(CACHE_KEYS.resources);
      const cachedGlossary = getCachedData(CACHE_KEYS.glossary);
      
      if (cachedProducts) {
        allProducts = cachedProducts;
        dataReady.products = true;
      }
      
      if (cachedContacts) {
        allContacts = cachedContacts;
        dataReady.contacts = true;
      }
      
      if (cachedResources) {
        allResources = cachedResources;
        dataReady.resources = true;
      }
      
      if (cachedGlossary) {
        allGlossary = cachedGlossary;
        dataReady.glossary = true;
        buildAbbreviationMap();
        // Initialize tooltips on initial page load
        setTimeout(() => {
          initializeAbbreviationTooltips();
        }, 500);
      }
      
      if (cachedCompanyInfo && cachedProducts) {
        // Process company info same way as fresh data
        const companiesMap = {};
        cachedProducts.forEach(p => {
          if (!companiesMap[p.CompanyName]) {
            const companyInfoItem = cachedCompanyInfo.find(c => c.CompanyName === p.CompanyName);
            companiesMap[p.CompanyName] = {
              name: p.CompanyName,
              logoURL: p.CompanyLogoURL,
              shortBlurb: companyInfoItem ? (companyInfoItem.ShortBlurb || companyInfoItem.shortBlurb || '') : '',
              headquarters: companyInfoItem ? (companyInfoItem.Headquarters || companyInfoItem.headquarters || '') : '',
              productCount: 0,
              products: []
            };
          }
          companiesMap[p.CompanyName].productCount++;
          companiesMap[p.CompanyName].products.push(p);
        });
        allCompanies = Object.values(companiesMap);
        // Sort companies alphabetically by name
        allCompanies.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
        dataReady.companies = true;
      }
      
      if (cachedProductDetails) {
        allProductDetails = cachedProductDetails;
        dataReady.productDetails = true;
      }
      
      if (cachedIndustries) {
        allIndustries = cachedIndustries;
        dataReady.industries = true;
      }
      
      if (cachedHistory) {
        allHistoryRules = cachedHistory;
        window.historyRules = cachedHistory;
        dataReady.history = true;
      }
      
      if (cachedTeams) {
        allTeamsData = cachedTeams;
      }
      
      // Check if about page data is ready from cache
      if (cachedCompanyInfo && cachedTeams && cachedProducts) {
        allCompaniesData = cachedCompanyInfo;
        // Sort companies alphabetically by CompanyName
        allCompaniesData.sort((a, b) => (a.CompanyName || '').localeCompare(b.CompanyName || ''));
        allProductsData = cachedProducts;
        dataReady.about = true;
      }
      
      // Load cross-sell lead URL from cache for instant access
      const cachedCrossSellLeadUrl = localStorage.getItem('crossSellLeadUrl');
      const cachedCrossSellLeadUrlTime = localStorage.getItem('crossSellLeadUrlTime');
      const now = Date.now();
      if (cachedCrossSellLeadUrl && cachedCrossSellLeadUrlTime && (now - parseInt(cachedCrossSellLeadUrlTime)) < 3600000) {
        crossSellLeadUrl = cachedCrossSellLeadUrl;
      }
      
      const loadTime = performance.now() - startTime;
      logPerf('Cache load complete', `${loadTime.toFixed(0)}ms`);
      
      // If we have cached data, render immediately if on relevant tab
      if (dataReady.products && dataReady.companies) {
        if (document.getElementById('knowledgePage').classList.contains('active')) {
          populateFilters();
          renderKnowledgeBase();
        }
      }
      
      return {
        hasProducts: !!cachedProducts,
        hasCompanies: !!cachedCompanyInfo,
        hasDetails: !!cachedProductDetails,
        hasIndustries: !!cachedIndustries,
        hasHistory: !!cachedHistory,
        hasTeams: !!cachedTeams,
        hasContacts: !!cachedContacts,
        hasResources: !!cachedResources
      };
    }
    
    // Global error handlers for better debugging visibility
    window.addEventListener('error', function(e) {
      console.error('[Global Error]', {
        message: e.message,
        filename: e.filename,
        lineno: e.lineno,
        colno: e.colno,
        error: e.error,
        stack: e.error ? e.error.stack : 'No stack trace'
      });
    });
    
    // Catch unhandled promise rejections
    window.addEventListener('unhandledrejection', function(e) {
      console.error('[Unhandled Promise Rejection]', {
        reason: e.reason,
        promise: e.promise
      });
    });
    
    // Initialize
    window.onload = function() {
      logPerf('Page load', 'start');
      
      // STEP 1: Load from cache immediately (instant ~100ms)
      const cacheStatus = loadFromCache();
      logPerf('Cache status', cacheStatus);
      
      // STEP 2: Preload ALL data in parallel (fresh data)
      // This happens silently while user sees cached data
      loadInitialData(true); // true = isBackgroundRefresh
      
      // Log performance summary after 2 seconds
      setTimeout(() => {
        console.log('[Performance Summary]', perfLog.events);
      }, 2000);
    };
    
    function loadInitialData(isBackgroundRefresh = false) {
      if (!isBackgroundRefresh) {
        logPerf('Starting data load', 'fresh');
      } else {
        logPerf('Background refresh', 'start');
      }
      
      // FIX: Load ALL data in PARALLEL instead of sequentially
      // This reduces total load time from ~2000ms to ~500ms
      
      // 1. Load products
      const productsPromise = new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(function(products) {
            logPerf('Products loaded', products.length);
            allProducts = products;
            dataReady.products = true;
            setCachedData(CACHE_KEYS.products, products);
            resolve(products);
          })
          .withFailureHandler(function(error) {
            logPerf('Products error', error);
            console.error('Error loading products:', error);
            dataReady.products = false;
            reject(error);
          })
          .getAllProducts();
      });
      
      // 2. Load company info IN PARALLEL (not waiting for products)
      const companyInfoPromise = new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(function(companyInfo) {
            logPerf('Company info loaded', companyInfo.length);
            setCachedData(CACHE_KEYS.companyInfo, companyInfo);
            resolve(companyInfo);
          })
          .withFailureHandler(function(error) {
            logPerf('Company info error', error);
            console.error('Error loading company info:', error);
            resolve([]); // Resolve with empty array instead of reject
          })
          .getCompanyInfo();
      });
      
      // 3. Load industries IN PARALLEL
      const industriesPromise = new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(function(industries) {
            logPerf('Industries loaded', industries.length);
            allIndustries = industries;
            dataReady.industries = true;
            setCachedData(CACHE_KEYS.industries, industries);
            resolve(industries);
          })
          .withFailureHandler(function(error) {
            logPerf('Industries error', error);
            console.error('Error loading industries:', error);
            dataReady.industries = false;
            resolve([]);
          })
          .getUniqueIndustries();
      });
      
      // 4. Load product details IN PARALLEL
      const productDetailsPromise = new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(function(details) {
            logPerf('Product details loaded', details.length);
            allProductDetails = details;
            dataReady.productDetails = true;
            setCachedData(CACHE_KEYS.productDetails, details);
            resolve(details);
          })
          .withFailureHandler(function(error) {
            logPerf('Product details error', error);
            console.error('Error loading product details:', error);
            dataReady.productDetails = false;
            resolve([]);
          })
          .getProductDetails();
      });
      
      // 5. Load history IN PARALLEL
      const historyPromise = loadCrossSellHistoryPromise(true);

      // 6. Load teams IN PARALLEL (for about page)
      const teamsPromise = new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(function(teams) {
            logPerf('Teams loaded', Object.keys(teams || {}).length);
            allTeamsData = teams || {};
            setCachedData(CACHE_KEYS.teams, teams);
            resolve(teams);
          })
          .withFailureHandler(function(error) {
            logPerf('Teams error', error);
            console.error('Error loading teams:', error);
            resolve({}); // Resolve with empty object instead of reject
          })
          .getAllLeadershipTeams();
      });
      
      // 7. Load cross-sell lead URL IN PARALLEL
      const crossSellLeadUrlPromise = new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(function(url) {
            logPerf('Cross-sell lead URL loaded', url ? 'yes' : 'no');
            if (url && url.trim() !== '') {
              crossSellLeadUrl = url;
              localStorage.setItem('crossSellLeadUrl', url);
              localStorage.setItem('crossSellLeadUrlTime', Date.now().toString());
            }
            resolve(url);
          })
          .withFailureHandler(function(error) {
            logPerf('Cross-sell lead URL error', error);
            console.error('Error loading cross-sell lead URL:', error);
            resolve(''); // Resolve with empty string instead of reject
          })
          .getCrossSellLeadUrl();
      });
      
      // 8. Load contacts IN PARALLEL
      const contactsPromise = new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(function(contacts) {
            logPerf('Contacts loaded', contacts.length);
            allContacts = contacts;
            dataReady.contacts = true;
            setCachedData(CACHE_KEYS.contacts, contacts);
            resolve(contacts);
          })
          .withFailureHandler(function(error) {
            logPerf('Contacts error', error);
            console.error('Error loading contacts:', error);
            dataReady.contacts = false;
            resolve([]); // Resolve with empty array instead of reject
          })
          .getContacts();
      });
      
      // 9. Load resources IN PARALLEL
      const resourcesPromise = new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(function(resources) {
            logPerf('Resources loaded', resources.length);
            allResources = resources;
            dataReady.resources = true;
            setCachedData(CACHE_KEYS.resources, resources);
            resolve(resources);
          })
          .withFailureHandler(function(error) {
            logPerf('Resources error', error);
            console.error('Error loading resources:', error);
            dataReady.resources = false;
            resolve([]); // Resolve with empty array instead of reject
          })
          .getResources();
      });
      
      // 10. Load glossary IN PARALLEL
      const glossaryPromise = new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(function(glossary) {
            logPerf('Glossary loaded', glossary.length);
            allGlossary = glossary;
            dataReady.glossary = true;
            setCachedData(CACHE_KEYS.glossary, glossary);
            // Build abbreviation map for tooltips
            buildAbbreviationMap();
            resolve(glossary);
          })
          .withFailureHandler(function(error) {
            logPerf('Glossary error', error);
            console.error('Error loading glossary:', error);
            dataReady.glossary = false;
            resolve([]); // Resolve with empty array instead of reject
          })
          .getGlossary();
      });
      
      // Wait for products and companyInfo to process companies
      Promise.all([productsPromise, companyInfoPromise]).then(([products, companyInfo]) => {
        logPerf('Processing companies', 'start');
        
        const companiesMap = {};
        products.forEach(p => {
          if (!companiesMap[p.CompanyName]) {
            const companyInfoItem = companyInfo.find(c => c.CompanyName === p.CompanyName);
            companiesMap[p.CompanyName] = {
              name: p.CompanyName,
              logoURL: p.CompanyLogoURL,
              shortBlurb: companyInfoItem ? (companyInfoItem.ShortBlurb || companyInfoItem.shortBlurb || '') : '',
              headquarters: companyInfoItem ? (companyInfoItem.Headquarters || companyInfoItem.headquarters || '') : '',
              productCount: 0,
              products: []
            };
          }
          companiesMap[p.CompanyName].productCount++;
          companiesMap[p.CompanyName].products.push(p);
        });
        allCompanies = Object.values(companiesMap);
        // Sort companies alphabetically by name
        allCompanies.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
        dataReady.companies = true;
        logPerf('Companies processed', allCompanies.length);
        
        // Progressive enhancement: Update UI if visible
        if (document.getElementById('knowledgePage').classList.contains('active')) {
          populateFilters();
          renderKnowledgeBase();
        }
      }).catch(error => {
        console.error('Error processing companies:', error);
      });
      
      // Wait for about page data (companyInfo, teams, products) to be ready
      Promise.all([companyInfoPromise, teamsPromise, productsPromise]).then(([companyInfo, teams, products]) => {
        if (companyInfo && teams && products) {
          allCompaniesData = companyInfo;
          // Sort companies alphabetically by CompanyName
          allCompaniesData.sort((a, b) => (a.CompanyName || '').localeCompare(b.CompanyName || ''));
          allTeamsData = teams || {};
          allProductsData = products;
          dataReady.about = true;
          logPerf('About page data ready', 'from background load');
          
          // Progressive enhancement: Update UI if visible
          if (document.getElementById('aboutPage').classList.contains('active')) {
            renderAboutPage();
          }
        }
      }).catch(error => {
        console.error('Error loading about page data:', error);
      });
      
      // Wait for industries to update filters if needed
      industriesPromise.then(() => {
        if (document.getElementById('knowledgePage').classList.contains('active')) {
          populateFilters();
        }
      });
    }
    
    // ========================================
    // MOBILE DROPDOWN NAVIGATION
    // ========================================

    // Toggle mobile dropdown menu
    function toggleMobileDropdown(type) {
      const btn = document.querySelector(`#${type}MobileDropdown .mobile-nav-dropdown-btn`);
      const menu = document.getElementById(`${type}MobileDropdownMenu`);

      if (!btn || !menu) return;

      btn.classList.toggle('open');
      menu.classList.toggle('show');

      // Close dropdown when clicking outside
      if (menu.classList.contains('show')) {
        setTimeout(() => {
          document.addEventListener('click', function closeDropdown(e) {
            if (!e.target.closest(`#${type}MobileDropdown`)) {
              btn.classList.remove('open');
              menu.classList.remove('show');
              document.removeEventListener('click', closeDropdown);
            }
          });
        }, 10);
      }
    }

    // Populate About Us mobile dropdown
    function populateAboutMobileDropdown() {
      if (!allCompaniesData || !allCompaniesData.length) return;

      const menu = document.getElementById('aboutMobileDropdownMenu');
      if (!menu) return;

      let menuHtml = '';
      allCompaniesData.forEach((company, index) => {
        const activeClass = index === currentCompanyIndex ? 'active' : '';
        // Use scrollToCompanySection on mobile to scroll to the section
        menuHtml += `<button class="mobile-nav-dropdown-item ${activeClass}" onclick="scrollToCompanySection(${index})">${company.CompanyName}</button>`;
      });
      menu.innerHTML = menuHtml;

      // Update label to say "Jump to company..."
      const label = document.getElementById('aboutMobileDropdownLabel');
      if (label) {
        label.textContent = 'Jump to company...';
      }
    }

    // Update About dropdown label
    function updateAboutMobileDropdownLabel() {
      const label = document.getElementById('aboutMobileDropdownLabel');
      if (label && allCompaniesData && allCompaniesData[currentCompanyIndex]) {
        label.textContent = allCompaniesData[currentCompanyIndex].CompanyName;
      }
    }

    // Populate Resources mobile dropdown
    function populateResourcesMobileDropdown(companiesWithResources) {
      const menu = document.getElementById('resourcesMobileDropdownMenu');
      if (!menu) return;

      if (!companiesWithResources || companiesWithResources.length === 0) {
        menu.innerHTML = '<div style="padding: 12px; color: rgba(107, 114, 128, 0.7); text-align: center;">No companies with resources</div>';
        return;
      }

      let menuHtml = '';
      companiesWithResources.forEach((company, index) => {
        const encodedCompany = encodeURIComponent(company);
        menuHtml += `<button class="mobile-nav-dropdown-item" data-company="${encodedCompany}" onclick="selectMobileResourceCompany('${encodedCompany}')">${company}</button>`;
      });
      menu.innerHTML = menuHtml;

      // Update label to first company
      const label = document.getElementById('resourcesMobileDropdownLabel');
      if (label && companiesWithResources.length > 0) {
        label.textContent = companiesWithResources[0];
      }
    }

    // Select company from About mobile dropdown
    function selectMobileCompany(type, index) {
      // Close dropdown
      const btn = document.querySelector(`#${type}MobileDropdown .mobile-nav-dropdown-btn`);
      const menu = document.getElementById(`${type}MobileDropdownMenu`);
      if (btn) btn.classList.remove('open');
      if (menu) menu.classList.remove('show');

      if (type === 'about') {
        // Update active states in mobile dropdown
        menu.querySelectorAll('.mobile-nav-dropdown-item').forEach((item, i) => {
          item.classList.toggle('active', i === index);
        });

        // Scroll to company section
        switchToCompany(index);

        // Scroll to top of content area on mobile
        const section = document.querySelector(`#aboutContentArea .brand-section`);
        if (section) {
          section.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }
    }

    // Select company from Resources mobile dropdown
    function selectMobileResourceCompany(encodedCompany) {
      // Close dropdown
      const btn = document.querySelector('#resourcesMobileDropdown .mobile-nav-dropdown-btn');
      const menu = document.getElementById('resourcesMobileDropdownMenu');
      if (btn) btn.classList.remove('open');
      if (menu) menu.classList.remove('show');

      // Update dropdown label
      const label = document.getElementById('resourcesMobileDropdownLabel');
      if (label) {
        label.textContent = decodeURIComponent(encodedCompany);
      }

      // Update active state
      menu.querySelectorAll('.mobile-nav-dropdown-item').forEach(item => {
        item.classList.toggle('active', item.dataset.company === encodedCompany);
      });

      // Scroll to company section
      scrollToResourceCompany(encodedCompany);
    }

    // Navigation
    function showPage(pageName) {
      // Track navigation BEFORE page changes
      const fromPage = currentPage;
      trackEvent('navigate', { 
        from: fromPage || 'none', 
        to: pageName 
      });
      
      // Update currentPage variable
      currentPage = pageName;
      
      logPerf('Tab switch', pageName);
      
      // INSTANT TAB SWITCH - no waiting for data
      window.scrollTo(0, 0);
      
      // After showing a page, refresh tooltips
      setTimeout(() => {
        const activePage = document.querySelector('.page-section.active');
        if (activePage) {
          refreshAbbreviationTooltips(activePage);
        }
      }, 300);
      
      // FIX: Reset About Us scroll position when leaving the page
      const currentActivePage = document.querySelector('.page-section.active');
      if (currentActivePage && currentActivePage.id === 'aboutPage') {
        const aboutContent = document.getElementById('aboutContentArea');
        if (aboutContent) {
          aboutContent.scrollTop = 0;
        }
      }
      
      // Reset page-specific states
      if (pageName === 'about') {
        const aboutContent = document.getElementById('aboutContentArea');
        if (aboutContent) {
          aboutContent.scrollTop = 0;
        }
      }
      
      // INSTANTLY switch tabs
      document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
      
      const pageMap = {
        'home': 'homePage',
        'about': 'aboutPage',
        'knowledge': 'knowledgePage',
        'crosssell': 'crosssellPage',
        'resources': 'resourcesPage',
        'submit': 'submitPage'
      };
      
      document.getElementById(pageMap[pageName]).classList.add('active');
      document.querySelector(`[data-page="${pageName}"]`)?.classList.add('active');
      
      // NOW check if data is ready and load content
      if (pageName === 'knowledge') {
        // Reset Knowledge Base to brand view
        selectedBrand = '';
        currentView = 'brand';
        
        // Clear ALL filters when opening knowledge page
        const brandFilter = document.getElementById('filterBrand');
        if (brandFilter) brandFilter.value = '';
        const industryFilter = document.getElementById('filterIndustry');
        if (industryFilter) industryFilter.value = '';
        const searchInput = document.getElementById('searchProducts');
        if (searchInput) searchInput.value = '';
        currentSizeFilter = '';
        document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active'));
        
        document.querySelectorAll('.view-btn').forEach(btn => {
          btn.classList.toggle('active', btn.dataset.view === 'brand');
        });
        
        // Check if data is ready (cached or fresh)
        if (dataReady.products && dataReady.companies) {
          logPerf('Knowledge Base render', 'from cache/fresh');
          populateFilters();
          renderKnowledgeBase();
        } else {
          const container = document.getElementById('knowledgeContent');
          container.innerHTML = '<div class="loading"><div class="spinner"></div><p style="color: rgba(55, 65, 81, 0.85);">Loading products...</p></div>';
          
          const checkDataReady = setInterval(() => {
            if (dataReady.products && dataReady.companies) {
              clearInterval(checkDataReady);
              populateFilters();
              renderKnowledgeBase();
            }
          }, 100);
        }
      } else if (pageName === 'about') {
        // Check if data is ready (cached or fresh)
        if (dataReady.about) {
          logPerf('About page render', 'from cache/fresh');
          renderAboutPage();
        } else {
          // Show loading state
          const sidebar = document.getElementById('aboutSidebar');
          const contentArea = document.getElementById('aboutContentArea');
          if (sidebar) {
            sidebar.innerHTML = '<div style="padding: 20px; text-align: center; color: rgba(107, 114, 128, 0.7);"><div class="spinner" style="width: 30px; height: 30px; margin: 0 auto 10px;"></div><p style="font-size: 0.9em;">Loading companies...</p></div>';
          }
          if (contentArea) {
            contentArea.innerHTML = '<div style="padding: 60px 20px; text-align: center;"><div class="spinner" style="width: 50px; height: 50px; margin: 0 auto 20px;"></div><p style="font-size: 1.1em; color: rgba(107, 114, 128, 0.7);">Loading company information from database...</p></div>';
          }
          
          // Wait for data to be ready
          const checkDataReady = setInterval(() => {
            if (dataReady.about) {
              clearInterval(checkDataReady);
              renderAboutPage();
            }
          }, 100);
        }
      } else if (pageName === 'crosssell') {
        // Default to first sub-tab
        showSubTab('navigator');
        document.querySelectorAll('#crosssellPage .sub-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('#crosssellPage .sub-tab')[0].classList.add('active');
        
        // Check if history data is ready for history tab
        if (!dataReady.history) {
          const historyList = document.getElementById('historyList');
          if (historyList) {
            historyList.innerHTML = '<div class="loading"><div class="spinner"></div><p style="color: rgba(55, 65, 81, 0.85);">Loading cross-sell history...</p></div>';
          }
        }
      } else if (pageName === 'resources') {
        showResourceTab('library');
        document.querySelectorAll('#resourcesPage .sub-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('#resourcesPage .sub-tab')[0].classList.add('active');
        // Load resources when page is first shown
        loadResources();
      }
      
      // Refresh tooltips after page is shown
      setTimeout(() => {
        const activePage = document.querySelector('.page-section.active');
        if (activePage) {
          refreshAbbreviationTooltips(activePage);
        }
      }, 300);
    }
    
    // Handle Cross-Sell Lead button click
    function openCrossSellLeadForm(event) {
      var evt = event || window.event;
      if (evt) {
        evt.preventDefault();
        evt.stopPropagation();
      }
      
      // First, check if we already have company data loaded
      if (allCompaniesData && allCompaniesData.length > 0) {
        // Use cached data - show modal immediately
        renderCrossSellLeadModal(allCompaniesData);
        document.getElementById('crossSellLeadModal').classList.add('active');
        return;
      }
      
      // If data not available, load it (fallback)
      if (typeof google === 'undefined' || !google.script || !google.script.run) {
        alert('Unable to load company information. Please refresh the page and try again.');
        return;
      }
      
      google.script.run
        .withSuccessHandler(function(companies) {
          renderCrossSellLeadModal(companies);
          document.getElementById('crossSellLeadModal').classList.add('active');
        })
        .withFailureHandler(function(error) {
          console.error('Error loading company info:', error);
          alert('Error loading company information: ' + (error.message || error));
        })
        .getCompanyInfo();
    }

    function findCompanyCrossSellLeadUrl(companyName, companies) {
      if (!companyName || !companies || companies.length === 0) {
        return '';
      }
      
      const targetName = (companyName || '').trim();
      const company = companies.find(c => {
        const name = (c.CompanyName || c.companyName || c.name || '').trim();
        return name === targetName;
      });
      
      return company ? (company.CrossSellLeadUrl || company.crossSellLeadUrl || company.CrossSellLeadURL || '').trim() : '';
    }

    // Open the correct referral form directly (skip the modal)
    function openCrossSellLeadForCompany(companyName) {
      const targetName = (companyName || '').trim();
      if (!targetName) {
        alert('Unable to determine the company for this product.');
        return;
      }
      
      const openUrl = (companies) => {
        const url = findCompanyCrossSellLeadUrl(targetName, companies);
        if (url) {
          window.open(url, '_blank', 'noopener,noreferrer');
          return;
        }
        
        alert('No cross-sell referral form is available for ' + targetName + '.');
      };
      
      if (allCompaniesData && allCompaniesData.length > 0) {
        openUrl(allCompaniesData);
        return;
      }
      
      if (typeof google === 'undefined' || !google.script || !google.script.run) {
        alert('Unable to load company information. Please refresh the page and try again.');
        return;
      }
      
      google.script.run
        .withSuccessHandler(function(companies) {
          allCompaniesData = companies || [];
          // Sort companies alphabetically by CompanyName
          allCompaniesData.sort((a, b) => (a.CompanyName || '').localeCompare(b.CompanyName || ''));
          openUrl(allCompaniesData);
        })
        .withFailureHandler(function(error) {
          console.error('Error loading company info:', error);
          alert('Error loading company information: ' + (error.message || error));
        })
        .getCompanyInfo();
    }

    function renderCrossSellLeadModal(companies) {
      const container = document.getElementById('crossSellLeadCompanies');
      container.innerHTML = '';
      
      // Filter to only show companies that have a CrossSellLeadUrl
      const companiesWithLinks = companies.filter(company => {
        return company.CrossSellLeadUrl && company.CrossSellLeadUrl.trim() !== '';
      });
      
      if (companiesWithLinks.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: rgba(107, 114, 128, 0.7); padding: 20px;">No cross-sell referral forms are currently available.</p>';
        return;
      }
      
      // Create a link for each company
      companiesWithLinks.forEach(company => {
        const link = document.createElement('a');
        link.href = company.CrossSellLeadUrl;
        link.target = '_blank';
        link.rel = 'noopener noreferrer';
        link.className = 'cross-sell-company-link';
        link.innerHTML = `
          <span class="company-name">${company.CompanyName || 'Unknown Company'}</span>
        `;
        container.appendChild(link);
      });
    }

    function closeCrossSellLeadModal() {
      document.getElementById('crossSellLeadModal').classList.remove('active');
    }
    
    function showSubTab(tabName) {
      window.scrollTo(0, 0);
      
      document.querySelectorAll('#crosssellPage .sub-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('#crosssellPage .sub-content').forEach(c => c.classList.remove('active'));
      
      event.target.classList.add('active');
      document.getElementById(tabName + 'SubTab').classList.add('active');
      
      // If switching to history tab, check if data is ready
      if (tabName === 'history') {
        if (dataReady.history) {
          renderHistory();
        } else {
          // Show loading spinner inside tab content
          const historyList = document.getElementById('historyList');
          if (historyList) {
            historyList.innerHTML = '<div class="loading"><div class="spinner"></div><p style="color: rgba(55, 65, 81, 0.85);">Loading cross-sell history...</p></div>';
          }
          
          // Wait for data
          const checkHistoryReady = setInterval(() => {
            if (dataReady.history) {
              clearInterval(checkHistoryReady);
              renderHistory();
            }
          }, 100);
        }
      }
    }
    
    function showResourceTab(tabName) {
      window.scrollTo(0, 0);
      
      document.querySelectorAll('#resourcesPage .sub-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('#resourcesPage .sub-content').forEach(c => c.classList.remove('active'));
      
      // Set active tab button
      document.querySelectorAll('#resourcesPage .sub-tab').forEach(t => {
        if (tabName === 'library' && t.textContent.includes('Resources')) {
          t.classList.add('active');
        } else if (tabName === 'contacts' && t.textContent.includes('Contacts')) {
          t.classList.add('active');
        } else if (tabName === 'glossary' && t.textContent.includes('Glossary')) {
          t.classList.add('active');
        }
      });
      
      document.getElementById(tabName + 'Tab').classList.add('active');
      
      // Load data when tab is clicked
      if (tabName === 'contacts') {
        loadContacts();
      } else if (tabName === 'library') {
        loadResources();
      } else if (tabName === 'glossary') {
        loadGlossary();
      }
    }
    
    // Load and render contacts
    function loadContacts() {
      const container = document.getElementById('contactsContent');
      
      // Use cached data if available (instant display)
      if (dataReady.contacts && allContacts.length > 0) {
        renderContacts(allContacts);
        // Refresh in background
        if (typeof google !== 'undefined' && google.script && google.script.run) {
          google.script.run
            .withSuccessHandler(function(contacts) {
              allContacts = contacts;
              dataReady.contacts = true;
              setCachedData(CACHE_KEYS.contacts, contacts);
              // Only update if still on contacts tab
              if (document.getElementById('contactsTab').classList.contains('active')) {
                renderContacts(contacts);
              }
            })
            .withFailureHandler(function(error) {
              console.error('Error refreshing contacts:', error);
            })
            .getContacts();
        }
        return;
      }
      
      // Show loading state
      container.innerHTML = '<div class="loading"><div class="spinner"></div><p style="color: rgba(55, 65, 81, 0.85);">Loading contacts...</p></div>';
      
      if (typeof google === 'undefined' || !google.script || !google.script.run) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: rgba(239, 68, 68, 0.8);">Unable to load contacts. Please refresh the page.</div>';
        return;
      }
      
      google.script.run
        .withSuccessHandler(function(contacts) {
          allContacts = contacts;
          dataReady.contacts = true;
          setCachedData(CACHE_KEYS.contacts, contacts);
          renderContacts(contacts);
        })
        .withFailureHandler(function(error) {
          console.error('Error loading contacts:', error);
          container.innerHTML = '<div style="text-align: center; padding: 40px; color: rgba(239, 68, 68, 0.8);">Error loading contacts. Please try again.</div>';
        })
        .getContacts();
    }
    
    // Render contacts in list
    function renderContacts(contacts) {
      const container = document.getElementById('contactsContent');
      
      if (!contacts || contacts.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 80px 40px; background: rgba(255, 255, 255, 0.35); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); border-radius: 24px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05), inset 0 1px 0 rgba(255, 255, 255, 0.6); border: 1px solid rgba(255, 255, 255, 0.5);">
            <p style="color: rgba(107, 114, 128, 0.8); font-size: 1.1em;">No contacts available yet.</p>
            <p style="color: rgba(107, 114, 128, 0.7); font-size: 0.95em; margin-top: 15px;">Have contacts to add? Use the "Submit Update" tab to contribute.</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = '<div id="contactsList" style="display: flex; flex-direction: column; gap: 16px;"></div>';
      const list = document.getElementById('contactsList');
      
      contacts.forEach((contact, index) => {
        const row = createContactRow(contact, index);
        list.appendChild(row);
      });
    }
    
    // Create contact row (list item) - mobile optimized layout
    function createContactRow(contact, index) {
      const row = document.createElement('div');
      const isMobile = window.innerWidth <= 768;

      const name = contact.Name || contact.ContactID || 'Contact';
      const title = contact.Title || '';
      const email = contact.Email || '';
      const company = contact.CompanyName || '';
      const speciality = contact.Speciality || '';
      const products = contact.Products || '';

      const specialityBadge = speciality ? `<span class="product-badge badge-topic" style="margin-right: 8px; font-size: 0.75em;">${speciality}</span>` : '';
      const productChips = products ? products.split(',').slice(0, 2).map(p => `<span class="industry-chip" style="margin-right: 6px; font-size: 0.75em;">${p.trim()}</span>`).join('') : '';

      if (isMobile) {
        // Mobile layout: Name (left) - Role (right), Copy email (left) - Company (right)
        row.style.cssText = 'background: rgba(255, 255, 255, 0.35); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); border-radius: 12px; padding: 14px 16px; border: 1px solid rgba(255, 255, 255, 0.5); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05), inset 0 1px 0 rgba(255, 255, 255, 0.6); display: grid; grid-template-columns: 1fr auto; grid-template-rows: auto auto auto; gap: 4px 12px; transition: all 0.3s ease;';

        row.innerHTML = `
          <h4 style="font-size: 0.9em; font-weight: 600; color: rgba(31, 41, 55, 0.9); margin: 0; grid-column: 1; grid-row: 1;">${name}</h4>
          ${title ? `<p style="font-size: 0.85em; color: rgba(107, 114, 128, 0.8); margin: 0; text-align: right; grid-column: 2; grid-row: 1;">${title}</p>` : '<span style="grid-column: 2; grid-row: 1;"></span>'}
          <div style="grid-column: 1; grid-row: 2; display: flex; align-items: center;">
            ${email ? `
              <button class="team-member-email-btn" id="contact-email-btn-${index}" onclick="copyContactEmail('${email.replace(/'/g, "\\'")}', ${index})" style="font-size: 0.75em; padding: 2px 6px; margin: 0;">
                <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" style="width: 10px; height: 10px;">
                  <path d="M4 2a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V2zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H6zM2 4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-1h-1v1a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V6a1 1 0 0 1 1-1h1V4H2z"/>
                </svg>
                <span>Copy email</span>
              </button>
            ` : ''}
          </div>
          ${company ? `<span style="font-size: 0.85em; color: rgba(107, 114, 128, 0.8); font-weight: 500; text-align: right; grid-column: 2; grid-row: 2;">${company}</span>` : '<span style="grid-column: 2; grid-row: 2;"></span>'}
          ${(specialityBadge || productChips) ? `
            <div style="grid-column: 1 / -1; grid-row: 3; display: flex; align-items: center; gap: 6px; flex-wrap: wrap; margin-top: 4px;">
              ${specialityBadge}
              ${productChips}
            </div>
          ` : ''}
        `;
      } else {
        // Desktop layout (original)
        row.style.cssText = 'background: rgba(255, 255, 255, 0.35); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); border-radius: 16px; padding: 20px 24px; border: 1px solid rgba(255, 255, 255, 0.5); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05), inset 0 1px 0 rgba(255, 255, 255, 0.6); display: flex; align-items: center; justify-content: space-between; gap: 20px; transition: all 0.3s ease;';

        row.innerHTML = `
          <div style="flex: 1; display: flex; flex-direction: column; gap: 6px;">
            <h4 style="font-size: 1em; font-weight: 600; color: rgba(31, 41, 55, 0.9); margin: 0;">${name}</h4>
            ${title ? `<p style="font-size: 1em; color: rgba(107, 114, 128, 0.8); margin: 0; line-height: 1.4;">${title}</p>` : ''}
            <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap; margin-top: 4px;">
              ${specialityBadge}
              ${productChips}
            </div>
          </div>
          <div style="display: flex; align-items: center; gap: 12px;">
            ${company ? `<span style="font-size: 1em; color: rgba(107, 114, 128, 0.8); font-weight: 500;">${company}</span>` : ''}
            ${email ? `
              <button class="team-member-email-btn" id="contact-email-btn-${index}" onclick="copyContactEmail('${email.replace(/'/g, "\\'")}', ${index})">
                <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
                  <path d="M4 2a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V2zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H6zM2 4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-1h-1v1a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V6a1 1 0 0 1 1-1h1V4H2z"/>
                </svg>
                <span>Copy email</span>
              </button>
            ` : ''}
          </div>
        `;
      }

      return row;
    }
    
    // Copy contact email function (similar to copyTeamMemberEmail)
    function copyContactEmail(email, contactIndex) {
      navigator.clipboard.writeText(email).then(function() {
        const btn = document.getElementById(`contact-email-btn-${contactIndex}`);
        if (btn) {
          const originalHTML = btn.innerHTML;
          btn.innerHTML = `
            <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" style="width: 12px; height: 12px; fill: currentColor; flex-shrink: 0;">
              <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"/>
            </svg>
            <span>Email copied</span>
          `;
          btn.classList.add('copied');
          
          setTimeout(() => {
            btn.innerHTML = originalHTML;
            btn.classList.remove('copied');
          }, 2000);
        }
      }).catch(function(err) {
        console.error('Failed to copy email:', err);
      });
    }
    
    // Load and render resources
    function loadResources() {
      const container = document.getElementById('resourcesContent');
      
      // Wait for company data if not ready (needed for navigation)
      if (!allCompaniesData || allCompaniesData.length === 0) {
        // Try to load company data if available
        if (typeof google !== 'undefined' && google.script && google.script.run) {
          google.script.run
            .withSuccessHandler(function(companyInfo) {
              allCompaniesData = companyInfo || [];
              allCompaniesData.sort((a, b) => (a.CompanyName || '').localeCompare(b.CompanyName || ''));
              // Now load resources
              loadResourcesData();
            })
            .withFailureHandler(function(error) {
              console.error('Error loading company data:', error);
              // Continue anyway with empty company list
              loadResourcesData();
            })
            .getCompanyInfo();
        } else {
          loadResourcesData();
        }
        return;
      }
      
      loadResourcesData();
    }
    
    // Load resources data
    function loadResourcesData() {
      const container = document.getElementById('resourcesContent');
      
      // Use cached data if available (instant display)
      if (dataReady.resources && allResources.length > 0) {
        renderResources(allResources);
        // Refresh in background
        if (typeof google !== 'undefined' && google.script && google.script.run) {
          google.script.run
            .withSuccessHandler(function(resources) {
              allResources = resources;
              dataReady.resources = true;
              setCachedData(CACHE_KEYS.resources, resources);
              // Only update if still on resources tab
              if (document.getElementById('libraryTab').classList.contains('active')) {
                renderResources(resources);
              }
            })
            .withFailureHandler(function(error) {
              console.error('Error refreshing resources:', error);
            })
            .getResources();
        }
        return;
      }
      
      // Show loading state
      container.innerHTML = '<div class="loading"><div class="spinner"></div><p style="color: rgba(55, 65, 81, 0.85);">Loading resources...</p></div>';
      
      if (typeof google === 'undefined' || !google.script || !google.script.run) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: rgba(239, 68, 68, 0.8);">Unable to load resources. Please refresh the page.</div>';
        return;
      }
      
      google.script.run
        .withSuccessHandler(function(resources) {
          allResources = resources;
          dataReady.resources = true;
          setCachedData(CACHE_KEYS.resources, resources);
          renderResources(resources);
        })
        .withFailureHandler(function(error) {
          console.error('Error loading resources:', error);
          container.innerHTML = '<div style="text-align: center; padding: 40px; color: rgba(239, 68, 68, 0.8);">Error loading resources. Please try again.</div>';
        })
        .getResources();
    }
    
    // Get resource type icon based on category or format
    function getResourceIcon(resource) {
      const category = (resource.Category || '').toLowerCase();
      const format = (resource.Format || '').toLowerCase();
      
      if (format.includes('pdf') || format.includes('document')) return '📄';
      if (format.includes('video') || format.includes('webinar')) return '🎥';
      if (format.includes('link') || format.includes('url')) return '🔗';
      if (category.includes('case study') || category.includes('case')) return '📊';
      if (category.includes('guide') || category.includes('whitepaper')) return '📖';
      if (category.includes('template')) return '📝';
      if (category.includes('demo') || category.includes('presentation')) return '🎯';
      if (category.includes('training') || category.includes('course')) return '🎓';
      
      // Default icon
      return '📎';
    }
    
    // Get all companies from allCompaniesData (sorted alphabetically)
    function getAllCompaniesForResources() {
      if (!allCompaniesData || allCompaniesData.length === 0) {
        return [];
      }
      return allCompaniesData
        .map(company => company.CompanyName)
        .filter(name => name && name.trim())
        .sort((a, b) => a.localeCompare(b));
    }
    
    // Group resources by company
    function groupResourcesByCompany(resources) {
      const grouped = {};
      
      resources.forEach(resource => {
        const companies = resource.Companies || '';
        if (companies) {
          companies.split(',').forEach(company => {
            const trimmed = company.trim();
            if (trimmed) {
              if (!grouped[trimmed]) {
                grouped[trimmed] = [];
              }
              grouped[trimmed].push(resource);
            }
          });
        }
      });
      
      return grouped;
    }
    
    // Render resources in two-column layout with all companies
    function renderResources(resources) {
      const container = document.getElementById('resourcesContent');
      
      // Get all companies from allCompaniesData
      const allCompanies = getAllCompaniesForResources();
      
      if (allCompanies.length === 0) {
        container.innerHTML = `
          <div class="resources-content-panel">
            <div class="resources-empty">
              <p style="color: rgba(107, 114, 128, 0.8); font-size: 1.1em; margin-bottom: 12px;">No companies available.</p>
            </div>
          </div>
        `;
        return;
      }
      
      // Group resources by company
      const resourcesByCompany = groupResourcesByCompany(resources || []);
      
      // Separate companies into those with and without resources
      const companiesWithResources = [];
      const companiesWithoutResources = [];
        
      allCompanies.forEach(company => {
        if (resourcesByCompany[company] && resourcesByCompany[company].length > 0) {
          companiesWithResources.push(company);
        } else {
          companiesWithoutResources.push(company);
        }
      });
      
      // Create two-column layout
      container.innerHTML = `
        <div class="resources-company-nav" id="resourcesCompanyNav"></div>
        <div class="resources-content-panel" id="resourcesContentPanel"></div>
      `;
      
      // Render company navigator with companies with resources first, then without
      renderCompanyNavigator(companiesWithResources, companiesWithoutResources, resourcesByCompany);

      // Populate mobile dropdown
      populateResourcesMobileDropdown(companiesWithResources);

      // Render only companies with resources in the main content
      renderAllCompanyResources(companiesWithResources, resourcesByCompany);

      // Setup scroll spy (only for companies with resources)
      setupResourcesScrollSpy();

      // Initialize abbreviation tooltips
      refreshAbbreviationTooltips(document.getElementById('resourcesContent'));
    }
    
    // Render company navigator with companies with resources first, then without
    function renderCompanyNavigator(companiesWithResources, companiesWithoutResources, resourcesByCompany) {
      const nav = document.getElementById('resourcesCompanyNav');
      
      let navHtml = '';
      
      // Render companies with resources
      companiesWithResources.forEach((company, index) => {
        const encodedCompany = encodeURIComponent(company);
        const activeClass = index === 0 ? 'active' : '';
        navHtml += `
          <button class="resources-company-nav-item ${activeClass}" 
                  data-company="${encodedCompany}"
                  data-company-name="${company.replace(/"/g, '&quot;')}"
                  data-has-resources="true"
                  onclick="scrollToResourceCompany('${encodedCompany}')">
            ${company}
          </button>
        `;
      });
      
      // Add divider if there are companies without resources
      if (companiesWithoutResources.length > 0 && companiesWithResources.length > 0) {
        navHtml += '<hr class="resources-nav-divider">';
      }
      
      // Render companies without resources (visually de-emphasized)
      companiesWithoutResources.forEach((company) => {
        const encodedCompany = encodeURIComponent(company);
        navHtml += `
          <button class="resources-company-nav-item no-resources" 
                  data-company="${encodedCompany}"
                  data-company-name="${company.replace(/"/g, '&quot;')}"
                  data-has-resources="false"
                  onclick="showEmptyCompanyResources('${encodedCompany}')">
            ${company}
          </button>
        `;
      });
      
      nav.innerHTML = navHtml;
    }
    
    // Render all resources grouped by company in a single scrollable list (only companies with resources)
    function renderAllCompanyResources(companiesWithResources, resourcesByCompany) {
      const panel = document.getElementById('resourcesContentPanel');
      
      if (companiesWithResources.length === 0) {
        const emptyHtml = `
          <div class="resources-empty-message">
            <p style="color: rgba(107, 114, 128, 0.8); font-size: 1.1em; margin-bottom: 12px;">No resources available yet.</p>
            <p style="color: rgba(107, 114, 128, 0.7); font-size: 0.95em;">Have resources to share? Use the "Submit Update" tab to contribute.</p>
          </div>
        `;
        panel.innerHTML = emptyHtml;
        originalResourcesContent = emptyHtml;
        return;
      }
      
      let html = '';
      
      companiesWithResources.forEach((company, index) => {
        const companyId = `resource-company-${index}`;
        const companyResources = resourcesByCompany[company] || [];
        
        html += `<div class="resources-company-section" id="${companyId}" data-company="${encodeURIComponent(company)}" data-has-resources="true">`;
        html += `<div class="resources-company-header">${company}</div>`;
        html += '<div class="resources-list">';
        companyResources.forEach(resource => {
          html += createResourceRowHTML(resource);
        });
        html += '</div>';
        html += '</div>';
      });
      
      panel.innerHTML = html;
      // Store original content for restoration
      originalResourcesContent = html;
    }
    
    // Show empty state message for companies without resources
    function showEmptyCompanyResources(encodedCompany) {
      const company = decodeURIComponent(encodedCompany);
      const panel = document.getElementById('resourcesContentPanel');
      
      if (!panel) return;
      
      // Temporarily disable scroll spy
      scrollSpyEnabled = false;
      
      // Store original content if not already stored
      if (!originalResourcesContent) {
        originalResourcesContent = panel.innerHTML;
      }
      
      // Update active state in navigator
      document.querySelectorAll('.resources-company-nav-item').forEach(item => {
        item.classList.remove('active');
        if (item.getAttribute('data-company') === encodedCompany) {
          item.classList.add('active');
        }
      });
      
      // Clear active state from companies with resources when showing empty state
      document.querySelectorAll('.resources-company-nav-item[data-has-resources="true"]').forEach(item => {
        item.classList.remove('active');
      });
      
      // Scroll to top of panel
      panel.scrollTo({
        top: 0,
        behavior: 'smooth'
      });
      
      // Show empty state message
      panel.innerHTML = `
        <div class="resources-company-header">${company}</div>
        <div class="resources-empty-message">
          We're working on adding some resources here. If you have any suggestions, please <a href="#" onclick="showPage('submit'); return false;">submit your update here</a> to let us know!
        </div>
      `;
      
      // Re-enable scroll spy after a delay (but it won't affect empty state since there are no sections)
      setTimeout(() => {
        scrollSpyEnabled = true;
      }, 300);
    }
      
    // Create resource row HTML
    function createResourceRowHTML(resource) {
      const title = resource.Title || 'Resource';
      const url = resource.URL || '#';
      const icon = getResourceIcon(resource);
      
      const linkAttrs = url !== '#' ? `href="${url}" target="_blank" rel="noopener noreferrer"` : 'href="#" onclick="return false;"';
      
      return `
        <a class="resource-row" ${linkAttrs}>
          <div class="resource-icon">${icon}</div>
          <div class="resource-title">${title}</div>
          <div class="resource-action">Open →</div>
        </a>
      `;
    }
    
    // Setup scroll spy to update active nav item (only for companies with resources)
    function setupResourcesScrollSpy() {
      const panel = document.getElementById('resourcesContentPanel');
      if (!panel) return;
      
      // Don't setup scroll spy if we're showing an empty state (no sections with resources)
      const companySections = panel.querySelectorAll('.resources-company-section[data-has-resources="true"]');
      if (companySections.length === 0) return;
      
      // Only get nav items that have resources
      const navItems = document.querySelectorAll('.resources-company-nav-item[data-has-resources="true"]');
      
      if (navItems.length === 0) return;
      
      // Update active state based on scroll position
      const updateActiveNav = () => {
        // Don't update if scroll spy is disabled
        if (!scrollSpyEnabled) return;
        
        const scrollTop = panel.scrollTop;
        const offset = 120; // Offset for sticky header
        
        let activeNavItem = null;
        let activeIndex = -1;
        
        // Check each section to see which one is in view
        companySections.forEach((section, index) => {
          const sectionRect = section.getBoundingClientRect();
          const panelRect = panel.getBoundingClientRect();
          
          // Calculate relative position within the panel
          const sectionTop = sectionRect.top - panelRect.top + scrollTop;
          const sectionBottom = sectionTop + section.offsetHeight;
          
          // Check if section is in the viewport (with offset)
          // For the last section, check if we're near the bottom
          const isLastSection = index === companySections.length - 1;
          const isInView = isLastSection 
            ? (scrollTop + offset >= sectionTop - 50 || panel.scrollHeight - panel.scrollTop - panel.clientHeight < 50)
            : (scrollTop + offset >= sectionTop - 50 && scrollTop + offset < sectionBottom);
          
          if (isInView) {
            activeIndex = index;
            const companyName = section.getAttribute('data-company');
            navItems.forEach(item => {
              if (item.getAttribute('data-company') === companyName) {
                activeNavItem = item;
              }
            });
          }
        });
        
        // If no section is in view, check if we're at the top
        if (activeIndex === -1 && scrollTop < 50) {
          activeNavItem = navItems[0];
        }
        
        // Update active states (only for companies with resources)
        navItems.forEach(item => {
          item.classList.remove('active');
        });
        if (activeNavItem) {
          activeNavItem.classList.add('active');
        }
        
        // Clear active state from companies without resources
        document.querySelectorAll('.resources-company-nav-item[data-has-resources="false"]').forEach(item => {
          item.classList.remove('active');
        });
      };
      
      // Throttle scroll events
      let scrollTimeout;
      let isScrolling = false;
      
      panel.addEventListener('scroll', () => {
        if (!isScrolling) {
          isScrolling = true;
          updateActiveNav();
          setTimeout(() => {
            isScrolling = false;
          }, 100);
        }
      });
      
      // Initial update
      setTimeout(updateActiveNav, 100);
    }
    
    // Store original content to restore after showing empty state
    let originalResourcesContent = null;
    let scrollSpyEnabled = true; // Flag to temporarily disable scroll spy
    
    // Scroll to a specific company's section (only for companies with resources)
    function scrollToResourceCompany(encodedCompany) {
      const panel = document.getElementById('resourcesContentPanel');
      if (!panel) return;
      
      // Temporarily disable scroll spy to prevent interference
      scrollSpyEnabled = false;
      
      // Restore original content if we're coming from an empty state
      if (originalResourcesContent && panel.innerHTML !== originalResourcesContent) {
        panel.innerHTML = originalResourcesContent;
        // Re-setup scroll spy
        setupResourcesScrollSpy();
      }
      
      // Only look for sections with resources
      const section = panel.querySelector(`.resources-company-section[data-company="${encodedCompany}"][data-has-resources="true"]`);
      if (section) {
        // Update active nav item immediately (only for companies with resources)
        document.querySelectorAll('.resources-company-nav-item[data-has-resources="true"]').forEach(item => {
          item.classList.remove('active');
          if (item.getAttribute('data-company') === encodedCompany) {
            item.classList.add('active');
          }
        });
        
        // Clear active state from companies without resources
        document.querySelectorAll('.resources-company-nav-item[data-has-resources="false"]').forEach(item => {
          item.classList.remove('active');
        });
        
        // Wait for DOM to update, then scroll
        setTimeout(() => {
          const panelRect = panel.getBoundingClientRect();
          const sectionRect = section.getBoundingClientRect();
          const scrollTop = panel.scrollTop;
          const targetScroll = scrollTop + (sectionRect.top - panelRect.top) - 120; // Offset for sticky header
          
          panel.scrollTo({
            top: Math.max(0, targetScroll),
            behavior: 'smooth'
          });
          
          // Re-enable scroll spy after scroll completes
          setTimeout(() => {
            scrollSpyEnabled = true;
          }, 500);
        }, 50);
      } else {
        // Re-enable scroll spy if section not found
        scrollSpyEnabled = true;
      }
    }
    
    // Load and render glossary
    function loadGlossary() {
      const container = document.getElementById('glossaryList');
      
      // Use cached data if available (instant display)
      if (dataReady.glossary && allGlossary.length > 0) {
        buildAbbreviationMap();
        renderGlossary(allGlossary);
        // Refresh in background
        if (typeof google !== 'undefined' && google.script && google.script.run) {
          google.script.run
            .withSuccessHandler(function(glossary) {
              allGlossary = glossary;
              dataReady.glossary = true;
              setCachedData(CACHE_KEYS.glossary, glossary);
              buildAbbreviationMap();
              // Only update if still on glossary tab
              if (document.getElementById('glossaryTab').classList.contains('active')) {
                renderGlossary(glossary);
              }
            })
            .withFailureHandler(function(error) {
              console.error('Error refreshing glossary:', error);
            })
            .getGlossary();
        }
        return;
      }
      
      // Show loading state
      const searchBar = document.getElementById('glossarySearch');
      container.innerHTML = '<div class="loading"><div class="spinner"></div><p style="color: rgba(55, 65, 81, 0.85);">Loading glossary...</p></div>';
      
      if (typeof google === 'undefined' || !google.script || !google.script.run) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: rgba(239, 68, 68, 0.8);">Unable to load glossary. Please refresh the page.</div>';
        return;
      }
      
      google.script.run
        .withSuccessHandler(function(glossary) {
          allGlossary = glossary;
          dataReady.glossary = true;
          setCachedData(CACHE_KEYS.glossary, glossary);
          buildAbbreviationMap();
          renderGlossary(glossary);
          if (searchBar) {
            searchBar.style.display = 'block';
          }
        })
        .withFailureHandler(function(error) {
          console.error('Error loading glossary:', error);
          container.innerHTML = '<div style="text-align: center; padding: 40px; color: rgba(239, 68, 68, 0.8);">Error loading glossary. Please try again.</div>';
        })
        .getGlossary();
    }
    
    // Render glossary terms
    function renderGlossary(glossary) {
      const container = document.getElementById('glossaryList');
      const searchBar = document.getElementById('glossarySearch');
      
      if (!glossary || glossary.length === 0) {
        container.innerHTML = `
          <div class="glossary-empty">
            <p style="color: rgba(107, 114, 128, 0.8); font-size: 1.1em; margin-bottom: 12px;">No glossary terms available.</p>
          </div>
        `;
        return;
      }
      
      // Build abbreviation map for tooltips
      buildAbbreviationMap();
      
      // Sort alphabetically by abbreviation
      const sortedGlossary = [...glossary].sort((a, b) => {
        const abbrevA = (a.Abbreviation || '').toUpperCase();
        const abbrevB = (b.Abbreviation || '').toUpperCase();
        return abbrevA.localeCompare(abbrevB);
      });
      
      let html = '<div class="glossary-list">';
      
      sortedGlossary.forEach(term => {
        const abbreviation = term.Abbreviation || '';
        const fullName = term['Full Name'] || term.FullName || '';
        const notes = term.Notes || '';
        
        html += `
          <div class="glossary-item"
               data-abbreviation="${abbreviation.toLowerCase()}"
               data-fullname="${fullName.toLowerCase()}"
               data-notes="${notes.toLowerCase()}">
            <div class="glossary-line">
              <span class="glossary-abbreviation">${abbreviation}</span>
              <span class="glossary-separator"> - </span>
              <span class="glossary-full-name">${fullName}</span>
            </div>
            ${notes ? `<div class="glossary-notes">${notes}</div>` : ''}
          </div>
        `;
      });
      
      html += '</div>';
      container.innerHTML = html;
      
      // Store original HTML for filtering
      if (!window.originalGlossaryHTML) {
        window.originalGlossaryHTML = html;
      }
      
      if (searchBar) {
        searchBar.style.display = 'block';
      }
      
      // Initialize tooltips after rendering
      setTimeout(() => {
        initializeAbbreviationTooltips(container);
      }, 50);
    }
    
    // Debounce helper
    let glossarySearchDebounceTimer = null;
    
    // Filter glossary based on search input - instant, case-insensitive, debounced
    function filterGlossary() {
      // Clear existing debounce timer
      if (glossarySearchDebounceTimer) {
        clearTimeout(glossarySearchDebounceTimer);
      }
      
      // Debounce the actual filtering (small delay for performance)
      glossarySearchDebounceTimer = setTimeout(() => {
        const searchInput = document.getElementById('glossarySearch');
        const searchTerm = (searchInput.value || '').toLowerCase().trim();
        const terms = document.querySelectorAll('.glossary-item');
        const container = document.querySelector('.glossary-list');
        
        if (!searchTerm) {
          // Show all terms
          terms.forEach(term => {
            term.style.display = '';
          });
          if (container) {
            const noResults = container.querySelector('.glossary-no-results');
            if (noResults) {
              noResults.remove();
            }
          }
          return;
        }
        
        let visibleCount = 0;
        
        terms.forEach(term => {
          const abbreviation = term.getAttribute('data-abbreviation') || '';
          const fullName = term.getAttribute('data-fullname') || '';
          const notes = term.getAttribute('data-notes') || '';
          
          // Case-insensitive search across all fields
          const matches = abbreviation.includes(searchTerm) || 
                          fullName.includes(searchTerm) || 
                          notes.includes(searchTerm);
          
          if (matches) {
            term.style.display = '';
            visibleCount++;
          } else {
            term.style.display = 'none';
          }
        });
        
        // Show "no results" message if needed
        if (visibleCount === 0 && container) {
          let noResults = container.querySelector('.glossary-no-results');
          if (!noResults) {
            noResults = document.createElement('div');
            noResults.className = 'glossary-no-results';
            noResults.textContent = 'No matching terms found.';
            container.appendChild(noResults);
          }
        } else {
          const noResults = container?.querySelector('.glossary-no-results');
          if (noResults) {
            noResults.remove();
          }
        }
      }, 50); // Small debounce for smooth typing
    }
    
    // Abbreviation tooltip functionality - Portal-based, click-to-open
    let abbreviationMap = {}; // Map of abbreviation -> glossary term
    let currentTooltip = null; // Currently open tooltip element
    let currentTooltipAnchor = null; // Element that triggered the tooltip
    let tooltipPortal = null; // Portal container in document.body
    
    // Create tooltip portal if it doesn't exist
    function ensureTooltipPortal() {
      if (!tooltipPortal) {
        tooltipPortal = document.createElement('div');
        tooltipPortal.className = 'abbreviation-tooltip-portal';
        tooltipPortal.id = 'abbreviation-tooltip-portal';
        document.body.appendChild(tooltipPortal);
      }
      return tooltipPortal;
    }
    
    // Build abbreviation map from glossary data
    function buildAbbreviationMap() {
      abbreviationMap = {};
      
      if (!allGlossary || allGlossary.length === 0) {
        return;
      }
      
      allGlossary.forEach(term => {
        const abbrev = (term.Abbreviation || '').trim();
        if (abbrev) {
          // Store both uppercase and original case for matching
          abbreviationMap[abbrev.toUpperCase()] = term;
          abbreviationMap[abbrev] = term;
        }
      });
      
      setupTooltipObserver();
    }
    
    // Close current tooltip
    function closeTooltip() {
      if (currentTooltip) {
        currentTooltip.remove();
        currentTooltip = null;
      }
      if (currentTooltipAnchor) {
        currentTooltipAnchor = null;
      }
    }
    
    // Position and show tooltip
    function showTooltip(anchorElement, term) {
      const portal = ensureTooltipPortal();
      
      // Close existing tooltip if open
      closeTooltip();
      
      const fullName = term['Full Name'] || term.FullName || '';
      const notes = term.Notes || '';
      
      // Create tooltip content
      const tooltip = document.createElement('div');
      tooltip.className = 'abbreviation-tooltip-content';
      
      if (fullName) {
        const fullNameSpan = document.createElement('span');
        fullNameSpan.className = 'abbreviation-tooltip-full-name';
        fullNameSpan.textContent = fullName;
        tooltip.appendChild(fullNameSpan);
      }
      
      if (notes) {
        const notesSpan = document.createElement('span');
        notesSpan.className = 'abbreviation-tooltip-notes';
        notesSpan.textContent = notes;
        tooltip.appendChild(notesSpan);
      }
      
      portal.appendChild(tooltip);
      currentTooltip = tooltip;
      currentTooltipAnchor = anchorElement;
      
      // Track tooltip usage
      const abbreviation = anchorElement.getAttribute('data-abbreviation') || anchorElement.textContent || '';
      trackEvent('glossary_tooltip_view', {
        abbreviation: abbreviation,
        fullName: fullName,
        page: currentPage
      });
      
      // Position tooltip after it's in the DOM (so we can measure it)
      // Use requestAnimationFrame to ensure layout is complete
      requestAnimationFrame(() => {
        positionTooltip(anchorElement, tooltip);
      });
      
      // Update position on scroll/resize
      const updatePosition = () => {
        if (currentTooltip && currentTooltipAnchor) {
          positionTooltip(currentTooltipAnchor, currentTooltip);
        }
      };
      
      // Add scroll handler to close tooltip (only once)
      if (!window._tooltipScrollHandler) {
        window._tooltipScrollHandler = function() {
          if (currentTooltip) {
            closeTooltip();
          }
        };
        window.addEventListener('scroll', window._tooltipScrollHandler, true);
      }
      
      // Add resize handler to update position (only once)
      if (!window._tooltipResizeHandler) {
        window._tooltipResizeHandler = function() {
          updatePosition();
        };
        window.addEventListener('resize', window._tooltipResizeHandler);
      }
      
      // Add click-outside handler (only once)
      if (!document._tooltipClickHandler) {
        document._tooltipClickHandler = function(e) {
          if (currentTooltip && !currentTooltip.contains(e.target) && 
              currentTooltipAnchor && !currentTooltipAnchor.contains(e.target)) {
            closeTooltip();
          }
        };
        document.addEventListener('click', document._tooltipClickHandler, true);
      }
      
      // Add Esc key handler (only once)
      if (!document._tooltipEscHandler) {
        document._tooltipEscHandler = function(e) {
          if (e.key === 'Escape' && currentTooltip) {
            closeTooltip();
          }
        };
        document.addEventListener('keydown', document._tooltipEscHandler);
      }
    }
    
    // Position tooltip above or below anchor
    function positionTooltip(anchor, tooltip) {
      if (!anchor || !tooltip) return;
      
      const rect = anchor.getBoundingClientRect();
      const tooltipRect = tooltip.getBoundingClientRect();
      const viewportHeight = window.innerHeight;
      const viewportWidth = window.innerWidth;
      const offset = 7; // 6-8px offset
      
      // Try above first (default)
      let top = rect.top - tooltipRect.height - offset;
      
      // Check if there's enough space above
      if (top < 10) {
        // Not enough space above, position below
        top = rect.bottom + offset;
      }
      
      // Ensure tooltip stays within viewport vertically
      if (top + tooltipRect.height > viewportHeight - 10) {
        top = Math.max(10, viewportHeight - tooltipRect.height - 10);
      }
      
      // Center horizontally relative to anchor
      let left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
      
      // Ensure tooltip stays within viewport horizontally
      if (left < 10) {
        left = 10;
      } else if (left + tooltipRect.width > viewportWidth - 10) {
        left = viewportWidth - tooltipRect.width - 10;
      }
      
      tooltip.style.left = left + 'px';
      tooltip.style.top = top + 'px';
    }
    
    // Handle abbreviation click
    function handleAbbreviationClick(e, abbrev) {
      e.preventDefault();
      e.stopPropagation();
      
      const upperAbbrev = abbrev.toUpperCase();
      const term = abbreviationMap[upperAbbrev] || abbreviationMap[abbrev];
      
      if (!term) return;
      
      // If clicking the same abbreviation, close it
      if (currentTooltipAnchor === e.target) {
        closeTooltip();
        return;
      }
      
      // Show tooltip for clicked abbreviation
      showTooltip(e.target, term);
    }
    
    // Add tooltips to abbreviations in a text node
    function addTooltipsToTextNode(node) {
      if (node.nodeType !== Node.TEXT_NODE) {
        return;
      }
      
      const text = node.textContent;
      if (!text || text.trim().length === 0) {
        return;
      }
      
      // Regex to find potential abbreviations (word boundaries, all caps, 2-10 chars)
      // Match words that are all caps or contain slashes/dashes
      const abbrevRegex = /\b([A-Z]{2,10}(?:\/[A-Z]{1,10})?(?:-[A-Z]{1,10})?)\b/g;
      
      const matches = [];
      let match;
      
      while ((match = abbrevRegex.exec(text)) !== null) {
        const abbrev = match[1];
        const upperAbbrev = abbrev.toUpperCase();
        
        // Check if it's in our glossary
        if (abbreviationMap[upperAbbrev] || abbreviationMap[abbrev]) {
          matches.push({
            abbrev: abbrev,
            index: match.index,
            length: abbrev.length
          });
        }
      }
      
      // If no matches, return
      if (matches.length === 0) {
        return;
      }

      // Build replacement in-order to avoid duplicating text
      matches.sort((a, b) => a.index - b.index);

      const fragment = document.createDocumentFragment();
      let lastIndex = 0;

      matches.forEach(match => {
        const textBefore = text.substring(lastIndex, match.index);
        if (textBefore) {
          fragment.appendChild(document.createTextNode(textBefore));
        }

        const span = document.createElement('span');
        span.className = 'abbreviation-tooltip';
        span.textContent = match.abbrev;
        span.setAttribute('data-abbreviation', match.abbrev);
        span.addEventListener('click', (e) => handleAbbreviationClick(e, match.abbrev));
        fragment.appendChild(span);

        lastIndex = match.index + match.length;
      });

      const textAfter = text.substring(lastIndex);
      if (textAfter) {
        fragment.appendChild(document.createTextNode(textAfter));
      }

      node.parentNode.replaceChild(fragment, node);
    }
    
    // Process all text nodes in an element (recursively)
    function addTooltipsToElement(element) {
      if (!element) return;
      
      // Skip certain elements where we don't want tooltips
      const skipSelectors = [
        'script', 'style', 'noscript', 'code', 'pre',
        '.abbreviation-tooltip', // Don't process tooltips themselves
        'input', 'textarea', 'button', 'select'
      ];
      
      if (skipSelectors.some(selector => {
        try {
          return element.matches && element.matches(selector);
        } catch (e) {
          return false;
        }
      })) {
        return;
      }
      
      // Process child nodes
      const walker = document.createTreeWalker(
        element,
        NodeFilter.SHOW_TEXT,
        {
          acceptNode: function(node) {
            // Skip if parent is in skip list
            let parent = node.parentNode;
            while (parent && parent !== element) {
              if (skipSelectors.some(selector => {
                try {
                  return parent.matches && parent.matches(selector);
                } catch (e) {
                  return false;
                }
              })) {
                return NodeFilter.FILTER_REJECT;
              }
              parent = parent.parentNode;
            }
            return NodeFilter.FILTER_ACCEPT;
          }
        }
      );
      
      const textNodes = [];
      let node;
      while (node = walker.nextNode()) {
        textNodes.push(node);
      }
      
      // Process text nodes
      textNodes.forEach(textNode => {
        addTooltipsToTextNode(textNode);
      });
    }
    
    // Initialize abbreviation tooltips on a page/section
    function initializeAbbreviationTooltips(container) {
      if (!container) {
        container = document.body;
      }
      
      // Build map if not already built
      if (Object.keys(abbreviationMap).length === 0) {
        buildAbbreviationMap();
      }
      
      // Only process if we have glossary data
      if (Object.keys(abbreviationMap).length === 0) {
        return;
      }
      
      // Add tooltips to the container
      addTooltipsToElement(container);
    }
    
    // Re-initialize tooltips after dynamic content is loaded
    function refreshAbbreviationTooltips(container) {
      // Small delay to ensure DOM is ready
      setTimeout(() => {
        initializeAbbreviationTooltips(container);
      }, 100);
    }
    
    // Keep tooltips applied after background re-renders
    let tooltipObserver = null;
    let tooltipRefreshTimer = null;
    
    function scheduleTooltipRefresh() {
      if (tooltipRefreshTimer) {
        clearTimeout(tooltipRefreshTimer);
      }
      tooltipRefreshTimer = setTimeout(() => {
        if (!abbreviationMap || Object.keys(abbreviationMap).length === 0) return;
        if (tooltipObserver) tooltipObserver.disconnect();
        refreshAbbreviationTooltips(document.body);
        if (tooltipObserver) {
          tooltipObserver.observe(document.body, {
            childList: true,
            subtree: true,
            characterData: true
          });
        }
      }, 200);
    }
    
    function setupTooltipObserver() {
      if (tooltipObserver) return;
      
      tooltipObserver = new MutationObserver((mutations) => {
        if (!abbreviationMap || Object.keys(abbreviationMap).length === 0) return;
        
        const relevant = mutations.some((m) => {
          const target = m.target;
          if (target && target.id === 'abbreviation-tooltip-portal') return false;
          if (target && target.closest && target.closest('#abbreviation-tooltip-portal')) return false;
          return true;
        });
        
        if (relevant) {
          scheduleTooltipRefresh();
        }
      });
      
      tooltipObserver.observe(document.body, {
        childList: true,
        subtree: true,
        characterData: true
      });
    }
    
    
    // Helper function to copy to clipboard
    function copyToClipboard(text, message, buttonElement) {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => {
          if (message && buttonElement) {
            // Show temporary message
            const btn = buttonElement;
            const originalText = btn.textContent;
            btn.textContent = message;
            btn.style.background = 'var(--success)';
            setTimeout(() => {
              btn.textContent = originalText;
              btn.style.background = '';
            }, 2000);
          }
        });
      } else {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.opacity = '0';
        document.body.appendChild(textArea);
        textArea.select();
        try {
          document.execCommand('copy');
          if (message) {
            alert(message);
          }
        } catch (err) {
          console.error('Failed to copy:', err);
        }
        document.body.removeChild(textArea);
      }
    }
    
    //  About page brand navigation with smooth scrolling
    function scrollToBrand(brandId) {
      const brandSection = document.getElementById(brandId);
      const contentArea = document.getElementById('aboutContentArea');
      
      if (brandSection && contentArea) {
        const offsetTop = brandSection.offsetTop - contentArea.offsetTop - 20;
        contentArea.scrollTo({
          top: offsetTop,
          behavior: 'smooth'
        });
        
        // Update active state in sidebar
        document.querySelectorAll('.brand-nav-item').forEach(item => item.classList.remove('active'));
        event.target.classList.add('active');
      }
    }
    
    // Setup scroll listener for About page - called after content is loaded
    function setupAboutScrollListener() {
      const contentArea = document.getElementById('aboutContentArea');
      if (!contentArea) return;
      
      // Remove existing listener if any
      if (contentArea._scrollHandler) {
        contentArea.removeEventListener('scroll', contentArea._scrollHandler);
      }
      
      // Create new scroll handler
      contentArea._scrollHandler = function() {
        const brandSections = document.querySelectorAll('.brand-section');
        const navItems = document.querySelectorAll('.brand-nav-item');
        
        if (brandSections.length === 0 || navItems.length === 0) return;
        
        let currentBrand = '';
        
        // Check if scrolled to bottom - if so, highlight last brand
        const isAtBottom = contentArea.scrollHeight - contentArea.scrollTop <= contentArea.clientHeight + 50;
        
        if (isAtBottom && brandSections.length > 0) {
          // Get the last brand section's ID
          const lastSection = brandSections[brandSections.length - 1];
          currentBrand = lastSection.getAttribute('id') || '';
        } else {
          // Find which section is currently in view
          // Use the section that has its top edge closest to the top of the viewport
          let activeSection = null;
          let minDistance = Infinity;
          const viewportTop = contentArea.scrollTop + 100; // Offset from top of scrollable area
          
          brandSections.forEach(section => {
            const sectionTop = section.offsetTop;
            const distance = Math.abs(sectionTop - viewportTop);
            
            // Check if section is visible in viewport
            const sectionBottom = sectionTop + section.offsetHeight;
            const viewportBottom = contentArea.scrollTop + contentArea.clientHeight;
            
            // Section is active if it's top is above viewport top or within first 200px
            if (sectionTop <= viewportTop + 200 && sectionTop >= contentArea.scrollTop - 100) {
              if (distance < minDistance) {
                minDistance = distance;
                activeSection = section;
              }
            }
          });
          
          if (activeSection) {
            currentBrand = activeSection.getAttribute('id') || '';
          } else if (brandSections.length > 0) {
            // Fallback: find the section closest to the scroll position
            let closestSection = brandSections[0];
            let closestDistance = Math.abs(brandSections[0].offsetTop - viewportTop);
            
            brandSections.forEach(section => {
              const distance = Math.abs(section.offsetTop - viewportTop);
              if (distance < closestDistance) {
                closestDistance = distance;
                closestSection = section;
              }
            });
            
            currentBrand = closestSection.getAttribute('id') || '';
          }
        }
        
        // Update active state in sidebar based on matching IDs
        if (currentBrand) {
          navItems.forEach(item => {
            item.classList.remove('active');
            // Get the brand ID from the onclick attribute
            const onclickAttr = item.getAttribute('onclick');
            if (onclickAttr) {
              const match = onclickAttr.match(/scrollToBrand\('([^']+)'\)/);
              if (match && match[1] === currentBrand) {
                item.classList.add('active');
              }
            }
          });
        }
      };
      
      // Attach scroll listener
      contentArea.addEventListener('scroll', contentArea._scrollHandler);
      
      // Also trigger on initial load to set the first active
      setTimeout(() => {
        contentArea._scrollHandler();
      }, 200);
    }
    
    // Knowledge Base
    function populateFilters() {
      const brandSelect = document.getElementById('filterBrand');
      const industrySelect = document.getElementById('filterIndustry');
      
      // Clear existing options except "All Companies"
      while (brandSelect.children.length > 1) {
        brandSelect.removeChild(brandSelect.lastChild);
      }
      
      // Clear existing options except "All Industries"
      while (industrySelect.children.length > 1) {
        industrySelect.removeChild(industrySelect.lastChild);
      }
      
      const brands = [...new Set(allProducts.map(p => p.CompanyName))].sort();
      brands.forEach(brand => {
        const option = document.createElement('option');
        option.value = brand;
        option.textContent = brand;
        brandSelect.appendChild(option);
      });
      
      // Use allIndustries (same source as cross-sell tab) instead of creating from products
      if (allIndustries && allIndustries.length > 0) {
        [...allIndustries].sort().forEach(industry => {
          const option = document.createElement('option');
          option.value = industry;
          option.textContent = industry;
          industrySelect.appendChild(option);
        });
      } else {
        // Fallback: create from products if allIndustries not loaded yet
        const industries = new Set();
        allProducts.forEach(p => {
          if (p.Industries) {
            p.Industries.forEach(ind => {
              if (ind && ind !== 'all') {
                const formatted = ind.charAt(0).toUpperCase() + ind.slice(1);
                industries.add(formatted);
              }
            });
          }
        });
        [...industries].sort().forEach(industry => {
          const option = document.createElement('option');
          option.value = industry;
          option.textContent = industry;
          industrySelect.appendChild(option);
        });
      }
    }
    
    function switchView(view) {
      currentView = view;
      selectedBrand = '';
      
      // Clear ALL filters when switching views
      const brandFilter = document.getElementById('filterBrand');
      if (brandFilter) brandFilter.value = '';
      const industryFilter = document.getElementById('filterIndustry');
      if (industryFilter) industryFilter.value = '';
      const searchInput = document.getElementById('searchProducts');
      if (searchInput) searchInput.value = '';
      currentSizeFilter = '';
      document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active'));
      
      document.querySelectorAll('.view-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.view === view);
      });
      renderKnowledgeBase();
    }
    
    function renderKnowledgeBase() {
      const container = document.getElementById('knowledgeContent');
      
      // If data isn't ready yet, show loading state
      if (!dataReady.products || !dataReady.companies) {
        container.innerHTML = '<div class="loading"><div class="spinner"></div><p style="color: rgba(55, 65, 81, 0.85);">Loading products...</p></div>';
        return;
      }
      
      container.innerHTML = '<div class="kb-grid" id="productGrid"></div>';
      const grid = document.getElementById('productGrid');
      
      // Add back button if viewing a specific brand's products
      if (selectedBrand) {
        const backButton = document.createElement('button');
        backButton.className = 'brand-action back-to-brands-btn';
        backButton.innerHTML = '← Back to All Brands';
        backButton.onclick = () => {
          selectedBrand = '';
          currentView = 'brand';
          
          // Clear ALL filters when going back to brands
          const brandFilter = document.getElementById('filterBrand');
          if (brandFilter) brandFilter.value = '';
          const industryFilter = document.getElementById('filterIndustry');
          if (industryFilter) industryFilter.value = '';
          const searchInput = document.getElementById('searchProducts');
          if (searchInput) searchInput.value = '';
          currentSizeFilter = '';
          document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active'));
          
          document.querySelectorAll('.view-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.view === 'brand');
          });
          renderKnowledgeBase();
        };
        grid.appendChild(backButton);
      }
      
      if (currentView === 'brand' && !selectedBrand) {
        allCompanies.forEach(company => {
          const card = createBrandCard(company);
          grid.appendChild(card);
        });
      } else {
        // Render ALL products - applyFilters() will handle filtering
        // Sort products alphabetically by product name when in "view by product" mode
        const productsToRender = [...allProducts].sort((a, b) => {
          const nameA = (a.ProductName || '').toLowerCase();
          const nameB = (b.ProductName || '').toLowerCase();
          return nameA.localeCompare(nameB);
        });
        
        productsToRender.forEach(product => {
          const card = createProductCard(product);
          grid.appendChild(card);
        });
      }
      
      // Always call applyFilters after rendering
      applyFilters();
    }
    
    function createBrandCard(company) {
      const card = document.createElement('div');
      card.className = 'brand-card';
      
      const firstProduct = company.products[0];
      const stats = `<strong>${company.productCount}</strong> Product${company.productCount !== 1 ? 's' : ''}`;
      
      // Use logo from company instead of generic icon
      const logoHtml = company.logoURL 
        ? `<img src="${company.logoURL}" alt="${company.name} logo" style="max-width: 100%; max-height: 100%; object-fit: contain;" onerror="this.parentElement.innerHTML='${company.name.split(' ').map(w => w[0]).join('').substring(0, 2).toUpperCase()}'">` 
        : company.name.split(' ').map(w => w[0]).join('').substring(0, 2).toUpperCase();
      
      card.innerHTML = `
        <div class="brand-header">
          <div class="brand-icon">
            ${logoHtml}
          </div>
          <div class="brand-info">
            <h3 style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${company.name}</h3>
            <div class="brand-location">${company.headquarters || ''}</div>
          </div>
        </div>
        <div class="brand-stats">
          <div class="brand-stat">${stats}</div>
        </div>
        <div class="brand-highlight">
          ${company.shortBlurb || firstProduct.ShortDescription || 'Comprehensive compliance and risk management solutions'}
        </div>
        <button class="brand-action" onclick="viewBrandProducts('${company.name}')">
          View Products →
        </button>
      `;
      
      return card;
    }
    
    function viewBrandProducts(brandName) {
      selectedBrand = brandName.trim();
      
      trackEvent('company_products_view', {
        companyName: brandName.trim(),
        page: 'knowledge'
      });
      
      suppressFilterTracking = true;
      
      // Also set the brand filter dropdown to match
      const brandFilter = document.getElementById('filterBrand');
      if (brandFilter) {
        brandFilter.value = brandName.trim();
      }
      
      // Clear other filters when viewing a specific brand
      currentSizeFilter = '';
      document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active'));
      const industryFilter = document.getElementById('filterIndustry');
      if (industryFilter) industryFilter.value = '';
      const searchInput = document.getElementById('searchProducts');
      if (searchInput) searchInput.value = '';
      
      // Switch to product view to show products
      currentView = 'product';
      document.querySelectorAll('.view-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.view === 'product');
      });
      
      renderKnowledgeBase();
    }
    
    function createProductCard(product) {
      const card = document.createElement('div');
      card.className = 'product-card';
      card.setAttribute('data-brand', product.CompanyName);
      card.setAttribute('data-name', product.ProductName.toLowerCase());
      card.setAttribute('data-size', product.TargetClientSize);
      
      if (product.Industries) {
        product.Industries.forEach(ind => {
          if (ind && ind !== 'all') {
            const sanitized = sanitizeAttributeName(ind);
            if (sanitized) {
              card.setAttribute('data-industry-' + sanitized, 'true');
            }
          }
        });
      }
      
      let sizeBadge = '';
      if (product.TargetClientSize === 'SME') {
        sizeBadge = '<span class="product-badge badge-sme">SME</span>';
      } else if (product.TargetClientSize === 'Enterprise') {
        sizeBadge = '<span class="product-badge badge-enterprise">Enterprise</span>';
      } else if (product.TargetClientSize && product.TargetClientSize.includes('SME') && product.TargetClientSize.includes('Enterprise')) {
        sizeBadge = '<span class="product-badge badge-sme">SME</span><span class="product-badge badge-enterprise">Enterprise</span>';
      }
      // If blank/empty, sizeBadge remains empty string
      
      card.innerHTML = `
        <div class="product-card-inner">
          <div class="product-card-front">
            <div class="product-company" style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
              ${product.CompanyLogoURL ? `<img src="${product.CompanyLogoURL}" alt="${product.CompanyName} logo" style="max-width: 24px; max-height: 24px; object-fit: contain;" onerror="this.style.display='none'">` : ''}
              <span>${product.CompanyName}</span>
            </div>
            <div class="product-name">${product.ProductName}</div>
            <div class="product-badges">
              ${sizeBadge}
            </div>
            <div class="product-actions">
              <button class="product-btn btn-secondary" onclick="flipCard(event, '${product.ProductID}')">Details</button>
              <button class="product-btn btn-primary" onclick="showProductDetails('${product.ProductID}')">Full Description</button>
            </div>
          </div>
          
          <div class="product-card-back">
            <div class="detail-section" style="flex: 1;">
              <p>${product.ShortDescription || 'No description available'}</p>
            </div>
            
            <div class="product-actions" style="margin-top: auto;">
              <button class="product-btn btn-secondary" onclick="flipCard(event, '${product.ProductID}')">← Back</button>
              <button class="product-btn btn-primary" onclick="showProductDetails('${product.ProductID}')">Full Description</button>
            </div>
          </div>
        </div>
      `;
      
      return card;
    }
    
    function flipCard(event, productId) {
      event.stopPropagation();
      const card = event.target.closest('.product-card');
      card.classList.toggle('flipped');
    }
    
    function toggleSizeFilter(size) {
      const btn = event.target;
      if (currentSizeFilter === size) {
        currentSizeFilter = '';
        btn.classList.remove('active');
      } else {
        document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active'));
        currentSizeFilter = size;
        btn.classList.add('active');
      }
      applyFilters();
    }
    
    function applyFilters() {
      const searchInput = document.getElementById('searchProducts');
      const brandSelect = document.getElementById('filterBrand');
      const industrySelect = document.getElementById('filterIndustry');
      
      const search = searchInput?.value.toLowerCase() || '';
      const brand = brandSelect?.value || '';
      const industry = industrySelect?.value || '';
      
      // Use selectedBrand if set, otherwise use filter dropdown value
      const activeBrand = selectedBrand || brand;
      
      if (!suppressFilterTracking) {
        // Track search activity
        if (search) {
          trackEvent('search', { 
            query: search,
            page: 'knowledge'
          });
        }
        
        // Track filter application (only if filters are actually applied)
        if (brand || industry || currentSizeFilter) {
          trackEvent('filters_applied', { 
            brand: brand || 'all',
            industry: industry || 'all',
            size: currentSizeFilter || 'all',
            page: 'knowledge'
          });
        }
      } else {
        suppressFilterTracking = false;
      }
      
      // Debug logging
      console.log('Applying filters:', { 
        search, 
        brand, 
        activeBrand, 
        industry, 
        currentSizeFilter,
        selectedBrand 
      });
      
      let visibleCount = 0;
      let hiddenCount = 0;
      
      document.querySelectorAll('.product-card, .brand-card').forEach(card => {
        const name = card.getAttribute('data-name') || card.querySelector('h3')?.textContent.toLowerCase() || '';
        const cardBrand = card.getAttribute('data-brand') || card.querySelector('h3')?.textContent || '';
        const cardSize = card.getAttribute('data-size') || '';
        
        const matchSearch = !search || name.includes(search) || cardBrand.toLowerCase().includes(search);
        const matchBrand = !activeBrand || (cardBrand && cardBrand.trim().toLowerCase() === activeBrand.trim().toLowerCase());
        const matchIndustry = !industry || (() => {
          const sanitizedIndustry = sanitizeAttributeName(industry);
          return sanitizedIndustry && card.hasAttribute('data-industry-' + sanitizedIndustry);
        })();
        const matchSize = !currentSizeFilter || cardSize === currentSizeFilter || cardSize === 'Both';
        
        const shouldShow = matchSearch && matchBrand && matchIndustry && matchSize;
        
        if (shouldShow) {
          card.style.display = 'block';
          visibleCount++;
        } else {
          card.style.display = 'none';
          hiddenCount++;
          
          // Debug logging for hidden cards (only log first few to avoid spam)
          if (hiddenCount <= 3) {
            console.log('Hiding card:', {
              name: card.querySelector('.product-name')?.textContent || card.querySelector('h3')?.textContent,
              brand: cardBrand,
              size: cardSize,
              reasons: {
                search: !matchSearch ? 'search' : '',
                brand: !matchBrand ? 'brand' : '',
                industry: !matchIndustry ? 'industry' : '',
                size: !matchSize ? 'size' : ''
              }
            });
          }
        }
      });
      
      // Log summary
      const totalCount = document.querySelectorAll('.product-card, .brand-card').length;
      console.log(`Filter results: ${visibleCount} visible, ${hiddenCount} hidden (total: ${totalCount})`);
    }
    
    // Add function to reset all filters (useful for debugging)
    function resetAllFilters() {
      selectedBrand = '';
      currentSizeFilter = '';
      
      const brandFilter = document.getElementById('filterBrand');
      if (brandFilter) brandFilter.value = '';
      const industryFilter = document.getElementById('filterIndustry');
      if (industryFilter) industryFilter.value = '';
      const searchInput = document.getElementById('searchProducts');
      if (searchInput) searchInput.value = '';
      document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active'));
      
      renderKnowledgeBase();
    }
    
    // Make it available globally for debugging
    window.resetAllFilters = resetAllFilters;
    
    function showProductDetails(productId) {
      const product = allProducts.find(p => p.ProductID === productId);
      if (!product) return;
      
      // Track product view
      trackEvent('product_view', { 
        productId: productId,
        productName: product.ProductName,
        companyName: product.CompanyName,
        page: currentPage
      });
      
      // Find matching product details
      const productDetail = allProductDetails.find(pd => pd.ProductID === productId);
      
      document.getElementById('modalCompany').textContent = product.CompanyName;
      document.getElementById('modalTitle').textContent = product.ProductName;
      document.getElementById('modalSubtitle').textContent = '';
      
      let sizeBadges = '';
      if (product.TargetClientSize === 'SME') {
        sizeBadges = '<span class="modal-badge badge-sme">SME</span>';
      } else if (product.TargetClientSize === 'Enterprise') {
        sizeBadges = '<span class="modal-badge badge-enterprise">Enterprise</span>';
      } else if (product.TargetClientSize && product.TargetClientSize.includes('SME') && product.TargetClientSize.includes('Enterprise')) {
        sizeBadges = '<span class="modal-badge badge-sme">SME</span><span class="modal-badge badge-enterprise">Enterprise</span>';
      }
      // If blank/empty, sizeBadges remains empty string
      
      // Collect all key features (up to 10)
      const keyFeatures = [];
      for (let i = 1; i <= 10; i++) {
        const feature = product[`KeyFeature${i}`] || (productDetail && productDetail[`KeyFeature${i}`]);
        if (feature) keyFeatures.push(feature);
      }
      
      // Use FullDescription from product_details if available
      const fullDescription = productDetail && productDetail.FullDescription 
        ? productDetail.FullDescription 
        : product.ShortDescription || 'No description available';
      
      // Build demo/learn more buttons using helper function
      const demoHtml = generateDemoButtons(product);
      
      let learnMoreHtml = '';
      if (product.LearnMoreURL) {
        learnMoreHtml = `
          <a href="${product.LearnMoreURL}" target="_blank" class="opportunity-btn">
            Learn More
          </a>
        `;
      }
      // Set modal icon to company logo
      const modalIconDiv = document.querySelector('#productDetailModal .modal-icon');
      if (product.CompanyLogoURL) {
        modalIconDiv.innerHTML = '<img src="' + product.CompanyLogoURL + '" alt="' + product.CompanyName + '" style="max-width: 100%; max-height: 100%; object-fit: contain;" onerror="this.style.display=\'none\'; this.parentElement.textContent=\'P\';">';
      } else {
        modalIconDiv.textContent = 'P';
      }
      
      const hasMultipleSections = [
        productDetail && productDetail.TargetUsers,
        product.Industries && product.Industries.length > 0,
        keyFeatures.length > 0,
        product.PackageTiers,
        productDetail && productDetail.CommonUseCase,
        productDetail && productDetail.IntegrationsWith,
        product.KeyStats,
        (product.PricingBand_SME && product.PricingBand_SME !== 'STILL NEEDED') || 
          (product.PricingBand_Enterprise && product.PricingBand_Enterprise !== 'STILL NEEDED')
      ].filter(Boolean).length >= 3;
      
      const modalBody = document.getElementById('modalBody');
      modalBody.innerHTML = `
        ${(sizeBadges || demoHtml || learnMoreHtml) ? `
          <div class="modal-badges" style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
            ${sizeBadges || ''}
            ${demoHtml || ''}
            ${learnMoreHtml || ''}
          </div>
        ` : ''}
        
        ${hasMultipleSections ? `
          <div class="modal-jump-container">
            <button type="button" class="modal-jump-btn" onclick="toggleModalJumpMenu()" aria-label="Jump to section">
              Table of Contents ▾
            </button>
            <div class="modal-jump-menu" id="modalJumpMenu">
              <button type="button" class="modal-jump-item" onclick="jumpToModalSection('modal-desc')">Description</button>
              ${productDetail && productDetail.TargetUsers ? '<button type="button" class="modal-jump-item" onclick="jumpToModalSection(\'modal-users\')">Who This Is For</button>' : ''}
              ${product.Industries && product.Industries.length > 0 ? '<button type="button" class="modal-jump-item" onclick="jumpToModalSection(\'modal-industries\')">Target Industries</button>' : ''}
              ${keyFeatures.length > 0 ? '<button type="button" class="modal-jump-item" onclick="jumpToModalSection(\'modal-features\')">Key Features</button>' : ''}
              ${product.PackageTiers ? '<button type="button" class="modal-jump-item" onclick="jumpToModalSection(\'modal-packages\')">Package Options</button>' : ''}
              ${productDetail && productDetail.CommonUseCase ? '<button type="button" class="modal-jump-item" onclick="jumpToModalSection(\'modal-use-cases\')">Common Use Cases</button>' : ''}
              ${productDetail && productDetail.IntegrationsWith ? '<button type="button" class="modal-jump-item" onclick="jumpToModalSection(\'modal-integrations\')">Integrations</button>' : ''}
              ${product.KeyStats ? '<button type="button" class="modal-jump-item" onclick="jumpToModalSection(\'modal-stats\')">Key Statistics</button>' : ''}
              ${(product.PricingBand_SME && product.PricingBand_SME !== 'STILL NEEDED') || (product.PricingBand_Enterprise && product.PricingBand_Enterprise !== 'STILL NEEDED') ? '<button type="button" class="modal-jump-item" onclick="jumpToModalSection(\'modal-pricing\')">Pricing Information</button>' : ''}
            </div>
          </div>
        ` : ''}
        
        <div class="modal-section" id="modal-desc">
          <h3>Description</h3>
          <p>${fullDescription}</p>
        </div>
        
        ${productDetail && productDetail.TargetUsers ? `
          <div class="modal-section" id="modal-users">
            <h3>Who This Is For</h3>
            <ul>
              ${productDetail.TargetUsers.split(';').map(user => {
                const trimmed = user.trim();
                return trimmed ? `<li>${trimmed}</li>` : '';
              }).filter(li => li).join('')}
            </ul>
          </div>
        ` : ''}
        
        ${product.Industries && product.Industries.length > 0 ? `
          <div class="modal-section" id="modal-industries">
            <h3>Target Industries</h3>
            <div class="industry-chips">
              ${product.Industries.map(i => `<span class="industry-chip">${i.charAt(0).toUpperCase() + i.slice(1)}</span>`).join('')}
            </div>
          </div>
        ` : ''}
        
        ${keyFeatures.length > 0 ? `
          <div class="modal-section" id="modal-features">
            <h3>Key Features</h3>
            <ul>
              ${keyFeatures.map(f => `<li>${f}</li>`).join('')}
            </ul>
          </div>
        ` : ''}
        
        ${product.PackageTiers ? `
          <div class="modal-section" id="modal-packages">
            <h3>Package Options</h3>
            ${product.PackageTiers.split(';').map(tier => {
              const trimmed = tier.trim();
              if (!trimmed) return '';
              
              // Parse "Name: description" format
              const colonIndex = trimmed.indexOf(':');
              let name = trimmed;
              let desc = '';
              
              if (colonIndex > 0) {
                name = trimmed.substring(0, colonIndex).trim();
                desc = trimmed.substring(colonIndex + 1).trim();
              }
              
              return `
                <div style="padding: 4px 0; line-height: 1.6; color: rgba(55, 65, 81, 0.85);">
                  ${name}${desc ? `: ${desc}` : ''}
                </div>
              `;
            }).filter(html => html).join('')}
          </div>
        ` : ''}
        
        ${productDetail && productDetail.CommonUseCase ? `
          <div class="modal-section" id="modal-use-cases">
            <h3>Common Use Case</h3>
            <ul>
              ${productDetail.CommonUseCase.split(';').map(useCase => {
                const trimmed = useCase.trim();
                return trimmed ? `<li>${trimmed}</li>` : '';
              }).filter(li => li).join('')}
            </ul>
          </div>
        ` : ''}
        
        ${productDetail && productDetail.IntegrationsWith ? `
          <div class="modal-section" id="modal-integrations">
            <h3>Integrations</h3>
            <ul>
              ${productDetail.IntegrationsWith.split(';').map(integration => {
                const trimmed = integration.trim();
                return trimmed ? `<li>${trimmed}</li>` : '';
              }).filter(li => li).join('')}
            </ul>
          </div>
        ` : ''}
        
        ${product.KeyStats ? `
          <div class="modal-section" id="modal-stats">
            <h3>Key Statistics</h3>
            <ul>
              ${product.KeyStats.split(';').map(stat => {
                const trimmed = stat.trim();
                return trimmed ? `<li>${trimmed}</li>` : '';
              }).filter(li => li).join('')}
            </ul>
          </div>
        ` : ''}
        
        ${(product.PricingBand_SME && product.PricingBand_SME !== 'STILL NEEDED') || 
          (product.PricingBand_Enterprise && product.PricingBand_Enterprise !== 'STILL NEEDED') ? `
          <div class="modal-section" id="modal-pricing">
            <h3>Pricing Information</h3>
            <p>${product.PricingBand_SME && product.PricingBand_SME !== 'STILL NEEDED' ? 
              `<strong>SME:</strong> ${product.PricingBand_SME}` : ''}${product.PricingBand_SME && product.PricingBand_SME !== 'STILL NEEDED' && product.PricingBand_Enterprise && product.PricingBand_Enterprise !== 'STILL NEEDED' ? '<br>' : ''}${product.PricingBand_Enterprise && product.PricingBand_Enterprise !== 'STILL NEEDED' ? 
              `<strong>Enterprise:</strong> ${product.PricingBand_Enterprise}` : ''}</p>
          </div>
        ` : ''}
      `;
      
      // FIX: Reset scroll position AFTER modal becomes active
      // Use requestAnimationFrame to ensure it happens after DOM update
      document.getElementById('productDetailModal').classList.add('active');
      
      // Reset scroll after the modal is visible and rendered
      requestAnimationFrame(() => {
        const modalBody = document.getElementById('modalBody');
        if (modalBody) {
          modalBody.scrollTop = 0;
          // Force a reflow to ensure scroll reset sticks
          modalBody.offsetHeight;
          modalBody.scrollTop = 0;
        }
      });
    }
    
    function closeProductModal() {
      // FIX: Reset scroll BEFORE closing to ensure it's reset for next time
      const modalBody = document.getElementById('modalBody');
      if (modalBody) {
        modalBody.scrollTop = 0;
      }
      
      document.getElementById('productDetailModal').classList.remove('active');
    }
    
    function toggleModalJumpMenu() {
      const menu = document.getElementById('modalJumpMenu');
      if (menu) {
        menu.classList.toggle('show');
      }
    }
    
    function jumpToModalSection(sectionId) {
      if (!sectionId) return;
      
      const modalBody = document.getElementById('modalBody');
      const section = document.getElementById(sectionId);
      
      if (section && modalBody) {
        const offsetTop = section.offsetTop - modalBody.offsetTop - 20;
        modalBody.scrollTo({
          top: offsetTop,
          behavior: 'smooth'
        });
      }
      
      const menu = document.getElementById('modalJumpMenu');
      if (menu) {
        menu.classList.remove('show');
      }
    }
    
    // Generate demo buttons - single button or select dropdown
    function generateDemoButtons(product) {
      const demos = [];
      if (product.DemoURL1) demos.push({url: product.DemoURL1, label: product.DemoLabel1 || 'Demo'});
      if (product.DemoURL2) demos.push({url: product.DemoURL2, label: product.DemoLabel2 || 'Demo 2'});
      if (product.DemoURL3) demos.push({url: product.DemoURL3, label: product.DemoLabel3 || 'Demo 3'});
      
      if (demos.length === 0) return '';
      
      if (demos.length === 1) {
        // Single demo - regular button
        return `
          <a href="${demos[0].url}" target="_blank" class="opportunity-btn">
            ${demos[0].label}
          </a>
        `;
      }
      
      // Multiple demos - select dropdown
      return `
        <select class="opportunity-btn demo-select" onchange="if(this.value) window.open(this.value, '_blank'); this.value='';" style="text-align: left; cursor: pointer;">
          <option value="">View Demos (${demos.length}) ▾</option>
          ${demos.map(d => `<option value="${d.url}">${d.label}</option>`).join('')}
        </select>
      `;
    }
    
    function copyTeamMemberEmail(email, companyIndex, memberIndex) {
      navigator.clipboard.writeText(email).then(function() {
        const btn = document.getElementById(`email-btn-${companyIndex}-${memberIndex}`);
        if (btn) {
          const originalHTML = btn.innerHTML;
          btn.innerHTML = `
            <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" style="width: 12px; height: 12px; fill: currentColor; flex-shrink: 0;">
              <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"/>
            </svg>
            <span>Email copied</span>
          `;
          btn.classList.add('copied');
          
          setTimeout(() => {
            btn.innerHTML = originalHTML;
            btn.classList.remove('copied');
          }, 2000);
        }
      }).catch(function(err) {
        console.error('Failed to copy email:', err);
      });
    }
    
    // Helper function to render about page from cached/fresh data
    function renderAboutPage() {
      if (!allCompaniesData || !allCompaniesData.length) return;

      currentCompanyIndex = 0;

      const sidebar = document.getElementById('aboutSidebar');
      let sidebarHtml = '';
      allCompaniesData.forEach((company, index) => {
        const activeClass = index === 0 ? 'active' : '';
        sidebarHtml += `<button class="brand-nav-item ${activeClass}" onclick="switchToCompany(${index})">${company.CompanyName}</button>`;
      });
      sidebar.innerHTML = sidebarHtml;

      // Populate mobile dropdown
      populateAboutMobileDropdown();

      renderCompanyPage(0);
      aboutPageLoaded = true;
    }
    
    // Load About Us page from database
    function loadAboutPage() {
      if (aboutPageLoaded) return;
      
      logPerf('About page API load', 'start');
      
      Promise.all([
        new Promise((resolve) => {
          google.script.run
            .withSuccessHandler(resolve)
            .getCompanyInfo();
        }),
        new Promise((resolve) => {
          google.script.run
            .withSuccessHandler(resolve)
            .getAllLeadershipTeams();
        }),
        new Promise((resolve) => {
          google.script.run
            .withSuccessHandler(resolve)
            .getAllProducts();
        })
      ]).then(([companies, teams, products]) => {
        logPerf('About page loaded', 'complete');
        
        if (!companies || companies.length === 0) {
          document.getElementById('aboutContentArea').innerHTML = 
            '<div style="padding: 60px 20px; text-align: center;"><p style="font-size: 1.1em; color: rgba(107, 114, 128, 0.7);">No company information available in database.</p></div>';
          return;
        }
        
        // Cache the data
        setCachedData(CACHE_KEYS.companyInfo, companies);
        setCachedData(CACHE_KEYS.teams, teams);
        setCachedData(CACHE_KEYS.products, products);
        
        allCompaniesData = companies;
        // Sort companies alphabetically by CompanyName
        allCompaniesData.sort((a, b) => (a.CompanyName || '').localeCompare(b.CompanyName || ''));
        allTeamsData = teams || {};
        allProductsData = products || [];
        currentCompanyIndex = 0;
        
        const sidebar = document.getElementById('aboutSidebar');
        let sidebarHtml = '';
        companies.forEach((company, index) => {
          const activeClass = index === 0 ? 'active' : '';
          sidebarHtml += `<button class="brand-nav-item ${activeClass}" onclick="switchToCompany(${index})">${company.CompanyName}</button>`;
        });
        sidebar.innerHTML = sidebarHtml;

        // Populate mobile dropdown
        populateAboutMobileDropdown();

        // Check if mobile and render all companies, otherwise render single page
        if (window.innerWidth <= 768) {
          renderAllCompaniesForMobile();
        } else {
          renderCompanyPage(0);
        }
        aboutPageLoaded = true;
        dataReady.about = true;
      }).catch((error) => {
        logPerf('About page error', error);
        console.error('Error loading About page data:', error);
        document.getElementById('aboutContentArea').innerHTML = 
          '<div style="padding: 60px 20px; text-align: center;"><p style="font-size: 1.1em; color: rgba(107, 114, 128, 0.7);">Error loading company information.</p></div>';
      });
    }
    
    // New function to switch between companies
    function switchToCompany(index) {
      if (index < 0 || index >= allCompaniesData.length) return;

      const company = allCompaniesData[index];

      // Track company view
      if (company) {
        trackEvent('company_view', {
          companyName: company.CompanyName,
          companyId: company.CompanyID || '',
          page: 'about'
        });
      }

      // Update active state in sidebar
      document.querySelectorAll('.brand-nav-item').forEach((item, i) => {
        item.classList.toggle('active', i === index);
      });

      // Update mobile dropdown
      currentCompanyIndex = index;
      updateAboutMobileDropdownLabel();
      const mobileMenu = document.getElementById('aboutMobileDropdownMenu');
      if (mobileMenu) {
        mobileMenu.querySelectorAll('.mobile-nav-dropdown-item').forEach((item, i) => {
          item.classList.toggle('active', i === index);
        });
      }

      // Add transition effect
      const contentArea = document.getElementById('aboutContentArea');
      contentArea.style.opacity = '0';
      contentArea.style.transform = 'translateX(20px)';
      
      setTimeout(() => {
        currentCompanyIndex = index;
        renderCompanyPage(index);
        contentArea.style.opacity = '1';
        contentArea.style.transform = 'translateX(0)';
      }, 200);
    }
    
    // New function to render a single company page
    function renderCompanyPage(index) {
      const company = allCompaniesData[index];
      if (!company) return;
      
      const companyId = company.CompanyID || '';
      const teamMembers = allTeamsData[companyId] || [];
      const companyProducts = allProductsData.filter(p => p.CompanyName === company.CompanyName);
      
          const aboutContent = document.getElementById('aboutContentArea');
      
      // Calculate carousel pages
      const teamPages = Math.ceil(teamMembers.length / 3);
      const solutionPages = Math.ceil(companyProducts.length / 3);
      
      let html = `
        <div class="company-page-view">
          <div class="brand-section">
                <div class="brand-content-grid" style="${!company.VideoURL ? 'grid-template-columns: 1fr;' : ''}">
                  <div class="brand-text">
                    <h2 style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                      ${company.LogoURL ? `<img src="${company.LogoURL}" alt="${company.CompanyName} logo" style="max-width: 50px; max-height: 50px; object-fit: contain;" onerror="this.style.display='none'">` : ''}
                      ${company.CompanyName}
                    </h2>
                    
                    ${company.AboutText ? `<p style="color: rgba(55, 65, 81, 0.8); line-height: 1.6; margin-bottom: 20px;">${company.AboutText}</p>` : '<p style="color: rgba(107, 114, 128, 0.7); font-style: italic;">Content coming soon...</p>'}
                    ${company.WebsiteURL ? `<a href="${company.WebsiteURL}" target="_blank" style="color: rgba(99, 102, 241, 0.9); text-decoration: none; font-size: 0.95em; display: inline-block; margin-top: -10px; margin-bottom: 20px;">Learn more on the ${company.CompanyName} website ↗</a>` : ''}
                  </div>
                  
                  ${company.VideoURL ? `
                    <div class="brand-video">
                      <iframe src="${company.VideoURL}" frameborder="0" allowfullscreen></iframe>
                    </div>
                  ` : ''}
                </div>
            
            <!-- Meet the Team Section -->
            ${teamMembers.length > 0 ? `
              <div class="company-section-divider">
                <h3 style="color: rgba(31, 41, 55, 0.85); margin-bottom: 1px; font-size: 1.2em; font-weight: 700;">Meet the Team</h3>
                <div class="team-carousel-container">
                  <button class="carousel-nav-btn prev" onclick="navigateCarousel('team-${index}', -1)" aria-label="Previous team members">
                    ‹
                  </button>
                  <div class="team-carousel-wrapper">
                    <div class="team-carousel" id="team-carousel-${index}">
                      ${teamMembers.map((member, memberIndex) => `
                        <div class="team-member-card">
                          <h4 class="team-member-name" style="margin-bottom: -2px; line-height: 1.6;">
                            ${member.PersonName}
                          </h4>
                          <p class="team-member-title" style="margin-top: -2px; margin-bottom: -2px;line-height: 1.4;">${member.PersonTitle}</p>
                          ${member['Email Address'] ? 
                            `<button class="team-member-email-btn" id="email-btn-${index}-${memberIndex}" onclick="copyTeamMemberEmail('${member['Email Address'].replace(/'/g, "\\'")}', ${index}, ${memberIndex})">
                              <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
                                <path d="M4 2a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V2zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H6zM2 4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-1h-1v1a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V6a1 1 0 0 1 1-1h1V4H2z"/>
                              </svg>
                              <span>Copy email</span>
                            </button>` : 
                            ''}
                        </div>
                      `).join('')}
                    </div>
                  </div>
                  <button class="carousel-nav-btn next" onclick="navigateCarousel('team-${index}', 1)" aria-label="Next team members">
                    ›
                  </button>
                  ${teamPages > 1 ? `
                    <div class="carousel-pagination" id="team-pagination-${index}">
                      ${Array.from({ length: teamPages }, (_, i) => `
                        <button class="carousel-dot ${i === 0 ? 'active' : ''}" onclick="goToCarouselPage('team-${index}', ${i})" aria-label="Go to page ${i + 1}"></button>
                      `).join('')}
                    </div>
                  ` : ''}
                </div>
              </div>
            ` : ''}
            
            <!-- Our Solutions Section (exclude Axiom GRC) -->
            ${company.CompanyName !== 'Axiom GRC' && companyProducts.length > 0 ? `
              <div class="company-section-divider">
                <h3 style="color: rgba(31, 41, 55, 0.85); margin-bottom: 1px; font-size: 1.2em; font-weight: 700;">Our Solutions</h3>
                <div class="solutions-carousel-container">
                  <button class="carousel-nav-btn prev" onclick="navigateCarousel('solutions-${index}', -1)" aria-label="Previous solutions">
                    ‹
                  </button>
                  <div class="solutions-carousel-wrapper">
                    <div class="solutions-carousel" id="solutions-carousel-${index}">
                      ${companyProducts.map(product => `
                        <div class="solution-item">
                          <div class="solution-info">
                            <h4 class="solution-name">${product.ProductName}</h4>
                          </div>
                        </div>
                      `).join('')}
                    </div>
                  </div>
                  <button class="carousel-nav-btn next" onclick="navigateCarousel('solutions-${index}', 1)" aria-label="Next solutions">
                    ›
                  </button>
                  ${solutionPages > 1 ? `
                    <div class="carousel-pagination" id="solutions-pagination-${index}">
                      ${Array.from({ length: solutionPages }, (_, i) => `
                        <button class="carousel-dot ${i === 0 ? 'active' : ''}" onclick="goToCarouselPage('solutions-${index}', ${i})" aria-label="Go to page ${i + 1}"></button>
                      `).join('')}
                    </div>
                  ` : ''}
                </div>
              </div>
              <p style="text-align: center; margin-top: 16px; font-size: 0.9em;">
                  <a href="#" onclick="navigateToProduct('${company.CompanyName}'); return false;" style="color: rgba(99, 102, 241, 0.9); text-decoration: none; font-weight: 600; transition: all 0.2s ease;">
                    Learn more about our solutions here →
                  </a>
                </p>
              ` : ''}
              </div>
              </div>
            `;
          
          aboutContent.innerHTML = html;
      
      // Initialize carousels
      initializeCarousel(`team-carousel-${index}`, teamMembers.length);
      if (companyProducts.length > 0) {
        initializeCarousel(`solutions-carousel-${index}`, companyProducts.length);
      }
      
      // Scroll to top
      aboutContent.scrollTo({
        top: 0,
        behavior: 'smooth'
      });
    }

    // Function to render all companies for mobile view (scrollable)
    function renderAllCompaniesForMobile() {
      const aboutContent = document.getElementById('aboutContentArea');
      let html = '<div class="about-mobile-all-companies">';

      allCompaniesData.forEach((company, index) => {
        const companyId = company.CompanyID || '';
        const teamMembers = allTeamsData[companyId] || [];
        const companyProducts = allProductsData.filter(p => p.CompanyName === company.CompanyName);

        html += `
          <div class="about-mobile-company-section" id="company-section-${index}">
            <div class="brand-section">
              <div class="brand-content-grid" style="${!company.VideoURL ? 'grid-template-columns: 1fr;' : ''}">
                <div class="brand-text">
                  <h2 style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                    ${company.LogoURL ? `<img src="${company.LogoURL}" alt="${company.CompanyName} logo" style="max-width: 50px; max-height: 50px; object-fit: contain;" onerror="this.style.display='none'">` : ''}
                    ${company.CompanyName}
                  </h2>

                  ${company.AboutText ? `<p style="color: rgba(55, 65, 81, 0.8); line-height: 1.6; margin-bottom: 20px;">${company.AboutText}</p>` : '<p style="color: rgba(107, 114, 128, 0.7); font-style: italic;">Content coming soon...</p>'}
                  ${company.WebsiteURL ? `<a href="${company.WebsiteURL}" target="_blank" style="color: rgba(99, 102, 241, 0.9); text-decoration: none; font-size: 0.95em; display: inline-block; margin-top: -10px; margin-bottom: 20px;">Learn more on the ${company.CompanyName} website ↗</a>` : ''}
                </div>

                ${company.VideoURL ? `
                  <div class="brand-video">
                    <iframe src="${company.VideoURL}" frameborder="0" allowfullscreen></iframe>
                  </div>
                ` : ''}
              </div>

              <!-- Meet the Team Section -->
              ${teamMembers.length > 0 ? `
                <div class="company-section-divider">
                  <h3 style="color: rgba(31, 41, 55, 0.85); margin-bottom: 1px; font-size: 1.2em; font-weight: 700;">Meet the Team</h3>
                  <div class="team-carousel-container" style="padding: 0 10px;">
                    <div class="team-carousel-wrapper">
                      <div class="team-carousel" id="team-carousel-mobile-${index}">
                        ${teamMembers.map((member, memberIndex) => `
                          <div class="team-member-card">
                            <h4 class="team-member-name" style="margin-bottom: -2px; line-height: 1.6;">
                              ${member.PersonName}
                            </h4>
                            <p class="team-member-title" style="margin-top: -2px; margin-bottom: -2px;line-height: 1.4;">${member.PersonTitle}</p>
                            ${member['Email Address'] ?
                              `<button class="team-member-email-btn" id="email-btn-mobile-${index}-${memberIndex}" onclick="copyTeamMemberEmail('${member['Email Address'].replace(/'/g, "\\'")}', 'mobile-${index}', ${memberIndex})">
                                <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
                                  <path d="M4 2a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V2zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H6zM2 4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-1h-1v1a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V6a1 1 0 0 1 1-1h1V4H2z"/>
                                </svg>
                                <span>Copy email</span>
                              </button>` :
                              ''}
                          </div>
                        `).join('')}
                      </div>
                    </div>
                  </div>
                </div>
              ` : ''}

              <!-- Our Solutions Section -->
              ${company.CompanyName !== 'Axiom GRC' && companyProducts.length > 0 ? `
                <div class="company-section-divider">
                  <h3 style="color: rgba(31, 41, 55, 0.85); margin-bottom: 1px; font-size: 1.2em; font-weight: 700;">Our Solutions</h3>
                  <div class="solutions-carousel-container" style="padding: 0 10px;">
                    <div class="solutions-carousel-wrapper">
                      <div class="solutions-carousel" id="solutions-carousel-mobile-${index}">
                        ${companyProducts.map(product => `
                          <div class="solution-item">
                            <div class="solution-info">
                              <h4 class="solution-name">${product.ProductName}</h4>
                            </div>
                          </div>
                        `).join('')}
                      </div>
                    </div>
                  </div>
                </div>
                <p style="text-align: center; margin-top: 16px; font-size: 0.9em;">
                    <a href="#" onclick="navigateToProduct('${company.CompanyName}'); return false;" style="color: rgba(99, 102, 241, 0.9); text-decoration: none; font-weight: 600; transition: all 0.2s ease;">
                      Learn more about our solutions here →
                    </a>
                  </p>
              ` : ''}
            </div>
          </div>
        `;
      });

      html += '</div>';
      aboutContent.innerHTML = html;
    }

    // Function to scroll to a company section in mobile view
    function scrollToCompanySection(index) {
      const section = document.getElementById(`company-section-${index}`);
      if (section) {
        section.scrollIntoView({ behavior: 'smooth', block: 'start' });
        // Close the dropdown
        const menu = document.getElementById('aboutMobileDropdownMenu');
        const btn = document.querySelector('#aboutMobileDropdown .mobile-nav-dropdown-btn');
        if (menu) menu.classList.remove('show');
        if (btn) btn.classList.remove('open');
        // Update the label
        if (allCompaniesData[index]) {
          document.getElementById('aboutMobileDropdownLabel').textContent = allCompaniesData[index].CompanyName;
        }
      }
    }

    // Function to navigate to Knowledge Base filtered by company
    function navigateToProduct(companyName) {
      showPage('knowledge');
      // Set the selected brand and switch to product view
          setTimeout(() => {
        selectedBrand = companyName;
        currentView = 'product';
        document.querySelectorAll('.view-btn').forEach(btn => {
          btn.classList.toggle('active', btn.dataset.view === 'product');
        });
        renderKnowledgeBase();
      }, 100);
    }
    
    // Carousel state management
    const carouselStates = {};
    
    // Initialize carousel with touch support
    function initializeCarousel(carouselId, itemCount) {
      console.log(`[Carousel Debug] Initializing carousel: ${carouselId}, itemCount: ${itemCount}`);
      const carousel = document.getElementById(carouselId);
      console.log(`[Carousel Debug] Looking for element with ID: ${carouselId}`, carousel);
      if (!carousel) {
        console.error(`[Carousel Error] Carousel element not found: ${carouselId}`);
        return;
      }
      
      const pages = Math.ceil(itemCount / 3);
      console.log(`[Carousel Debug] Calculated pages: ${pages} for ${itemCount} items`);
      carouselStates[carouselId] = {
        currentPage: 0,
        totalPages: pages,
        itemCount: itemCount
      };
      
      updateCarouselUI(carouselId);
    }
    
    // Navigate carousel (direction: -1 for prev, 1 for next)
    function navigateCarousel(carouselId, direction) {
      console.log(`[Carousel Debug] navigateCarousel called: ${carouselId}, direction: ${direction}`);
      // Convert short ID (team-0) to full ID (team-carousel-0) for state lookup
      const fullCarouselId = carouselId.includes('-carousel-') ? carouselId : carouselId.replace('-', '-carousel-');
      const state = carouselStates[fullCarouselId];
      if (!state) {
        console.error(`[Carousel Error] No state found for carousel: ${fullCarouselId} (original: ${carouselId})`);
        return;
      }
      
      const newPage = state.currentPage + direction;
      console.log(`[Carousel Debug] Current page: ${state.currentPage}, New page: ${newPage}, Total pages: ${state.totalPages}`);
      
      if (newPage < 0 || newPage >= state.totalPages) {
        console.warn(`[Carousel Warning] Cannot navigate to page ${newPage} (out of bounds)`);
        return;
      }
      
      state.currentPage = newPage;
      updateCarouselPosition(fullCarouselId);
      updateCarouselUI(fullCarouselId);
    }
    
    // Go to specific carousel page
    function goToCarouselPage(carouselId, page) {
      console.log(`[Carousel Debug] goToCarouselPage called: ${carouselId}, page: ${page}`);
      // Convert short ID (team-0) to full ID (team-carousel-0) for state lookup
      const fullCarouselId = carouselId.includes('-carousel-') ? carouselId : carouselId.replace('-', '-carousel-');
      const state = carouselStates[fullCarouselId];
      if (!state) {
        console.error(`[Carousel Error] No state found for carousel: ${fullCarouselId} (original: ${carouselId})`);
        return;
      }
      
      if (page < 0 || page >= state.totalPages) {
        console.warn(`[Carousel Warning] Cannot go to page ${page} (out of bounds)`);
        return;
      }
      
      state.currentPage = page;
      updateCarouselPosition(fullCarouselId);
      updateCarouselUI(fullCarouselId);
    }
    
    // Update carousel position
    function updateCarouselPosition(carouselId) {
      const carousel = document.getElementById(carouselId);
      if (!carousel) {
        console.error(`[Carousel Error] Carousel element not found for position update: ${carouselId}`);
        return;
      }
      
      const state = carouselStates[carouselId];
      if (!state) {
        console.error(`[Carousel Error] No state found for position update: ${carouselId}`);
        return;
      }
      
      const wrapper = carousel.parentElement;
      if (!wrapper) {
        console.error(`[Carousel Error] Wrapper element not found for: ${carouselId}`);
        return;
      }
      
      const wrapperWidth = wrapper.offsetWidth;
      const cardWidth = (wrapperWidth - 24) / 3; // 40px for 2 gaps (20px each)
      const cardWidthWithGap = cardWidth + 12; // 20px gap
      const translateX = -(state.currentPage * cardWidthWithGap * 3);
      
      console.log(`[Carousel Debug] Updating position - Page: ${state.currentPage}, TranslateX: ${translateX}px, WrapperWidth: ${wrapperWidth}px`);
      carousel.style.transform = `translateX(${translateX}px)`;
    }
    
    // Update carousel UI (arrows, dots)
    function updateCarouselUI(carouselId) {
      const state = carouselStates[carouselId];
      if (!state) {
        console.error(`[Carousel Error] No state found for UI update: ${carouselId}`);
        return;
      }
      
      // Extract the base ID for button lookup (e.g., 'team-carousel-0' -> 'team-0')
      const baseId = carouselId.replace('-carousel-', '-');
      
      // Update navigation buttons - try both formats
      let prevBtn = document.querySelector(`[onclick*="navigateCarousel('${baseId}', -1)"]`);
      let nextBtn = document.querySelector(`[onclick*="navigateCarousel('${baseId}', 1)"]`);
      
      // Fallback: try with full ID
      if (!prevBtn || !nextBtn) {
        prevBtn = prevBtn || document.querySelector(`[onclick*="navigateCarousel('${carouselId}', -1)"]`);
        nextBtn = nextBtn || document.querySelector(`[onclick*="navigateCarousel('${carouselId}', 1)"]`);
      }
      
      console.log(`[Carousel Debug] Updating UI - Found prevBtn:`, !!prevBtn, `Found nextBtn:`, !!nextBtn, `baseId: ${baseId}, carouselId: ${carouselId}`);
      
      if (prevBtn) {
        prevBtn.disabled = state.currentPage === 0;
        console.log(`[Carousel Debug] Prev button disabled: ${prevBtn.disabled}`);
      } else {
        console.warn(`[Carousel Warning] Previous button not found for: ${baseId}`);
      }
      if (nextBtn) {
        nextBtn.disabled = state.currentPage >= state.totalPages - 1;
        console.log(`[Carousel Debug] Next button disabled: ${nextBtn.disabled}`);
      } else {
        console.warn(`[Carousel Warning] Next button not found for: ${baseId}`);
      }
      
      // Update pagination dots - convert carouselId to pagination ID format
      // e.g., 'team-carousel-0' -> 'team-pagination-0'
      const paginationId = carouselId.replace('-carousel-', '-pagination-');
      const pagination = document.getElementById(paginationId);
      if (pagination) {
        const dots = pagination.querySelectorAll('.carousel-dot');
        dots.forEach((dot, index) => {
          dot.classList.toggle('active', index === state.currentPage);
        });
        console.log(`[Carousel Debug] Updated pagination dots for: ${paginationId}`);
      } else {
        console.warn(`[Carousel Warning] Pagination element not found: ${paginationId}`);
      }
      
      // Update position
      updateCarouselPosition(carouselId);
    }
    
    // Navigator Wizard
    function goToWizardPage(page) {
      currentWizardPage = page;
      
      document.querySelectorAll('.wizard-page').forEach(p => p.classList.remove('active'));
      document.getElementById('wizardPage' + page).classList.add('active');
      
      for (let i = 1; i <= 3; i++) {
        const dot = document.getElementById('dot' + i);
        const line = document.getElementById('line' + i);
        
        if (i < page) {
          dot.className = 'progress-dot completed';
          if (line) line.className = 'progress-line completed';
        } else if (i === page) {
          dot.className = 'progress-dot active';
        } else {
          dot.className = 'progress-dot inactive';
          if (line) line.className = 'progress-line';
        }
      }
      
      if (page === 2) {
        updateCurrentProductsSummary();
      }
    }
    
    function selectCompanySize(size) {
      selectedSize = size;
      document.querySelectorAll('[data-size]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.size === size);
      });
    }
    
    function selectSituation(situation) {
      selectedSituation = situation;
      document.querySelectorAll('.situation-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.situation === situation);
      });
    }
    
    function openProductModal() {
      renderProductModal();
      document.getElementById('productSelectionModal').classList.add('active');
    }
    
    function openIndustryModal() {
      renderIndustryModal();
      document.getElementById('industryModal').classList.add('active');
    }
    
    function toggleRecommendationDetails(id) {
      const detailsDiv = document.getElementById(id);
      const toggleId = id.replace('rec-details-', 'rec-toggle-');
      const toggleSpan = document.getElementById(toggleId);
      
      if (detailsDiv && toggleSpan) {
        if (detailsDiv.style.display === 'none') {
          detailsDiv.style.display = 'block';
          toggleSpan.style.transform = 'rotate(90deg)';
        } else {
          detailsDiv.style.display = 'none';
          toggleSpan.style.transform = 'rotate(0deg)';
        }
      }
    }
    
    function toggleProductJumpMenu() {
      const menu = document.getElementById('productJumpMenu');
      if (menu) {
        menu.classList.toggle('show');
      }
    }
    
    function renderProductModal() {
      const container = document.getElementById('productChipContainer');
      container.innerHTML = '';
      
      const grouped = {};
      allProducts.forEach(product => {
        if (!grouped[product.CompanyName]) grouped[product.CompanyName] = [];
        grouped[product.CompanyName].push(product);
      });
      
      const companyNames = Object.keys(grouped).sort();
      
      if (companyNames.length > 3) {
        const jumpWrap = document.createElement('div');
        jumpWrap.className = 'modal-jump-container';
        jumpWrap.innerHTML = `
          <button type="button" class="modal-jump-btn" onclick="toggleProductJumpMenu()" aria-label="Jump to company">
            Jump to ▾
          </button>
          <div class="modal-jump-menu" id="productJumpMenu">
            ${companyNames.map(company => {
              const id = 'company-' + company.replace(/[^a-z0-9]+/gi, '-').replace(/^-+|-+$/g, '').toLowerCase();
              return `<button type="button" class="modal-jump-item" onclick="jumpToProductCompany('${id}')">${company}</button>`;
            }).join('')}
          </div>
        `;
        container.appendChild(jumpWrap);
      }
      
      companyNames.forEach(company => {
        const companyId = 'company-' + company.replace(/[^a-z0-9]+/gi, '-').replace(/^-+|-+$/g, '').toLowerCase();
        const group = document.createElement('div');
        group.className = 'chip-group';
        group.id = companyId;
        group.innerHTML = `
          <div class="chip-group-title">
            <span>${company}</span>
          </div>
          <div class="chip-container" data-company="${company}"></div>
        `;
        
        const chipContainer = group.querySelector('.chip-container');
        grouped[company].forEach(product => {
          const chip = document.createElement('div');
          chip.className = 'chip';
          chip.textContent = product.ProductName;
          chip.dataset.productId = product.ProductID;
          if (selectedProducts.includes(product.ProductID)) chip.classList.add('selected');
          chip.onclick = () => chip.classList.toggle('selected');
          chipContainer.appendChild(chip);
        });
        
        container.appendChild(group);
      });
    }
    
    function jumpToProductCompany(companyId) {
      if (!companyId) return;
      
      const modalBody = document.querySelector('#productSelectionModal .modal-body');
      const companyGroup = document.getElementById(companyId);
      
      if (companyGroup && modalBody) {
        const offsetTop = companyGroup.offsetTop - modalBody.offsetTop - 20;
        modalBody.scrollTo({
          top: offsetTop,
          behavior: 'smooth'
        });
      }
      
      const menu = document.getElementById('productJumpMenu');
      if (menu) {
        menu.classList.remove('show');
      }
    }
    
    function renderIndustryModal() {
      const container = document.getElementById('industryChipContainer');
      container.innerHTML = '';
      
      // Sort industries alphabetically
      const sortedIndustries = [...allIndustries].sort((a, b) => a.localeCompare(b));
      
      sortedIndustries.forEach(industry => {
        const chip = document.createElement('div');
        chip.className = 'chip';
        chip.textContent = industry;
        chip.dataset.industry = industry;
        if (selectedIndustries.includes(industry)) chip.classList.add('selected');
        chip.onclick = () => chip.classList.toggle('selected');
        container.appendChild(chip);
      });
    }
    
    function selectAllInCompany(company) {
      const chips = document.querySelectorAll(`[data-company="${company}"] .chip`);
      const allSelected = Array.from(chips).every(c => c.classList.contains('selected'));
      chips.forEach(chip => {
        if (allSelected) chip.classList.remove('selected');
        else chip.classList.add('selected');
      });
    }
    
    function confirmProductSelection() {
      selectedProducts = Array.from(document.querySelectorAll('#productChipContainer .chip.selected'))
        .map(chip => chip.dataset.productId);
      
      const display = document.getElementById('productDisplay');
      if (selectedProducts.length > 0) {
        display.innerHTML = `Selected <span class="selection-count">${selectedProducts.length}</span> products`;
        display.parentElement.classList.add('has-selection');
      } else {
        display.textContent = 'Select products...';
        display.parentElement.classList.remove('has-selection');
      }
      
      updateCurrentProductsSummary();
      closeModal('productSelectionModal');
    }
    
    function confirmIndustrySelection() {
      selectedIndustries = Array.from(document.querySelectorAll('#industryChipContainer .chip.selected'))
        .map(chip => chip.dataset.industry);
      
      const display = document.getElementById('industryDisplay');
      if (selectedIndustries.length > 0) {
        display.innerHTML = `Selected <span class="selection-count">${selectedIndustries.length}</span> industries`;
        display.parentElement.classList.add('has-selection');
      } else {
        display.textContent = 'Select industries...';
        display.parentElement.classList.remove('has-selection');
      }
      
      closeModal('industryModal');
    }
    
    function updateCurrentProductsSummary() {
      const summary = document.getElementById('currentProductsSummary');
      if (selectedProducts.length === 0) {
        summary.textContent = 'None selected';
      } else {
        const names = selectedProducts.map(id => {
          const product = allProducts.find(p => p.ProductID === id);
          return product ? product.ProductName : id;
        });
        summary.textContent = names.join(', ');
      }
    }
    
    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }
    
    // Universal modal close handlers - Escape key and click outside
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape' || event.keyCode === 27) {
        // Find the currently active modal
        const activeModal = document.querySelector('.modal.active');
        if (activeModal) {
          const modalId = activeModal.id;
          
          // Call the appropriate close function based on modal ID
          if (modalId === 'productDetailModal') {
            closeProductModal();
          } else if (modalId === 'crossSellLeadModal') {
            closeCrossSellLeadModal();
          } else if (modalId === 'exportModal') {
            closeExportModal();
          } else if (modalId === 'productSelectionModal' || modalId === 'industryModal') {
            closeModal(modalId);
          }
        }
      }
    });
    
    // Click outside modal-content to close
    document.addEventListener('click', function(event) {
      // Close jump menus when clicking outside
      if (!event.target.closest('.modal-jump-container')) {
        const modalJumpMenu = document.getElementById('modalJumpMenu');
        if (modalJumpMenu) {
          modalJumpMenu.classList.remove('show');
        }
        
        const productJumpMenu = document.getElementById('productJumpMenu');
        if (productJumpMenu) {
          productJumpMenu.classList.remove('show');
        }
      }
      
      // Check if click is on a modal backdrop (not on modal-content)
      if (event.target.classList.contains('modal') && event.target.classList.contains('active')) {
        const modalId = event.target.id;
        
        // Call the appropriate close function based on modal ID
        if (modalId === 'productDetailModal') {
          closeProductModal();
        } else if (modalId === 'crossSellLeadModal') {
          closeCrossSellLeadModal();
        } else if (modalId === 'exportModal') {
          closeExportModal();
        } else if (modalId === 'productSelectionModal' || modalId === 'industryModal') {
          closeModal(modalId);
        }
      }
    });
    
    function filterModalProducts() {
      const search = document.getElementById('productSearch').value.toLowerCase();
      document.querySelectorAll('#productChipContainer .chip').forEach(chip => {
        chip.style.display = chip.textContent.toLowerCase().includes(search) ? 'inline-flex' : 'none';
      });
    }
    
    function filterModalIndustries() {
      const search = document.getElementById('industrySearch').value.toLowerCase();
      document.querySelectorAll('#industryChipContainer .chip').forEach(chip => {
        chip.style.display = chip.textContent.toLowerCase().includes(search) ? 'inline-flex' : 'none';
      });
    }
    
    function findOpportunities() {
      if (selectedProducts.length === 0) {
        alert('Please fill in all required fields');
        return;
      }
      
      const selectedProductNames = selectedProducts
        .map(id => {
          const product = allProducts.find(p => p.ProductID === id);
          return product ? product.ProductName : null;
        })
        .filter(Boolean);
      
      // Track cross-sell generation
      trackEvent('crosssell_generate', { 
        selectedProductsCount: selectedProducts.length,
        products: selectedProductNames.join(', '),
        productIds: selectedProducts.join(','),
        companySize: selectedSize,
        industries: selectedIndustries.join(', '),
        situation: selectedSituation || 'Proactive'
      });
      
      const clientData = {
        companySize: selectedSize,
        industries: selectedIndustries,
        currentProducts: selectedProducts,
        situation: selectedSituation || 'Proactive'
      };
      
      const results = document.getElementById('navigatorResults');
      results.innerHTML = '<div class="loading"><div class="spinner"></div><p style="color: rgba(55, 65, 81, 0.85);">Finding opportunities...</p></div>';
      
      // Scroll to results
      setTimeout(() => {
        results.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 100);
      
      google.script.run
        .withSuccessHandler(function(opportunities) {
          displayOpportunities(opportunities, clientData);
        })
        .withFailureHandler(function(error) {
          results.innerHTML = `<div style="text-align: center; padding: 40px; color: var(--danger);">Error: ${error.message}</div>`;
        })
        .findCrossSellOpportunities(clientData);
    }
    
    function displayOpportunities(opportunities, clientData) {
      const resultsDiv = document.getElementById('navigatorResults');
      
      // Store opportunities globally for export
      currentOpportunities = opportunities;
      
      const recommendedNames = (opportunities || [])
        .map(opp => opp && opp.product ? opp.product.ProductName : null)
        .filter(Boolean);
      
      trackEvent('crosssell_results', {
        count: recommendedNames.length,
        recommendations: recommendedNames.join(', '),
        page: 'crosssell'
      });
      
      if (opportunities.length === 0) {
        resultsDiv.innerHTML = `
          <div class="results-header">
            <h3>No Cross-Sell Opportunities Found</h3>
            <p>It looks like there aren't any cross-sell opportunities in this case just yet! Check out the <a href="#" onclick="showSubTab('history'); return false;" style="color: #fbbf24; text-decoration: underline; cursor: pointer; font-weight: 600;">Cross-Sell History</a> tab for existing product pairings.</p>
          </div>
        `;
        return;
      }
      
      let html = `
        <div class="results-header">
          <h3>Top ${opportunities.length} Cross-Sell Opportunities</h3>
        </div>
      `;
      
      opportunities.forEach((opp, index) => {
        const product = opp.product;
        
        // Build demo buttons/dropdown using helper function
        const demoHtml = generateDemoButtons(product);
        
        let learnMoreHtml = '';
        if (product.LearnMoreURL) {
          learnMoreHtml = `
            <a href="${product.LearnMoreURL}" target="_blank" class="opportunity-btn">
              Learn More
            </a>
          `;
        }
        
        html += `
          <div class="opportunity-card">
            <div style="margin-bottom: 20px;">
              <h4 style="font-size: 1.6em; font-weight: 700; color: rgba(31, 41, 55, 0.85); margin-bottom: 8px;">
                ${index + 1}. ${product.ProductName}
              </h4>
              <p style="color: rgba(107, 114, 128, 0.8); font-size: 1.05em;">${product.CompanyName}</p>
            </div>
            
            <p style="color: rgba(55, 65, 81, 0.8); line-height: 1.7; margin-bottom: 16px;">
              ${product.ShortDescription}
            </p>
            
            ${(() => {
              const dataSources = String(opp.dataSource || '').split(/[,\s]+/).filter(ds => ds.trim());
              const pillTags = [];
              
              dataSources.forEach(ds => {
                const upperDs = ds.trim().toUpperCase();
                if (upperDs === 'REAL' && opp.clientCount) {
                  pillTags.push({
                    text: `${opp.clientCount} client${opp.clientCount !== 1 ? 's' : ''} use both products!`,
                    icon: 'ph-users'
                  });
                } else if (upperDs === 'EXPERT') {
                  pillTags.push({
                    text: 'Recommended by our cross-sell experts',
                    icon: 'ph-star'
                  });
                }
              });
              
              if (pillTags.length === 0) return '';
              
              return `<div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap;">
                ${pillTags.map(pill => `
                  <span style="display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; background: rgba(99, 102, 241, 0.08); border-radius: 8px; color: rgba(55, 65, 81, 0.8); font-family: 'Inter', sans-serif; font-size: 1em; line-height: 1.7; font-style: normal; cursor: default;">
                    <i class="ph ${pill.icon}" style="font-size: 1em; color: rgba(99, 102, 241, 0.7); display: inline-block; vertical-align: middle;"></i>
                    <span>${pill.text}</span>
                  </span>
                `).join('')}
              </div>`;
            })()}
            
            ${(opp.rationale || (opp.keyBenefits && opp.keyBenefits.length > 0)) ? `
            <div style="margin-bottom: 20px;">
                <div 
                  onclick="toggleRecommendationDetails('rec-details-${index}')"
                  style="cursor: pointer; padding: 8px 0; margin-bottom: 8px;"
                >
                  <span style="color: rgba(55, 65, 81, 0.8); line-height: 1.7; font-size: 1em;">
                    <strong>Why This Recommendation?</strong>${opp.insightsSource ? ` <span style="color: rgba(107, 114, 128, 0.7); font-weight: normal;">(${opp.insightsSource})</span>` : ''} <span id="rec-toggle-${index}" style="display: inline-flex; align-items: center; margin-left: 6px; transition: transform 0.2s ease; transform: rotate(0deg); vertical-align: middle;">
                    <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg" style="color: rgba(107, 114, 128, 0.6);">
                      <path d="M4.5 2.5L7.5 5.5L4.5 8.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </span>
                  </span>
                </div>
                <div id="rec-details-${index}" style="display: none; padding-left: 0; margin-top: 8px;">
                  ${opp.rationale ? `
                    <div style="margin-bottom: ${opp.keyBenefits && opp.keyBenefits.length > 0 ? '16px' : '0'};">
                      <p style="color: rgba(55, 65, 81, 0.8); line-height: 1.7; margin: 0;">${opp.rationale}</p>
                    </div>
                  ` : ''}
                  ${opp.keyBenefits && opp.keyBenefits.length > 0 ? `
                    <div>
                      <p style="color: rgba(55, 65, 81, 0.8); line-height: 1.7; font-size: 1em; margin-bottom: 10px;"><strong>Key Benefits:</strong></p>
                      <ul style="list-style: none; padding: 0; margin: 0;">
                        ${opp.keyBenefits.filter(b => b && b.trim()).map(benefit => `<li style="padding: 6px 0; padding-left: 25px; position: relative; color: rgba(55, 65, 81, 0.8);"><span style="position: absolute; left: 0; color: var(--primary); font-weight: bold;">•</span> ${benefit}</li>`).join('')}
                      </ul>
                    </div>
                  ` : ''}
                </div>
            </div>
            ` : ''}
            
            <div class="opportunity-actions">
              ${demoHtml}
              ${learnMoreHtml}
              <button class="opportunity-btn" onclick="showProductDetails('${product.ProductID}')">
                Full Description
              </button>
              <button class="nav-tab-submit-lead" onclick="openCrossSellLeadForCompany('${(product.CompanyName || '').replace(/'/g, "\\'")}')">
                Submit a Cross-Sell Referral
              </button>
            </div>
          </div>
        `;
      });
      
      resultsDiv.innerHTML = html;
    }
    
    // Cross-Sell History - Promise-based version
    function loadCrossSellHistoryPromise(isBackgroundRefresh = false) {
      return new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(function(rules) {
            logPerf('History loaded', rules.length);
            allHistoryRules = rules;
            window.historyRules = rules;
            dataReady.history = true;
            setCachedData(CACHE_KEYS.history, rules);
            
            // Progressive enhancement: Only render if history tab is currently visible
            const historyTab = document.getElementById('historySubTab');
            if (historyTab && historyTab.classList.contains('active')) {
              displayCrossSellHistory(rules);
            }
            resolve(rules);
          })
          .withFailureHandler(function(error) {
            logPerf('History error', error);
            console.error('Error loading history:', error);
            dataReady.history = false;
            resolve([]);
          })
          .getCrossSellData();
      });
    }
    
    // Keep the old function for compatibility
    function loadCrossSellHistory(isBackgroundRefresh = false) {
      loadCrossSellHistoryPromise(isBackgroundRefresh);
    }
    
    // Helper function to render history (used by showSubTab)
    function renderHistory() {
      if (allHistoryRules && allHistoryRules.length > 0) {
        displayCrossSellHistory(allHistoryRules);
      } else if (dataReady.history && window.historyRules) {
        // Data is ready, use it
        allHistoryRules = window.historyRules;
        displayCrossSellHistory(allHistoryRules);
      } else {
        // Data not ready yet, will be handled by loadCrossSellHistory
        loadCrossSellHistory();
      }
    }
    
    let historySizeFilter = '';
    
    function displayCrossSellHistory(rules) {
      const list = document.getElementById('historyList');
      list.innerHTML = '';
      
      // Filter to only show rules with DataSource containing "Real" (includes "Real", "Real, Expert", "Real,Expert", etc.)
      const realRules = rules.filter(rule => {
        const dataSource = String(rule.DataSource || '').trim().toUpperCase();
        return dataSource.includes('REAL');
      });
      
      // Store filtered rules for filtering
      allHistoryRules = realRules;
      window.historyRules = realRules;
      
      // Populate filter dropdowns
      populateHistoryFilters();
      
      // Set default sort to client count high to low
      const sortSelect = document.getElementById('historySortBy');
      if (sortSelect) {
        sortSelect.value = 'clientcount-desc';
        // Customize display: show "Clients" when closed, "Clients (high -> low)" in dropdown
        const defaultOption = sortSelect.querySelector('option[value="clientcount-desc"]');
        if (defaultOption && defaultOption.hasAttribute('data-display')) {
          // Store original text
          if (!defaultOption.hasAttribute('data-original')) {
            defaultOption.setAttribute('data-original', defaultOption.textContent);
          }
          // Set initial display text to short version
          defaultOption.textContent = defaultOption.getAttribute('data-display');
          
          // Restore full text when dropdown is about to open
          sortSelect.addEventListener('mousedown', function() {
            if (defaultOption.selected) {
              defaultOption.textContent = defaultOption.getAttribute('data-original');
            }
          });
          
          // Show short text when dropdown closes
          sortSelect.addEventListener('change', function() {
            setTimeout(function() {
              if (defaultOption.selected) {
                defaultOption.textContent = defaultOption.getAttribute('data-display');
              } else {
                defaultOption.textContent = defaultOption.getAttribute('data-original');
              }
            }, 10);
          });
          
          // Also handle blur for keyboard navigation
          sortSelect.addEventListener('blur', function() {
            if (defaultOption.selected) {
              defaultOption.textContent = defaultOption.getAttribute('data-display');
            }
          });
        }
      }
      
      // Apply default sorting and render
      filterHistoryList();
    }
    
    function populateHistoryFilters() {
      const industrySelect = document.getElementById('historyFilterIndustry');
      const brandSelect = document.getElementById('historyFilterBrand');
      
      // Get unique industries from rules
      const industries = new Set();
      const brands = new Set();
      
      allHistoryRules.forEach(rule => {
        const productA = allProducts.find(p => p.ProductID === rule.ProductA);
        const productB = allProducts.find(p => p.ProductID === rule.ProductB);
        
        if (productA) {
          brands.add(productA.CompanyName);
          if (productA.Industries) {
            productA.Industries.forEach(ind => {
              if (ind && ind !== 'all') industries.add(ind.charAt(0).toUpperCase() + ind.slice(1));
            });
          }
        }
        if (productB) {
          brands.add(productB.CompanyName);
          if (productB.Industries) {
            productB.Industries.forEach(ind => {
              if (ind && ind !== 'all') industries.add(ind.charAt(0).toUpperCase() + ind.slice(1));
            });
          }
        }
      });
      
      // Populate industries
      [...industries].sort().forEach(industry => {
        if (!industrySelect.querySelector(`option[value="${industry}"]`)) {
          const option = document.createElement('option');
          option.value = industry;
          option.textContent = industry;
          industrySelect.appendChild(option);
        }
      });
      
      // Populate brands
      [...brands].sort().forEach(brand => {
        if (!brandSelect.querySelector(`option[value="${brand}"]`)) {
          const option = document.createElement('option');
          option.value = brand;
          option.textContent = brand;
          brandSelect.appendChild(option);
        }
      });
    }
    
    function renderHistoryRules(rules) {
      const list = document.getElementById('historyList');
      list.innerHTML = '';
      
      if (rules.length === 0) {
        list.innerHTML = '<p style="text-align: center; color: rgba(107, 114, 128, 0.7); padding: 40px;">No cross-sell combinations found.</p>';
        return;
      }
      
      rules.forEach((rule, index) => {
        const productA = allProducts.find(p => p.ProductID === rule.ProductA);
        const productB = allProducts.find(p => p.ProductID === rule.ProductB);
        
        if (!productA || !productB) return;
        
        const logoA = productA.CompanyLogoURL ? `<img src="${productA.CompanyLogoURL}" alt="${productA.CompanyName} logo" class="history-company-logo" onerror="this.style.display='none'">` : '';
        const logoB = productB.CompanyLogoURL ? `<img src="${productB.CompanyLogoURL}" alt="${productB.CompanyName} logo" class="history-company-logo" onerror="this.style.display='none'">` : '';
        
        const row = document.createElement('div');
        row.className = 'history-row';
        row.dataset.index = index;
        row.innerHTML = `
          <div class="history-card">
            <div class="history-product-content">
              <div class="history-product-name">${productA.ProductName}</div>
              <div class="history-company">${logoA}<span>${productA.CompanyName}</span></div>
              <div class="history-product-actions">
                <button class="history-detail-btn" onclick="showProductDetails('${productA.ProductID}')">Full Description</button>
              </div>
            </div>
          </div>
          <div class="history-arrow-between">
            <div class="history-arrow-icons">
              <div class="history-arrow-icon">←</div>
              <div class="history-arrow-icon">→</div>
            </div>
            ${(() => {
              const clientCount = rule.ClientCount || rule.clientCount || 0;
              if (clientCount && clientCount > 0) {
                return `<div class="history-client-count">${clientCount} client${clientCount !== 1 ? 's' : ''}</div>`;
              }
              return '';
            })()}
          </div>
          <div class="history-card">
            <div class="history-product-content">
              <div class="history-product-name">${productB.ProductName}</div>
              <div class="history-company">${logoB}<span>${productB.CompanyName}</span></div>
              <div class="history-product-actions">
                <button class="history-detail-btn" onclick="showProductDetails('${productB.ProductID}')">Full Description</button>
              </div>
            </div>
          </div>
        `;
        list.appendChild(row);
      });
    }
    
    // Filter history list based on search input and filters
    function filterHistoryList() {
      const searchTerm = document.getElementById('historySearch').value.toLowerCase();
      const selectedIndustry = document.getElementById('historyFilterIndustry').value;
      const selectedBrand = document.getElementById('historyFilterBrand').value;
      const selectedSize = document.getElementById('historyClientSize').value;
      const sortBy = document.getElementById('historySortBy').value;
      
      // Filter rules
      let filteredRules = allHistoryRules.filter(rule => {
        const productA = allProducts.find(p => p.ProductID === rule.ProductA);
        const productB = allProducts.find(p => p.ProductID === rule.ProductB);
        
        if (!productA || !productB) return false;
        
        // Search filter
        if (searchTerm) {
          const searchMatch = 
            productA.ProductName.toLowerCase().includes(searchTerm) ||
            productB.ProductName.toLowerCase().includes(searchTerm) ||
            productA.CompanyName.toLowerCase().includes(searchTerm) ||
            productB.CompanyName.toLowerCase().includes(searchTerm);
          if (!searchMatch) return false;
        }
        
        // Industry filter
        if (selectedIndustry) {
          const industriesA = productA.Industries || [];
          const industriesB = productB.Industries || [];
          const industryMatch = 
            industriesA.some(ind => ind.toLowerCase() === selectedIndustry.toLowerCase()) ||
            industriesB.some(ind => ind.toLowerCase() === selectedIndustry.toLowerCase());
          if (!industryMatch && !industriesA.includes('all') && !industriesB.includes('all')) return false;
        }
        
        // Brand filter
        if (selectedBrand) {
          if (productA.CompanyName !== selectedBrand && productB.CompanyName !== selectedBrand) {
            return false;
          }
        }
        
        // Client Size filter - check if products match the selected size
        // Note: This is a simplified check. You may need to enhance based on your data structure
        if (selectedSize) {
          // This would need to check product.TargetClientSize if available
          // For now, we'll skip this filter or implement based on your data
        }
        
        return true;
      });
      
      // Helper function to get data source priority (lower number = higher priority)
      function getDataSourcePriority(dataSource) {
        if (!dataSource) return 4; // Default to lowest priority
        const ds = String(dataSource).toLowerCase().trim();
        // Priority 1: "real,expert" or "real and expert"
        if (ds.includes('real') && ds.includes('expert')) {
          return 1;
        }
        // Priority 2: "real" only (not containing "expert")
        if (ds.includes('real') && !ds.includes('expert')) {
          return 2;
        }
        // Priority 3: "expert" only (not containing "real")
        if (ds.includes('expert') && !ds.includes('real')) {
          return 3;
        }
        // Priority 4: "inferred" or "ai-inferred"
        if (ds.includes('inferred')) {
          return 4;
        }
        // Default priority for other data sources
        return 4;
      }
      
      // Sort - default to client count high to low
      const activeSortBy = sortBy || 'clientcount-desc';
      
      if (activeSortBy === 'clientcount-desc') {
        filteredRules.sort((a, b) => {
          // Sort purely by clientCount descending (high to low)
          const countA = parseInt(a.ClientCount || a.clientCount || 0);
          const countB = parseInt(b.ClientCount || b.clientCount || 0);
          return countB - countA; // High to low
        });
      } else if (activeSortBy === 'clientcount-asc') {
        filteredRules.sort((a, b) => {
          // Sort purely by clientCount ascending (low to high)
          const countA = parseInt(a.ClientCount || a.clientCount || 0);
          const countB = parseInt(b.ClientCount || b.clientCount || 0);
          return countA - countB; // Low to high
        });
      } else if (activeSortBy === 'productname-asc') {
        filteredRules.sort((a, b) => {
          const productA_a = allProducts.find(p => p.ProductID === a.ProductA);
          const productA_b = allProducts.find(p => p.ProductID === b.ProductA);
          const nameA = productA_a ? (productA_a.ProductName || '').toLowerCase() : '';
          const nameB = productA_b ? (productA_b.ProductName || '').toLowerCase() : '';
          return nameA.localeCompare(nameB);
        });
      } else if (activeSortBy === 'productname-desc') {
        filteredRules.sort((a, b) => {
          const productA_a = allProducts.find(p => p.ProductID === a.ProductA);
          const productA_b = allProducts.find(p => p.ProductID === b.ProductA);
          const nameA = productA_a ? (productA_a.ProductName || '').toLowerCase() : '';
          const nameB = productA_b ? (productA_b.ProductName || '').toLowerCase() : '';
          return nameB.localeCompare(nameA);
        });
      } else if (activeSortBy === 'companyname-asc') {
        filteredRules.sort((a, b) => {
          const productA_a = allProducts.find(p => p.ProductID === a.ProductA);
          const productA_b = allProducts.find(p => p.ProductID === b.ProductA);
          const nameA = productA_a ? (productA_a.CompanyName || '').toLowerCase() : '';
          const nameB = productA_b ? (productA_b.CompanyName || '').toLowerCase() : '';
          return nameA.localeCompare(nameB);
        });
      } else if (activeSortBy === 'companyname-desc') {
        filteredRules.sort((a, b) => {
          const productA_a = allProducts.find(p => p.ProductID === a.ProductA);
          const productA_b = allProducts.find(p => p.ProductID === b.ProductA);
          const nameA = productA_a ? (productA_a.CompanyName || '').toLowerCase() : '';
          const nameB = productA_b ? (productA_b.CompanyName || '').toLowerCase() : '';
          return nameB.localeCompare(nameA);
        });
      }
      
      // Render filtered rules
      renderHistoryRules(filteredRules);
    }
    
    // Submit Update Form
    function updateFormFields() {
      const type = document.getElementById('updateType').value;
      const action = document.getElementById('updateAction').value;
      const container = document.getElementById('dynamicFields');
      
      if (!type || type === 'Other') {
        container.innerHTML = '';
        return;
      }
      
      let html = '';
      
      if (action === 'Update' || action === 'Delete') {
        html += `
          <div class="form-group">
            <label>Company</label>
            <select id="dynCompany" onchange="populateProductDropdown()">
              <option value="">Select company...</option>
              ${[...new Set(allProducts.map(p => p.CompanyName))].sort().map(c => `<option value="${c}">${c}</option>`).join('')}
            </select>
          </div>
        `;
        
        if (type === 'Product') {
          html += `
            <div class="form-group">
              <label>Product Name</label>
              <select id="dynProduct">
                <option value="">Select company first...</option>
              </select>
            </div>
          `;
        }
      } else if (action === 'Add') {
        html += `
          <div class="form-group">
            <label>Company Name</label>
            <input type="text" id="dynCompany" placeholder="Enter company name">
          </div>
        `;
        
        if (type === 'Product') {
          html += `
            <div class="form-group">
              <label>Product Name</label>
              <input type="text" id="dynProduct" placeholder="Enter product name">
            </div>
          `;
        }
      }
      
      container.innerHTML = html;
    }
    
    function populateProductDropdown() {
      const companySelect = document.getElementById('dynCompany');
      const productSelect = document.getElementById('dynProduct');
      
      if (!companySelect || !productSelect) return;
      
      const selectedCompany = companySelect.value;
      
      if (!selectedCompany) {
        productSelect.innerHTML = '<option value="">Select company first...</option>';
        return;
      }
      
      const companyProducts = allProducts.filter(p => p.CompanyName === selectedCompany);
      
      productSelect.innerHTML = '<option value="">Select product...</option>' +
        companyProducts.map(p => `<option value="${p.ProductName}">${p.ProductName}</option>`).join('');
    }
    
    function submitUpdateRequest() {
      const data = {
        submitterName: document.getElementById('submitterName').value.trim(),
        submitterEmail: document.getElementById('submitterEmail').value.trim(),
        updateType: document.getElementById('updateType').value,
        updateAction: document.getElementById('updateAction').value,
        description: document.getElementById('updateDescription').value.trim(),
        justification: document.getElementById('updateJustification').value.trim(),
        additionalFields: {}
      };
      
      if (!data.submitterName || !data.submitterEmail || !data.updateType || !data.updateAction || !data.description) {
        alert('Please fill in all required fields');
        return;
      }
      
      // Track form submission
      trackEvent('form_submit', { 
        formType: 'update_request',
        updateType: data.updateType,
        updateAction: data.updateAction,
        page: 'submit'
      });
      
      const successDiv = document.getElementById('submitSuccess');
      successDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p style="color: rgba(55, 65, 81, 0.85);">Submitting...</p></div>';
      successDiv.classList.remove('hidden');
      
      google.script.run
        .withSuccessHandler(function(result) {
          successDiv.innerHTML = `
            <div style="background: var(--success); color: white; padding: 30px; border-radius: 20px; text-align: center; margin-top: 25px; box-shadow: 0 8px 24px rgba(16, 185, 129, 0.3);">
              <h3 style="font-size: 1.6em; margin-bottom: 12px;">Request Submitted!</h3>
              <p style="font-size: 1.05em;">Your update request has been submitted and will be reviewed by an administrator.</p>
              <p style="margin-top: 18px; font-size: 1.05em;"><strong>Request ID:</strong> ${result.requestId}</p>
            </div>
          `;
          
          document.getElementById('submitterName').value = '';
          document.getElementById('submitterEmail').value = '';
          document.getElementById('updateType').value = '';
          document.getElementById('updateAction').value = '';
          document.getElementById('updateDescription').value = '';
          document.getElementById('updateJustification').value = '';
          document.getElementById('dynamicFields').innerHTML = '';
          
          setTimeout(() => successDiv.classList.add('hidden'), 5000);
        })
        .withFailureHandler(function(error) {
          successDiv.innerHTML = `
            <div style="background: var(--danger); color: white; padding: 30px; border-radius: 20px; text-align: center; margin-top: 25px; box-shadow: 0 8px 24px rgba(239, 68, 68, 0.3);">
              <h3 style="font-size: 1.6em; margin-bottom: 12px;">Submission Failed</h3>
              <p style="font-size: 1.05em;">${error.message}</p>
            </div>
          `;
        })
        .submitUpdateRequest(data);
    }
    
    // ============================================
    // EXPORT TO SLIDES FUNCTIONALITY
    // ============================================
    
    function openExportModal(context) {
      var modal = document.getElementById('exportModal');
      var includeOverview = document.getElementById('includeOverview');
      var includeProducts = document.getElementById('includeProducts');
      var includeOpportunities = document.getElementById('includeOpportunities');
      var opportunitiesSection = document.getElementById('opportunitiesSection');
      
      // Set defaults based on context
      if (context === 'about') {
        // From About Us page: default to including overview, ask about products
        includeOverview.checked = true;
        includeProducts.checked = false;
        includeOpportunities.checked = false;
        // Hide opportunities section for About Us
        if (opportunitiesSection) {
          opportunitiesSection.style.display = 'none';
        }
      } else if (context === 'knowledge') {
        // From Knowledge Base: default to including products, ask about overview
        includeOverview.checked = false;
        includeProducts.checked = true;
        includeOpportunities.checked = false;
        // Hide opportunities section for Knowledge Base
        if (opportunitiesSection) {
          opportunitiesSection.style.display = 'none';
        }
      } else if (context === 'navigator') {
        // From Navigator/Cross-Sell Finder: show opportunities option
        includeOverview.checked = false;
        includeProducts.checked = false;
        includeOpportunities.checked = true;
        // Show opportunities section for Navigator
        if (opportunitiesSection) {
          opportunitiesSection.style.display = 'block';
        }
      } else {
        // Default: both unchecked
        includeOverview.checked = false;
        includeProducts.checked = false;
        includeOpportunities.checked = false;
        // Hide opportunities section by default
        if (opportunitiesSection) {
          opportunitiesSection.style.display = 'none';
        }
      }
      
      modal.classList.add('active');
      document.getElementById('exportStatus').style.display = 'none';
      
      // Initialize company selection and update dropdown visibility
      initializeCompanySelection();
    }
    
    function closeExportModal() {
      document.getElementById('exportModal').classList.remove('active');
      // Reset dropdown state
      var dropdown = document.getElementById('companySelectionDropdown');
      if (dropdown) {
        dropdown.classList.remove('show');
        dropdown.style.display = 'none';
      }
      isCompanyDropdownExpanded = false;
      // Reset summary text
      var summary = document.getElementById('companySelectionSummary');
      if (summary) {
        summary.textContent = 'Companies to include ▾';
      }
    }
    
    // Initialize company selection functionality
    var exportModalCompanies = [];
    var isCompanyDropdownExpanded = false;
    
    // Named functions for event listeners (to allow removal before re-adding)
    function handleIncludeProductsChange() {
      updateCompanySectionState(this.checked);
    }
    
    function handleCompanyToggleClick(e) {
      // Don't toggle if disabled
      var section = document.getElementById('companySelectionSection');
      if (section && section.classList.contains('disabled')) {
        return;
      }
      toggleCompanyDropdown();
    }
    
    function handleSelectAllChange() {
      toggleSelectAllCompanies(this.checked);
    }
    
    function initializeCompanySelection() {
      // Remove old listeners before adding new ones (prevents duplicates)
      var includeProducts = document.getElementById('includeProducts');
      if (includeProducts) {
        includeProducts.removeEventListener('change', handleIncludeProductsChange);
        includeProducts.addEventListener('change', handleIncludeProductsChange);
        // Initialize state on load
        updateCompanySectionState(includeProducts.checked);
      }
      
      // Click handler for collapsed row
      var companyToggle = document.getElementById('companySelectionToggle');
      if (companyToggle) {
        companyToggle.removeEventListener('click', handleCompanyToggleClick);
        companyToggle.addEventListener('click', handleCompanyToggleClick);
      }
      
      var selectAllCompanies = document.getElementById('selectAllCompanies');
      if (selectAllCompanies) {
        selectAllCompanies.removeEventListener('change', handleSelectAllChange);
        selectAllCompanies.addEventListener('change', handleSelectAllChange);
      }
      
      // Fetch companies when modal is opened
      fetchExportCompanies();
    }
    
    function updateCompanySectionState(enabled) {
      var section = document.getElementById('companySelectionSection');
      if (section) {
        if (enabled) {
          section.classList.remove('disabled');
        } else {
          section.classList.add('disabled');
          // Collapse dropdown if disabled
          if (isCompanyDropdownExpanded) {
            toggleCompanyDropdown();
          }
        }
      }
    }
    
    function fetchExportCompanies() {
      google.script.run
        .withSuccessHandler(function(companies) {
          exportModalCompanies = companies;
          populateCompanyCheckboxes();
          updateCompanySelectionSummary();
        })
        .withFailureHandler(function(error) {
          console.error('Error fetching companies:', error);
          exportModalCompanies = [];
        })
        .getCompanies();
    }
    
    function populateCompanyCheckboxes() {
      var container = document.getElementById('companyCheckboxesContainer');
      if (!container) return;
      
      container.innerHTML = '';
      
      if (exportModalCompanies.length === 0) {
        container.innerHTML = '<div style="padding: 8px; color: rgba(107, 114, 128, 0.7); font-size: 0.85em;">No companies found</div>';
        return;
      }
      
      // Sort companies by name
      var sortedCompanies = exportModalCompanies.slice().sort(function(a, b) {
        var nameA = (a.CompanyName || '').toLowerCase();
        var nameB = (b.CompanyName || '').toLowerCase();
        return nameA.localeCompare(nameB);
      });
      
      sortedCompanies.forEach(function(company) {
        var companyName = company.CompanyName || 'Unknown Company';
        var checkboxId = 'companyCheckbox_' + companyName.replace(/\s+/g, '_');
        
        var label = document.createElement('label');
        label.style.cssText = 'display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px; border-radius: 6px; transition: all 0.2s ease;';
        
        var checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = checkboxId;
        checkbox.value = companyName;
        checkbox.style.cssText = 'width: auto; margin: 0; width: 18px; height: 18px; cursor: pointer;';
        checkbox.addEventListener('change', function() {
          updateSelectAllState();
          updateCompanySelectionSummary();
        });
        
        var span = document.createElement('span');
        span.textContent = companyName;
        span.style.cssText = 'font-size: 0.9em; color: rgba(31, 41, 55, 0.85);';
        
        label.appendChild(checkbox);
        label.appendChild(span);
        container.appendChild(label);
      });
    }
    
    function toggleCompanyDropdown() {
      var dropdown = document.getElementById('companySelectionDropdown');
      var summary = document.getElementById('companySelectionSummary');
      if (!dropdown || !summary) return;
      
      isCompanyDropdownExpanded = !isCompanyDropdownExpanded;
      
      if (isCompanyDropdownExpanded) {
        dropdown.style.display = 'block';
        // Trigger animation by adding class after display change
        setTimeout(function() {
          dropdown.classList.add('show');
        }, 10);
        // Update summary text with arrow
        updateCompanySelectionSummary();
      } else {
        dropdown.classList.remove('show');
        // Update summary text and arrow
        updateCompanySelectionSummary();
        // Hide after animation completes
        setTimeout(function() {
          dropdown.style.display = 'none';
        }, 300);
      }
    }
    
    function updateCompanySelectionSummary() {
      var summary = document.getElementById('companySelectionSummary');
      if (!summary) return;
      
      var selectedCompanies = getSelectedCompanies();
      var totalCompanies = exportModalCompanies.length;
      var arrow = isCompanyDropdownExpanded ? '▴' : '▾';
      
      if (selectedCompanies.length === 0) {
        summary.textContent = 'Companies to include ' + arrow;
      } else if (selectedCompanies.length === totalCompanies) {
        summary.textContent = 'Companies to include: (All) ' + arrow;
      } else {
        summary.textContent = 'Companies to include: (' + selectedCompanies.length + ' selected) ' + arrow;
      }
    }
    
    function toggleSelectAllCompanies(checked) {
      var checkboxes = document.querySelectorAll('#companyCheckboxesContainer input[type="checkbox"]');
      checkboxes.forEach(function(checkbox) {
        checkbox.checked = checked;
      });
      updateCompanySelectionSummary();
    }
    
    function updateSelectAllState() {
      var checkboxes = document.querySelectorAll('#companyCheckboxesContainer input[type="checkbox"]');
      var selectAll = document.getElementById('selectAllCompanies');
      if (!selectAll || checkboxes.length === 0) return;
      
      var checkedCount = 0;
      checkboxes.forEach(function(checkbox) {
        if (checkbox.checked) checkedCount++;
      });
      
      // Update select all checkbox state
      if (checkedCount === 0) {
        selectAll.checked = false;
        selectAll.indeterminate = false;
      } else if (checkedCount === checkboxes.length) {
        selectAll.checked = true;
        selectAll.indeterminate = false;
      } else {
        selectAll.checked = false;
        selectAll.indeterminate = true;
      }
    }
    
    function getSelectedCompanies() {
      var checkboxes = document.querySelectorAll('#companyCheckboxesContainer input[type="checkbox"]:checked');
      var selected = [];
      checkboxes.forEach(function(checkbox) {
        selected.push(checkbox.value);
      });
      return selected;
    }
    
    function generateSlides() {
      var includeOverview = document.getElementById('includeOverview').checked;
      var includeProducts = document.getElementById('includeProducts').checked;
      var includeOpportunities = document.getElementById('includeOpportunities').checked;
      
      if (!includeOverview && !includeProducts && !includeOpportunities) {
        alert('Please select at least one option');
        return;
      }
      
      // Validate that at least one company is selected if Product Library is checked
      if (includeProducts) {
        var selectedCompanies = getSelectedCompanies();
        if (selectedCompanies.length === 0) {
          alert('Please select at least one company to include in Product Catalogue');
          return;
        }
      }
      
      // Check if opportunities exist when requested
      if (includeOpportunities && (!currentOpportunities || currentOpportunities.length === 0)) {
        alert('No opportunities found. Please search for opportunities first using the Navigator tab.');
        return;
      }
      
      // Track export event
      var selectedCompanies = includeProducts ? getSelectedCompanies() : [];
      trackEvent('export_slides', { 
        includeOverview: includeOverview,
        includeProducts: includeProducts,
        includeOpportunities: includeOpportunities,
        productCount: includeProducts ? selectedCompanies.length : 0,
        opportunitiesCount: includeOpportunities ? (currentOpportunities ? currentOpportunities.length : 0) : 0,
        companies: selectedCompanies.join(','),
        exportType: 'presentation',
        page: currentPage
      });
      
      var statusDiv = document.getElementById('exportStatus');
      statusDiv.style.display = 'block';
      statusDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p style="color: rgba(55, 65, 81, 0.85);">Generating presentation... This may take a minute.</p></div>';
      
      var exportOptions = {
        includeOverview: includeOverview,
        includeProducts: includeProducts,
        includeOpportunities: includeOpportunities,
        opportunities: includeOpportunities ? currentOpportunities : null,
        currentProducts: includeOpportunities ? selectedProducts : null // Pass selected products for opportunity slides
      };
      
      // Add selected companies if Product Library is included
      if (includeProducts) {
        exportOptions.selectedCompanies = selectedCompanies;
      }
      
      google.script.run
        .withSuccessHandler(function(result) {
          statusDiv.innerHTML = `
            <div style="background: var(--success); color: white; padding: 20px; border-radius: 12px; text-align: center;">
              <h4 style="margin-bottom: 10px;">✓ Presentation Created!</h4>
              <a href="${result.url}" target="_blank" style="color: white; text-decoration: underline; font-weight: 600; font-size: 1.1em;">
                Open Presentation →
              </a>
              <p style="margin-top: 10px; font-size: 0.9em; opacity: 0.9;">The presentation has been saved to your Google Drive</p>
            </div>
          `;
        })
        .withFailureHandler(function(error) {
          statusDiv.innerHTML = `
            <div style="background: var(--danger); color: white; padding: 20px; border-radius: 12px; text-align: center;">
              <h4 style="margin-bottom: 10px;">✗ Error Creating Presentation</h4>
              <p>${error.message || 'An unexpected error occurred. Please try again.'}</p>
            </div>
          `;
        })
        .exportToSlides(exportOptions);
    }
    
    // Expose tracking functions to global scope for console access
    window.setDeveloperMode = setDeveloperMode;
    window.trackEvent = trackEvent;
    window.getOrCreateSessionId = getOrCreateSessionId;
    
    // Log that tracking is ready
    console.log('✅ Tracking system loaded. Run setDeveloperMode(true) to enable developer mode.');
  </script>
  
  <!-- Export to Slides Modal -->
  <div id="exportModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <div class="modal-title-section">
          <div class="modal-title">Export to Slides</div>
          <div class="modal-subtitle">Choose what to include in your presentation</div>
        </div>
        <button class="modal-close" onclick="closeExportModal()">×</button>
      </div>
      <div class="modal-body">
        <div style="margin-bottom: 24px;">
          <p style="color: rgba(107, 114, 128, 0.8); line-height: 1.6; margin-bottom: 20px;">
            Select the content you'd like to export. A new Google Slides presentation will be created in your Drive.
          </p>
        </div>
        
        <div class="form-group" style="margin-bottom: 16px;">
          <label style="display: flex; align-items: center; gap: 12px; cursor: pointer; padding: 14px; background: rgba(249, 250, 251, 0.5); border-radius: 10px; border: 2px solid rgba(229, 231, 235, 0.6); transition: all 0.2s ease;">
            <input type="checkbox" id="includeOverview" style="width: auto; margin: 0; width: 20px; height: 20px; cursor: pointer;">
            <div>
              <div style="font-weight: 600; color: rgba(31, 41, 55, 0.85); margin-bottom: 4px;">Company Overviews</div>
              <div style="font-size: 0.85em; color: rgba(107, 114, 128, 0.7);">About Us page content with company information and videos</div>
            </div>
          </label>
        </div>
        
        <div class="form-group">
          <label style="display: flex; align-items: center; gap: 12px; cursor: pointer; padding: 14px; background: rgba(249, 250, 251, 0.5); border-radius: 10px; border: 2px solid rgba(229, 231, 235, 0.6); transition: all 0.2s ease;">
            <input type="checkbox" id="includeProducts" style="width: auto; margin: 0; width: 20px; height: 20px; cursor: pointer;">
            <div>
              <div style="font-weight: 600; color: rgba(31, 41, 55, 0.85); margin-bottom: 4px;">Product Catalogue</div>
              <div style="font-size: 0.85em; color: rgba(107, 114, 128, 0.7);">Complete product catalogue with descriptions</div>
            </div>
          </label>
          
          <!-- Company Selection Section - Always Visible -->
          <div id="companySelectionSection" class="company-selection-section" style="margin-top: 12px;">
            <!-- Collapsed Row - Clickable -->
            <div id="companySelectionToggle" class="company-selection-toggle" style="display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; background: rgba(249, 250, 251, 0.5); border-radius: 8px; border: 1px solid rgba(229, 231, 235, 0.6); cursor: pointer; transition: all 0.2s ease; user-select: none;">
              <span id="companySelectionSummary" style="font-size: 0.9em; color: rgba(31, 41, 55, 0.85); font-weight: 500;">Companies to include ▾</span>
            </div>
            
            <!-- Expanded Dropdown -->
            <div id="companySelectionDropdown" class="company-selection-dropdown" style="display: none; overflow: hidden; margin-top: 8px; padding: 12px; background: rgba(249, 250, 251, 0.5); border-radius: 8px; border: 1px solid rgba(229, 231, 235, 0.6);">
              <!-- Select All -->
              <div style="margin-bottom: 12px; padding-left: 4px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px; border-radius: 6px; transition: all 0.2s ease;">
                  <input type="checkbox" id="selectAllCompanies" style="width: auto; margin: 0; width: 18px; height: 18px; cursor: pointer;">
                  <span style="font-weight: 600; color: rgba(31, 41, 55, 0.85); font-size: 0.9em;">Select All</span>
                </label>
              </div>
              
              <!-- Company Checkboxes - 2 Columns × 5 Rows -->
              <div id="companyCheckboxesContainer" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; max-height: 300px; overflow-y: auto; padding-right: 4px; padding-left: 4px;">
                <!-- Company checkboxes will be populated dynamically -->
              </div>
            </div>
          </div>
        </div>
        
        <div class="form-group" style="margin-bottom: 16px; display: none;" id="opportunitiesSection">
          <label style="display: flex; align-items: center; gap: 12px; cursor: pointer; padding: 14px; background: rgba(249, 250, 251, 0.5); border-radius: 10px; border: 2px solid rgba(229, 231, 235, 0.6); transition: all 0.2s ease;">
            <input type="checkbox" id="includeOpportunities" style="width: auto; margin: 0; width: 20px; height: 20px; cursor: pointer;">
            <div>
              <div style="font-weight: 600; color: rgba(31, 41, 55, 0.85); margin-bottom: 4px;">Top Opportunities</div>
              <div style="font-size: 0.85em; color: rgba(107, 114, 128, 0.7);">Export the top cross-sell opportunities from your current search</div>
            </div>
          </label>
        </div>
        
        <div style="background: rgba(219, 234, 254, 0.5); backdrop-filter: blur(15px); padding: 14px; border-radius: 10px; margin-top: 20px; border: 1px solid rgba(59, 130, 246, 0.2);">
          <div style="display: flex; gap: 10px; align-items: start;">
            <div style="font-size: 1.2em;">💡</div>
            <div style="font-size: 0.85em; color: #1e40af; line-height: 1.5;">
              <strong>Tip:</strong> Select both options for a complete overview presentation. The product catalogue can be quite large depending on your catalogue size.
            </div>
          </div>
        </div>
        
        <div id="exportStatus" style="margin-top: 20px; display: none;"></div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary-action" onclick="closeExportModal()">Cancel</button>
        <button class="btn btn-primary-action" onclick="generateSlides()">
          Generate Slides!
        </button>
      </div>
    </div>
  </div>
  
  <style>
  /* Enhanced checkbox styling for export modal */
  #exportModal input[type="checkbox"] {
    accent-color: var(--primary);
  }
  
  #exportModal label:hover {
    border-color: var(--primary) !important;
    background: rgba(255, 255, 255, 0.7) !important;
  }
  
  #exportModal input[type="checkbox"]:checked + div {
    color: var(--primary);
  }
  
  /* Company Selection Section */
  .company-selection-section {
    transition: opacity 0.2s ease;
  }
  
  .company-selection-section.disabled {
    opacity: 0.5;
    pointer-events: none;
  }
  
  .company-selection-toggle {
    transition: all 0.2s ease;
  }
  
  .company-selection-toggle:hover:not(.disabled) {
    background: rgba(249, 250, 251, 0.8) !important;
    border-color: var(--primary) !important;
  }
  
  .company-selection-dropdown {
    max-height: 0;
    opacity: 0;
    transform: translateY(-10px);
    transition: max-height 0.3s ease-out, opacity 0.3s ease-out, transform 0.3s ease-out, display 0s 0.3s;
    overflow: hidden;
  }
  
  .company-selection-dropdown.show {
    max-height: 500px;
    opacity: 1;
    transform: translateY(0);
    transition: max-height 0.3s ease-out, opacity 0.3s ease-out, transform 0.3s ease-out;
  }
  
  /* Company checkbox styling */
  #companyCheckboxesContainer label {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    padding: 8px;
    border-radius: 6px;
    transition: all 0.2s ease;
  }
  
  #companyCheckboxesContainer label:hover {
    background: rgba(249, 250, 251, 0.8);
  }
  
  #companyCheckboxesContainer input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
    accent-color: var(--primary);
  }
  
  #companyCheckboxesContainer span {
    font-size: 0.9em;
    color: rgba(31, 41, 55, 0.85);
  }
  
  /* Select All checkbox hover */
  #selectAllCompanies + span:hover {
    color: var(--primary);
  }
  </style>
  
</body>
</html>
